<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8">

    {% include utility/calculate-variables.html %}

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <!-- IndieAuth and WebMentions Metadata -->
    {% include seo/indieauth-webmentions-metadata.html %}

    <!-- SEO Metadata -->
    {% include seo/meta-data-seo.html %}

    <!-- PWA Header Includes -->
    {% include pwa/pwa-header-includes.html %}

    <!-- News Feed Meta Tags -->
    {% include feeds/feeds.html %}

    <!-- START OF CSS INCLUDE -->
    {% include assets/all-css-includes.html %}
    <!-- END OF CSS INCLUDE -->

    <link rel="stylesheet" type="text/css" href="{{ '/css/main-landing-page.css' | relative_url }}">

    <style>
      h1, .h1 { 
        font-family: "Sofia Sans Extra Condensed", "Optima", "ManukaCondensed", "Manuka", "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-weight: 600;
        letter-spacing: -3px;
        font-size: 60px;
        font-stretch: extra-condensed;
      }
      a { 
        text-decoration: underline;
        text-decoration-thickness: 1px;
      }
      a:hover, a:focus { 
        text-decoration: underline;
        text-decoration-thickness: 3px;
      }
    </style>

    <!-- Scripts that need to be at the end of the header -->
    {% include assets/scripts.html %}

    {% include utility/theme-debug-style.html %}
  </head>
  <body style="scroll-padding-top: 70px;" data-bs-spy="scroll" data-bs-target="#navbarNavDarkDropdown" data-bs-offset="70">

    {% include layout/top-nav-bar.html %}

    <main class="homepage--3d-stack">
      <!-- 3D Hero Image -->
      <div class="stack-hero">
        {% include homepage/hero-random.html %}
      </div>

      <!-- Stack Instructions & Title -->
      <div class="stack-container">
        <div style="text-align: center; margin-bottom: 3rem;">
          <h1>Discover & Explore</h1>
          <p class="lead">Cards rotate to reveal latest posts and category highlights. Use arrow buttons or keyboard to navigate.</p>
        </div>

        <!-- Stack Controls -->
        <div class="stack-controls">
          <button class="stack-button" data-direction="prev">‚Üê Previous</button>
          <button class="stack-button" data-direction="next">Next ‚Üí</button>
        </div>

        <!-- 3D Card Stack -->
        <div class="card-stack">
          {%- assign registry = site.data.category_registry -%}
          {%- assign stack_items = '' | split: '' -%}

          <!-- Collect posts -->
          {%- assign _blog_candidates = site.config.recent_by_category.blog | default: site.posts | safe_sort: 'date' | reverse -%}
          {%- assign item_count = 0 -%}

          {%- for post in _blog_candidates limit: 12 -%}
            {%- if post.categories contains "Bestiary" or post.categories contains "Draft" or post.categories contains "Role Playing Games" or post.categories contains "Folklore" or post.categories contains "Quotes" or post.categories contains "Home" or post.layout contains "micropubpost" or post.layout contains "gammaworld" or post.categories contains "Prompts" or post.layout contains "prompt" or post.path contains "_posts/Prompts/" -%}{%- continue -%}{%- endif -%}

            {%- assign composite = 'post||' | append: post.url | append: '||' | append: post.date | append: '||' | append: post.title -%}
            {%- assign stack_items = stack_items | push: composite -%}
            {%- assign item_count = item_count | plus: 1 -%}
          {%- endfor -%}

          <!-- Add some featured categories -->
          {%- assign cat_items = '' | split: '' -%}
          {%- for pair in registry -%}
            {%- assign slug = pair[0] | to_s | strip -%}
            {%- assign entry = pair[1] -%}
            {%- if slug == '' or entry.hide_from_carousel == true or entry.hide_from_carousel == 'true' -%}{%- continue -%}{%- endif -%}
            {%- assign has_posts = false -%}
            {%- assign _cached_recent = site.config.recent_by_category[slug] -%}
            {%- if _cached_recent != nil -%}
              {%- assign has_posts = true -%}
            {%- endif -%}
            {%- if has_posts -%}
              {%- assign title_for_sort = entry.label | default: entry.title | default: slug -%}
              {%- assign composite_cat = 'category||' | append: slug | append: '||' | append: title_for_sort | append: '||' | append: title_for_sort -%}
              {%- assign cat_items = cat_items | push: composite_cat -%}
            {%- endif -%}
          {%- endfor -%}

          {%- assign cat_items = cat_items | safe_sort | sort_natural | slice: 0, 4 -%}
          {%- for composite_cat in cat_items -%}
            {%- assign stack_items = stack_items | push: composite_cat -%}
          {%- endfor -%}

          <!-- Render stack cards -->
          {%- for composite in stack_items -%}
            {%- assign parts = composite | split: '||' -%}
            {%- assign type = parts[0] -%}

            {%- if type == 'post' -%}
              {%- assign post_url = parts[1] -%}
              {%- assign post_date = parts[2] -%}
              {%- assign post_title = parts[3] -%}
              {%- assign post_obj = nil -%}

              {%- for p in site.posts -%}
                {%- if p.url == post_url -%}
                  {%- assign post_obj = p -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}

              {%- if post_obj -%}
                <div class="stack-card">
                  <div class="card-title">{{ post_obj.title }}</div>
                  <div class="card-subtitle">{{ post_obj.date | date: "%B %d, %Y" }}</div>
                  <div class="card-content">
                    {%- assign __summary = post_obj.teaser | default: post_obj.description | default: post_obj.excerpt -%}
                    {%- if __summary == nil or __summary == '' -%}
                      {%- assign __summary = post_obj.content | strip_html | truncate: 300 -%}
                    {%- endif -%}
                    {{ __summary | strip_html }}
                  </div>
                  <div class="card-meta">
                    <a href="{{ post_obj.url | absolute_url }}" style="color: #00446f;">Read Full Article ‚Üí</a>
                  </div>
                </div>
              {%- endif -%}

            {%- elsif type == 'category' -%}
              {%- assign slug = parts[1] -%}
              {%- assign entry = registry[slug] -%}

              {%- if entry.category_home_page -%}
                {%- assign category_href = entry.category_home_page -%}
              {%- else -%}
                {%- assign category_href = '/category/' | append: slug | append: '/' -%}
              {%- endif -%}

              {%- assign palette = entry.palette -%}
              {%- if palette -%}
                {%- assign start_color = palette.start | default: palette.gradient_start | default: '#f8f6f0' -%}
                {%- assign end_color = palette.end | default: palette.gradient_end | default: '#e8e6e0' -%}
                {%- assign accent_color = palette.accent | default: palette.titleColor | default: '#00446f' -%}
              {%- else -%}
                {%- assign start_color = '#f8f6f0' -%}
                {%- assign end_color = '#e8e6e0' -%}
                {%- assign accent_color = '#00446f' -%}
              {%- endif -%}

              <div class="stack-card is-category" style="--theme-gradient-start: {{ start_color }}; --theme-gradient-end: {{ end_color }}; --theme-accent: {{ accent_color }};">
                <div class="category-emoji">{{ entry.emoji | default: 'üìå' }}</div>
                <div class="card-title"><a href="{{ category_href }}" style="text-decoration: none; color: inherit;">{{ entry.label | default: entry.title | default: slug }}</a></div>
                <div class="card-subtitle">{{ entry.subtitle | default: 'Featured Category' }}</div>
                <div class="card-content">{{ entry.description }}</div>
                <div class="card-meta">
                  {%- assign _recent_cat_posts = site.config.recent_by_category[slug] | default: site.config.recent_by_category[entry.title] -%}
                  {%- if _recent_cat_posts == nil -%}
                    {%- assign _recent_cat_posts = site.posts | safe_sort: 'date' | reverse | slice: 0, 30 -%}
                  {%- endif -%}
                  {%- assign post_count = 0 -%}
                  {%- for post in _recent_cat_posts -%}
                    {%- if post.path contains '_posts/Prompts/' or post.layout contains 'prompt' or post.categories contains 'Prompts' -%}{%- continue -%}{%- endif -%}
                    {%- if post_count >= 2 -%}{%- break -%}{%- endif -%}
                    {%- assign matched = false -%}
                    {%- if post.categories contains entry.title or post.categories contains slug -%}{%- assign matched = true -%}{%- endif -%}
                    {%- if matched == false and entry.raw_names -%}
                      {%- for rn in entry.raw_names -%}
                        {%- if post.categories contains rn -%}{%- assign matched = true -%}{%- break -%}{%- endif -%}
                      {%- endfor -%}
                    {%- endif -%}
                    {%- if matched -%}
                      {%- assign post_count = post_count | plus: 1 -%}
                      {%- if post_count == 1 %}<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.85rem;">{% endif %}
                      <div style="margin: 0.4rem 0;">‚ñ∏ <a href="{{ post.url | absolute_url }}">{{ post.title }}</a></div>
                      {%- if post_count == 2 %}</div>{% endif %}
                    {%- endif -%}
                  {%- endfor -%}
                  <a href="{{ category_href }}" style="color: {{ accent_color }}; display: block; margin-top: 0.75rem;">Explore Category ‚Üí</a>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>

        <!-- Stack Info -->
        <div style="text-align: center; margin-top: 3rem; padding: 2rem; background: #f8f6f0; border-radius: 8px;">
          <p style="margin: 0; font-size: 0.9rem; color: #666;">üí° <strong>Tip:</strong> Use arrow buttons, keyboard arrows, or scroll to rotate through the stack</p>
        </div>
      </div>
    </main>

    {% include layout/footer.html %}
    {% include assets/end-of-body-assets.html %}
    <script src="{{ '/js/homepage-animations.js' | relative_url }}"></script>
  </body>
</html>
