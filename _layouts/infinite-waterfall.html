<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8">

    {% include utility/calculate-variables.html %}

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <!-- IndieAuth and WebMentions Metadata -->
    {% include seo/indieauth-webmentions-metadata.html %}

    <!-- SEO Metadata -->
    {% include seo/meta-data-seo.html %}

    <!-- PWA Header Includes -->
    {% include pwa/pwa-header-includes.html %}

    <!-- News Feed Meta Tags -->
    {% include feeds/feeds.html %}

    <!-- START OF CSS INCLUDE -->
    {% include assets/all-css-includes.html %}
    <!-- END OF CSS INCLUDE -->

    <link rel="stylesheet" type="text/css" href="{{ '/css/main-landing-page.css' | relative_url }}">

    <style>
      h1, .h1 { 
        font-family: "Sofia Sans Extra Condensed", "Optima", "ManukaCondensed", "Manuka", "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-weight: 600;
        letter-spacing: -3px;
        font-size: 60px;
        font-stretch: extra-condensed;
      }
      .page-header {
        text-align: center;
        padding: 2rem 1rem;
        background: linear-gradient(135deg, #f8f6f0 0%, #e8e6e0 100%);
        margin-bottom: 2rem;
      }
      [data-bs-theme="dark"] .page-header {
        background: linear-gradient(135deg, rgba(7, 9, 15, 0.7) 0%, rgba(7, 9, 15, 0.5) 100%);
      }
      a { 
        text-decoration: underline;
        text-decoration-thickness: 1px;
      }
      a:hover, a:focus { 
        text-decoration: underline;
        text-decoration-thickness: 3px;
      }
    </style>

    <!-- Scripts that need to be at the end of the header -->
    {% include assets/scripts.html %}

    {% include utility/theme-debug-style.html %}
  </head>
  <body style="scroll-padding-top: 70px;" data-bs-spy="scroll" data-bs-target="#navbarNavDarkDropdown" data-bs-offset="70">

    {% include layout/top-nav-bar.html %}

    <main class="homepage--waterfall">
      <!-- Page Header -->
      <div class="page-header">
        <h1>Discover Content</h1>
        <p class="lead">Explore articles, categories, and insights in a flowing masonry layout</p>
      </div>

      <!-- Waterfall Container -->
      <div class="waterfall-container">
        {%- assign registry = site.data.category_registry -%}
        {%- assign content_items = '' | split: '' -%}

        <!-- Collect blog posts -->
        {%- assign _blog_candidates = site.config.recent_by_category.blog | default: site.posts | safe_sort: 'date' | reverse -%}
        {%- for post in _blog_candidates limit: 12 -%}
          {%- if post.categories contains "Bestiary" or post.categories contains "Draft" or post.categories contains "Role Playing Games" or post.categories contains "Folklore" or post.categories contains "Quotes" or post.categories contains "Home" or post.layout contains "micropubpost" or post.layout contains "gammaworld" or post.categories contains "Prompts" or post.layout contains "prompt" or post.path contains "_posts/Prompts/" -%}{%- continue -%}{%- endif -%}

          {%- assign composite = 'post||' | append: post.url | append: '||' | append: post.date | append: '||' | append: post.title -%}
          {%- assign content_items = content_items | push: composite -%}
        {%- endfor -%}

        <!-- Collect recent category highlights -->
        {%- assign cat_items = '' | split: '' -%}
        {%- for pair in registry -%}
          {%- assign slug = pair[0] | to_s | strip -%}
          {%- assign entry = pair[1] -%}
          {%- if slug == '' or entry.hide_from_carousel == true or entry.hide_from_carousel == 'true' -%}{%- continue -%}{%- endif -%}
          {%- assign has_posts = false -%}
          {%- assign _fallback_recent = site.posts | safe_sort: 'date' | reverse | slice: 0, 60 -%}
          {%- assign _cached_recent = site.config.recent_by_category[slug] | default: site.config.recent_by_category[entry.title] -%}
          {%- assign _scan_set = _cached_recent | default: _fallback_recent -%}
          {%- for p in _scan_set -%}
            {%- if p.path contains '_posts/Prompts/' or p.layout contains 'prompt' or p.categories contains 'Prompts' -%}{%- continue -%}{%- endif -%}
            {%- assign matched = false -%}
            {%- if p.categories contains entry.title -%}{%- assign matched = true -%}{%- endif -%}
            {%- if matched == false and p.categories contains slug -%}{%- assign matched = true -%}{%- endif -%}
            {%- if matched == false and entry.raw_names -%}
              {%- for rn in entry.raw_names -%}
                {%- if p.categories contains rn -%}{%- assign matched = true -%}{%- break -%}{%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- if matched -%}{%- assign has_posts = true -%}{%- break -%}{%- endif -%}
          {%- endfor -%}
          {%- if has_posts -%}
            {%- assign title_for_sort = entry.label | default: entry.title | default: slug -%}
            {%- assign composite_cat = 'category||' | append: slug | append: '||' | append: title_for_sort | append: '||' | append: title_for_sort -%}
            {%- assign content_items = content_items | push: composite_cat -%}
          {%- endif -%}
        {%- endfor -%}

        <!-- Shuffle and render items -->
        {% assign registry = site.data.category_registry %}
        {% for composite in content_items %}
          {% assign parts = composite | split: '||' %}
          {% assign type = parts[0] %}

          {% if type == 'post' %}
            {% assign post_url = parts[1] %}
            {% assign post_date = parts[2] %}
            {% assign post_title = parts[3] %}
            {% assign post_obj = nil %}
            {% for p in site.posts %}
              {% if p.url == post_url %}
                {% assign post_obj = p %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if post_obj %}
              <div class="waterfall-card">
                {% if post_obj.image %}
                  {% assign image_alt = post_obj.image-alt | default: post_obj.image-description | default: post_obj.title %}
                  {% assign _image_raw = post_obj.image | strip %}
                  {% assign _image_first = _image_raw | slice: 0, 1 %}
                  {% assign _image_first2 = _image_raw | slice: 0, 2 %}
                  {% if _image_raw contains '://' or _image_first2 == '//' or _image_first == '/' %}
                    {% assign image_URL = _image_raw %}
                  {% else %}
                    {% assign image_URL = '/' | append: _image_raw %}
                  {% endif %}
                  <img src="{{ image_URL }}" alt="{{ image_alt }}" class="card-image" loading="lazy">
                {% endif %}
                <div class="card-content">
                  <h3 class="card-title"><a href="{{ post_obj.url | absolute_url }}">{{ post_obj.title }}</a></h3>
                  <p class="card-excerpt">
                    {% assign __summary = post_obj.teaser | default: post_obj.description | default: post_obj.excerpt %}
                    {% if __summary == nil or __summary == '' %}
                      {% assign __summary = post_obj.content | strip_html | truncate: 150 %}
                    {% endif %}
                    {{ __summary | strip_html }}
                  </p>
                  <p class="card-meta">{{ post_obj.date | date: "%B %d, %Y" }}</p>
                </div>
              </div>
            {% endif %}

          {% elsif type == 'category' %}
            {% assign slug = parts[1] %}
            {% assign entry = registry[slug] %}
            {% if entry.category_home_page %}
              {% assign category_href = entry.category_home_page %}
            {% else %}
              {% assign category_href = '/category/' | append: slug | append: '/' %}
            {% endif %}

            <div class="waterfall-card is-category">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div class="category-emoji">{{ entry.emoji | default: 'ðŸ“Œ' }}</div>
                  <h3 class="card-title"><a href="{{ category_href }}">{{ entry.label | default: entry.title | default: slug }}</a></h3>
                </div>
              </div>
              <p class="card-excerpt">{{ entry.description | default: entry.subtitle }}</p>
              <div class="recent-posts-list">
                {% assign _recent_cat_posts = site.config.recent_by_category[slug] | default: site.config.recent_by_category[entry.title] %}
                {% if _recent_cat_posts == nil %}
                  {% assign _recent_cat_posts = site.posts | safe_sort: 'date' | reverse | slice: 0, 30 %}
                {% endif %}
                {% assign post_count = 0 %}
                {% for post in _recent_cat_posts %}
                  {% if post.path contains '_posts/Prompts/' or post.layout contains 'prompt' or post.categories contains 'Prompts' %}{% continue %}{% endif %}
                  {% if post_count >= 3 %}{% break %}{% endif %}
                  {% assign matched = false %}
                  {% if post.categories contains entry.title %}{% assign matched = true %}{% endif %}
                  {% if matched == false and post.categories contains slug %}{% assign matched = true %}{% endif %}
                  {% if matched == false and entry.raw_names %}
                    {% for rn in entry.raw_names %}
                      {% if post.categories contains rn %}{% assign matched = true %}{% break %}{% endif %}
                    {% endfor %}
                  {% endif %}
                  {% if matched %}
                    {% assign post_count = post_count | plus: 1 %}
                    <div class="recent-post-item"><a href="{{ post.url | absolute_url }}">{{ post.title }}</a></div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </main>

    {% include layout/footer.html %}
    {% include assets/end-of-body-assets.html %}
    <script src="{{ '/js/homepage-animations.js' | relative_url }}"></script>
  </body>
</html>
