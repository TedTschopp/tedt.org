name: Mastodon Feed Publish

permissions:
  contents: write

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

jobs:
  toot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Decide if we should post (latest already tooted?)
        id: guard
        run: |
          python3 _code/should_post_latest.py > guard.json || true
          echo "Guard output:" && cat guard.json || true
          SHOULD=$(python3 -c "import json;print(json.load(open('guard.json')).get('should_post','false'))" || echo false)
          echo "should_post=$SHOULD" >> $GITHUB_OUTPUT
      - name: Pull latest (ensure cache freshness)
        run: git pull --ff-only || true
      - name: Normalize Mastodon cache
        run: echo "(Deprecated direct normalization step)"
      - name: Cache Prep
        id: cache-prep
        uses: ./.github/actions/masto-cache-prep
        with:
          write: 'false'
      - name: Post new items
        id: feed2mastodon
        if: steps.guard.outputs.should_post == 'true'
        uses: nhoizey/github-action-feed-to-mastodon@v2
        with:
          feedUrl: "https://tedt.org/feed-mastodon.json"
          mastodonInstance: "https://tschopp.net"
          mastodonToken: ${{ secrets.MASTODON_TOKEN }}
          ignoreFirstRun: ${{ steps.cache-prep.outputs.sync_candidates == '0' && 'true' || 'false' }}
          itemChoiceStrategy: newest
          globalDelayToots: 60
          delayTootsSameItem: 2880
      - name: Skip note
        if: steps.guard.outputs.should_post != 'true'
        run: |
          echo "Skipping feed-to-mastodon: latest post already has mastodon-post-id."
      - name: Resolve canonical path for toot
        if: steps.feed2mastodon.outputs.tootUrl
        uses: ./.github/actions/masto-update-frontmatter
        with:
          toot-url: ${{ steps.feed2mastodon.outputs.tootUrl }}
      - name: Commit and push cache & updated post
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update Mastodon cache & post front matter"
          file_pattern: cache/*.json _posts/**/*.md
      - name: Show toot URL
        if: steps.feed2mastodon.outputs.tootUrl
        run: |
          echo "Toot created: ${{ steps.feed2mastodon.outputs.tootUrl }}"

  scripts-test:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'schedule' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run script sanity tests
        run: python3 tests/_code/test_scripts.py