name: Feed to Mastodon

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  post-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Node dependencies
        run: |
          npm install --no-audit --no-fund

      - name: Clean Allure output (this run)
        if: always()
        run: |
          npm run allure:clean

      - name: Restore Allure history (trends)
        if: always()
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p tmp/allure-history

          echo "[allure] Looking for latest 'allure-report-mastodon-feed' artifact to restore history..."

            DOWNLOAD_URL="$(python3 -c 'import json, os, urllib.request; repo=os.environ["GITHUB_REPOSITORY"]; token=os.environ["GITHUB_TOKEN"]; url=f"https://api.github.com/repos/{repo}/actions/artifacts?per_page=100"; req=urllib.request.Request(url, headers={"Authorization": f"Bearer {token}", "Accept": "application/vnd.github+json", "User-Agent": "tedt.org-allure-history"}); data=json.load(urllib.request.urlopen(req)); arts=data.get("artifacts", []); matches=[a for a in arts if a.get("name")=="allure-report-mastodon-feed" and not a.get("expired", False)]; matches.sort(key=lambda a: a.get("created_at", ""), reverse=True); print(matches[0].get("archive_download_url", "") if matches else "")')"

          if [ -z "${DOWNLOAD_URL:-}" ]; then
            echo "[allure] No prior artifact found; skipping history restore."
            exit 0
          fi

          echo "[allure] Downloading artifact zip..."
          if ! curl -fsSL -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$DOWNLOAD_URL" \
            -o tmp/allure-history.zip; then
            echo "[allure] Failed to download prior artifact; skipping history restore."
            exit 0
          fi

          if ! unzip -q -o tmp/allure-history.zip -d tmp/allure-history; then
            echo "[allure] Failed to unzip prior artifact; skipping history restore."
            exit 0
          fi

          if [ -d "tmp/allure-history/reports/allure/latest/history" ]; then
            mkdir -p reports/allure/allure-results/history
            cp -R tmp/allure-history/reports/allure/latest/history/* reports/allure/allure-results/history/ || true
            echo "[allure] Restored history/ into allure-results/history."
          else
            echo "[allure] Artifact had no history directory; skipping."
          fi
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Decide if we should post
        id: guard
        run: |
          python3 _code/should_post_latest.py > guard.json || true
          echo "Guard output:" && cat guard.json || true
          SHOULD=$(python3 -c "import json;print(json.load(open('guard.json')).get('should_post','false'))" || echo false)
          echo "should_post=$SHOULD" >> $GITHUB_OUTPUT
      - name: Post new items
        if: steps.guard.outputs.should_post == 'true'
        uses: nhoizey/github-action-feed-to-mastodon@v2
        with:
          feedUrl: "https://tedt.org/feed-mastodon.json"
          mastodonInstance: "https://tschopp.net"
          mastodonToken: ${{ secrets.MASTODON_TOKEN }}
          ignoreFirstRun: false
          itemChoiceStrategy: newest
          globalDelayToots: 60
          delayTootsSameItem: 2880
      - name: Skip note
        if: steps.guard.outputs.should_post != 'true'
        run: |
          echo "Skipping: latest item already posted"
      - name: Commit mastodon cache/front matter (if changed)
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: update Mastodon cache/front matter"
          file_pattern: cache/*.json _posts/**/*.md

      - name: Capture GitHub Actions errors/warnings (Allure)
        if: always()
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p tmp/gha-logs
          mkdir -p reports/allure/allure-results
          echo "[diag] Downloading workflow run logs..."
          if curl -fsSL -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/logs" \
            -o tmp/gha-logs.zip; then
            if unzip -q -o tmp/gha-logs.zip -d tmp/gha-logs; then
              python3 reports/allure/github_actions_logs_to_allure.py \
                --logs-dir tmp/gha-logs \
                --output-dir reports/allure/allure-results \
                --run-url "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
              exit 0
            fi
          fi

          echo "[diag] Logs download/unzip failed; capturing diagnostics as Allure attachment."
          curl -sSL -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/logs" \
            -o tmp/gha-logs-error.txt || true

          python3 reports/allure/write_simple_allure_result.py \
            --output-dir reports/allure/allure-results \
            --name "GitHub Actions workflow diagnostics capture" \
            --suite "CI Diagnostics" \
            --sub-suite "GitHub Actions" \
            --status failed \
            --attach "logs download response=tmp/gha-logs-error.txt" \
            --run-url "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

      - name: Write Allure metadata (environment + executor)
        if: always()
        run: |
          python3 reports/allure/write_allure_metadata.py \
            --output-dir reports/allure/allure-results \
            --run-url "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

      - name: Generate Allure report (artifact)
        if: always()
        run: |
          npm run allure:generate

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: allure-report-mastodon-feed
          path: |
            reports/allure/latest
            reports/allure/allure-results
