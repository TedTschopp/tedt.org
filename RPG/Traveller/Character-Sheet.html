<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller 2nd Edition Character Sheet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Google Fonts for Traveller-like typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arsenal:wght@400;700&family=Marcellus&family=Roboto:wght@400;500;700&family=Arimo:wght@400;500;700&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode (only mode now) */
            --traveller-primary: #111111;    /* Deep Black for backgrounds, headers, footers */
            --traveller-secondary: #F0F0F0;  /* Light Grey for text and content background */
            --traveller-tertiary: #BB0000;   /* Traveller Red for highlights, call to actions */
            --traveller-supporting: #888888; /* Neutral Grey for supporting elements */
            --traveller-text-on-dark: #FFFFFF; /* White text for dark backgrounds */
            --traveller-text-on-light: #333333; /* Dark text for light backgrounds */
            --traveller-border: #DDDDDD;
            --traveller-content-bg: #FFFFFF;
            --traveller-input-bg: #FFFFFF;
            --traveller-input-border: #CED4DA;
            --traveller-characteristic-box-bg: #F0F0F0;
            --traveller-table-bg: #FFFFFF;
            --traveller-table-border: #DEE2E6;
            --traveller-table-header-bg: rgba(17, 17, 17, 0.1);
            
            /* Font families */
            --font-headlines: 'Arsenal', sans-serif;
            --font-titles: 'Marcellus', serif;
            --font-ui: 'Roboto', sans-serif;
            --font-standard: 'Arimo', sans-serif;
            --font-secondary: 'Work Sans', sans-serif;
        }
        
        body {
            background-color: var(--traveller-secondary);
            font-family: var(--font-standard);
            color: var(--traveller-text-on-light);
            transition: background-color 0.3s ease;
        }
        
        .character-sheet {
            max-width: 1200px;
            margin: 20px auto;
            background-color: var(--traveller-content-bg);
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
            border-radius: 3px;
            position: relative;
            border: 1px solid var(--traveller-border);
            transition: all 0.3s ease;
        }
        
        .characteristic-box {
            border: 2px solid var(--traveller-primary);
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            background-color: var(--traveller-characteristic-box-bg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* Rest of your existing CSS remains the same, the theme variables will apply automatically */
        
        .sheet-header {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            padding: 20px 15px;
            margin-bottom: 25px;
            border-radius: 3px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .sheet-header h1 {
            margin: 0;
            font-family: var(--font-titles);
            font-weight: 400;
            font-size: 2.2rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0px 2px 2px rgba(0, 0, 0, 0.3);
        }
        
        .sheet-header::after {
            content: "";
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 6px;
            background-color: var(--traveller-tertiary);
        }
        
        /* Optional starburst/logo effect */
        .sheet-header::before {
            content: "";
            position: absolute;
            top: -25px;
            right: -25px;
            width: 150px;
            height: 150px;
            background: radial-gradient(var(--traveller-tertiary) 10%, transparent 65%);
            opacity: 0.5;
            border-radius: 50%;
        }
        
        .section-header {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            padding: 8px 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-radius: 3px;
            font-weight: 700;
            font-family: var(--font-headlines);
            letter-spacing: 0.5px;
            border-left: 4px solid var(--traveller-tertiary);
        }
        
        .skill-item, .equipment-item, .weapon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--traveller-border);
        }
        
        .characteristic-box {
            border: 2px solid var(--traveller-primary);
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            background-color: var(--traveller-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .characteristic-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--traveller-tertiary);
        }
        
        .characteristic-box h4 {
            margin: 0;
            color: var(--traveller-primary);
            font-family: var(--font-headlines);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .characteristic-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--traveller-primary);
            font-family: var(--font-standard);
        }
        
        .characteristic-dm {
            font-size: 1.2rem;
            color: var(--traveller-tertiary);
            font-weight: bold;
            font-family: var(--font-standard);
        }
        
        .important-stat {
            font-weight: bold;
            color: var (--traveller-tertiary);
            font-family: var(--font-headlines);
        }
        
        label.form-label {
            font-weight: 500;
            color: var(--traveller-primary);
            font-family: var(--font-headlines);
        }
        
        /* Button styling */
        .dice-btn {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .dice-btn:hover {
            background-color: var(--traveller-tertiary);
        
        .dice-btn:hover {
            background-color: var(--traveller-tertiary);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background-color: var(--traveller-supporting);
            border-color: var(--traveller-supporting);
            color: var(--traveller-text-on-dark);
            font-family: var(--font-ui);
            font-weight: 500;
        .btn-secondary:hover {
            background-color: var(--traveller-tertiary);
            border-color: var(--traveller-tertiary);
        }
        
        .btn-info {
            background-color: var(--traveller-supporting);
            border-color: var(--traveller-supporting);
            color: var(--traveller-text-on-dark);
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-info:hover {
            background-color: var (--traveller-tertiary);
            border-color: var(--traveller-tertiary);
        }
        
        .btn-danger {
            background-color: var(--traveller-tertiary);
            border-color: var(--traveller-tertiary);
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-add {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            border: none;
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-add:hover {
            background-color: var(--traveller-tertiary);
            color: var(--traveller-text-on-dark);
        }
        
        .btn-remove {
            background-color: var(--traveller-tertiary);
            color: var (--traveller-text-on-dark);
            border: none;
            padding: 2px 8px;
            font-size: 0.8rem;
            border-radius: 3px;
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-remove:hover {
            background-color: #700000;
        }
        
        table thead th {
            background-color: rgba(17, 17, 17, 0.1); /* Semitransparent primary */
            color: var(--traveller-primary);
            font-family: var(--font-headlines);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .skill-name {
            font-weight: 600;
            color: var(--traveller-primary);
            font-family: var(--font-standard);
        }
        
        .skill-specialization {
            font-style: italic;
            color: var(--traveller-supporting);
            margin-left: 3px;
            font-family: var(--font-secondary);
            font-weight: 400;
        }
        
        #specializationField {
            max-width: 150px;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            
            body {
                background-color: white;
            }
            
            .character-sheet {
                box-shadow: none;
                margin: 0;
                padding: 10px;
            }
        }

        .credits {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--traveller-supporting);
            font-family: var(--font-secondary);
        }
        
        #roll-result {
            font-weight: bold;
            font-size: 1.2rem;
            min-height: 30px;
            margin-top: 10px;
            text-align: center;
            font-family: var(--font-ui);
            color: var(--traveller-tertiary);
        }

        /* Improved focus styles for accessibility */
        input:focus, select:focus, textarea:focus, button:focus {
            outline: 2px solid var(--traveller-tertiary);
            box-shadow: 0 0 0 2px rgba(187, 0, 0, 0.25);
        }
        
        /* Custom scrollbar to match theme */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--traveller-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--traveller-supporting);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--traveller-tertiary);
        }
    </style>
</head>
<body>
    <div class="container character-sheet">
        <div class="sheet-header">
            <h1>TRAVELLER 2ND EDITION</h1>
        </div>
        
        <!-- Character Information -->
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="charName" class="form-label">Character Name</label>
                <input type="text" class="form-control" id="charName">
            </div>
            <div class="col-md-4 mb-3">
                <label for="species" class="form-label">Species</label>
                <input type="text" class="form-control" id="species" value="Human">
            </div>
            <div class="col-md-4 mb-3">
                <label for="age" class="form-label">Age</label>
                <input type="number" class="form-control" id="age" value="18">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="section-header">
                    CAREER HISTORY
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Career</th>
                                <th>Terms</th>
                                <th>Rank & Title</th>
                                <th>Benefits</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="careers-container">
                            <!-- Careers will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="row mb-3 no-print">
                    <div class="col-md-12">
                        <div class="input-group">
                            <select class="form-control" id="careerName">
                                <option value="">Select Career...</option>
                                <!-- Career options will be populated by JavaScript -->
                            </select>
                            <input type="number" class="form-control" id="careerTerms" placeholder="Terms" min="1" value="1" style="max-width: 100px;">
                            <input type="text" class="form-control" id="careerRank" placeholder="Rank & Title">
                            <input type="text" class="form-control" id="careerBenefits" placeholder="Benefits">
                            <button class="btn btn-add" onclick="addCareer()">Add Career</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Characteristics Section -->
        <div class="section-header">
            CHARACTERISTICS
        </div>

        <div class="row">
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>STR</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="str" value="7" min="0" max="15" oninput="updateDM('str')">
                    <span class="characteristic-dm" id="str-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>DEX</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="dex" value="7" min="0" max="15" oninput="updateDM('dex')">
                    <span class="characteristic-dm" id="dex-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>END</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="end" value="7" min="0" max="15" oninput="updateDM('end')">
                    <span class="characteristic-dm" id="end-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>INT</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="int" value="7" min="0" max="15" oninput="updateDM('int')">
                    <span class="characteristic-dm" id="int-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>EDU</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="edu" value="7" min="0" max="15" oninput="updateDM('edu')">
                    <span class="characteristic-dm" id="edu-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>SOC</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="soc" value="7" min="0" max="15" oninput="updateDM('soc')">
                    <span class="characteristic-dm" id="soc-dm">-1</span>
                </div>
            </div>
        </div>

        <!-- Secondary Characteristics -->
        <div class="row mt-3">
            <div class="col-md-3 mb-3">
                <label for="endurance" class="form-label important-stat">Endurance</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="endurance" value="0">
                    <span class="input-group-text">/</span>
                    <input type="number" class="form-control" id="enduranceMax" value="0">
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <label for="lifeblood" class="form-label important-stat">Lifeblood</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="lifeblood" value="0">
                    <span class="input-group-text">/</span>
                    <input type="number" class="form-control" id="lifebloodMax" value="0">
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <label for="resolve" class="form-label important-stat">Resolve</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="resolve" value="0">
                    <span class="input-group-text">/</span>
                    <input type="number" class="form-control" id="resolveMax" value="0">
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <label for="psi" class="form-label">PSI</label>
                <input type="number" class="form-control" id="psi" value="0" min="0">
            </div>
        </div>

        <!-- Skills Section -->
        <div class="section-header d-flex justify-content-between">
            <div>SKILLS</div>
        </div>
        
        <div class="row skill-search no-print">
            <div class="col-md-10 mb-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="skillSearch" placeholder="Skill name...">
                    <input type="text" class="form-control" id="specializationField" placeholder="Specialization (optional)">
                    <input type="number" class="form-control" id="skillLevel" placeholder="Level" min="0" value="0" style="max-width: 80px;">
                    <button class="btn btn-add" onclick="addSkill()">Add</button>
                </div>
            </div>
        </div>
        
        <div id="skills-container">
            <!-- Skills will be added here by JavaScript -->
        </div>

        <!-- Weapons Section -->
        <div class="section-header">
            WEAPONS & ATTACKS
        </div>
        
        <div class="row mb-3 no-print">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" class="form-control" id="weaponName" placeholder="Weapon Name">
                    <input type="text" class="form-control" id="weaponDamage" placeholder="Damage" style="max-width: 120px;">
                    <input type="number" class="form-control" id="weaponRange" placeholder="Range" style="max-width: 80px;">
                    <button class="btn btn-add" onclick="addWeapon()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Weapon</th>
                        <th>Skill</th>
                        <th>Damage</th>
                        <th>Range</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="weapons-container">
                    <!-- Weapons will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Armor Section -->
        <div class="section-header">
            ARMOR
        </div>
        
        <div class="row mb-3 no-print">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" class="form-control" id="armorName" placeholder="Armor Name">
                    <input type="number" class="form-control" id="armorRating" placeholder="Rating" style="max-width: 100px;" min="0">
                    <input type="text" class="form-control" id="armorTL" placeholder="TL" style="max-width: 60px;">
                    <input type="text" class="form-control" id="armorRadiation" placeholder="Rad" style="max-width: 60px;">
                    <button class="btn btn-add" onclick="addArmor()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Armor</th>
                        <th>Rating</th>
                        <th>TL</th>
                        <th>Rad</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="armor-container">
                    <!-- Armor will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Equipment Section -->
        <div class="section-header">
            EQUIPMENT
        </div>
        
        <div class="row mb-3 no-print">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" class="form-control" id="equipmentName" placeholder="Equipment Name">
                    <input type="text" class="form-control" id="equipmentTL" placeholder="TL" style="max-width: 60px;">
                    <input type="number" class="form-control" id="equipmentMass" placeholder="Mass" style="max-width: 80px;" step="0.1">
                    <input type="number" class="form-control" id="equipmentCost" placeholder="Cost" style="max-width: 100px;">
                    <button class="btn btn-add" onclick="addEquipment()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Equipment</th>
                        <th>TL</th>
                        <th>Mass</th>
                        <th>Cost (Cr)</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="equipment-container">
                    <!-- Equipment will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Finances -->
        <div class="section-header">
            FINANCES
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="credits" class="form-label">Credits</label>
                <div class="input-group">
                    <span class="input-group-text">Cr</span>
                    <input type="number" class="form-control" id="credits" value="0">
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="pension" class="form-label">Pension</label>
                <div class="input-group">
                    <span class="input-group-text">Cr</span>
                    <input type="number" class="form-control" id="pension" value="0">
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="debt" class="form-label">Debt</label>
                <div class="input-group">
                    <span class="input-group-text">Cr</span>
                    <input type="number" class="form-control" id="debt" value="0">
                </div>
            </div>
        </div>

        <!-- Dice Roller -->
        <div class="section-header no-print">
            DICE ROLLER
        </div>
        
        <div class="row no-print">
            <div class="col-md-12 text-center mb-3">
                <button class="btn dice-btn" onclick="rollDice(2, 6)">Roll 2D</button>
                <button class="btn dice-btn" onclick="rollTask(8)">Task (8+)</button>
                <button class="btn dice-btn" onclick="rollTask(10)">Hard Task (10+)</button>
                <button class="btn dice-btn" onclick="rollTask(12)">Formidable (12+)</button>
                <button class="btn dice-btn" onclick="rollTask(14)">Impossible (14+)</button>
                <div id="roll-result"></div>
            </div>
        </div>

        <!-- Notes -->
        <div class="section-header">
            NOTES
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <textarea class="form-control" id="notes" rows="5"></textarea>
            </div>
        </div>

        <!-- Print Button -->
        <div class="row no-print">
            <div class="col-md-12 text-center">
                <button class="btn dice-btn" onclick="window.print()">Print Character Sheet</button>
                <button class="btn btn-secondary" onclick="saveCharacter()">Save Character</button>
                <button class="btn btn-secondary" onclick="loadCharacter()">Load Character</button>
                <button class="btn btn-danger" onclick="resetCharacter()">Reset Sheet</button>
                <button class="btn btn-info" onclick="exportCharacter()">Export Character</button>
                <button class="btn btn-info" onclick="importCharacter()">Import Character</button>
                <button class="btn btn-danger" onclick="deleteCharacter()">Delete Saved Character</button>
            </div>
        </div>
        
        <div class="credits">
            Traveller is a registered trademark of Far Future Enterprises. This character sheet is unofficial and for personal use only.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Common Traveller Skills
        const commonSkills = [
            "Admin", "Advocate", "Animals", "Art", "Athletics", "Astrogation", "Battle Dress",
            "Broker", "Carouse", "Deception", "Diplomat", "Drive", "Electronics", "Engineer",
            "Explosives", "Flyer", "Gambler", "Gun Combat", "Gunner", "Heavy Weapons", "Investigate",
            "Jack of all Trades", "Language", "Leadership", "Mechanic", "Medic", "Melee", "Navigation",
            "Persuade", "Pilot", "Profession", "Recon", "Science", "Seafarer", "Stealth", "Steward",
            "Streetwise", "Survival", "Tactics", "Vacc Suit"
        ];

        // Skills that require adding all specializations when one is learned
        const skillsWithMandatorySpecializations = [
            "Athletics", "Drive", "Flyer", "Gunner", "Heavy Weapons", 
            "Melee", "Pilot", "Seafarer"
        ];

        // Common specializations for skills
        const skillSpecializations = {
            "Animals": ["Handling", "Training", "Veterinary"],
            "Art": ["Performer", "Holography", "Instrument", "Visual Media", "Write"],
            "Athletics": ["Dexterity", "Endurance", "Strength"],
            "Drive": ["Hovercraft", "Mole", "Tracked", "Walker", "Wheeled"],
            "Electronics": ["Comms", "Computers", "Remote Ops", "Sensors"],
            "Engineer": ["J-Drive", "Life Support", "M-Drive", "Power"],
            "Flyer": ["Airship", "Grav", "Ornithopter", "Rotor", "Wing"],
            "Gun Combat": ["Archaic", "Energy", "Slug"],
            "Gunner": ["Capital", "Ortillery", "Screen", "Turret"],
            "Heavy Weapons": ["Artillery", "Man Portable", "Vehicle"],
            "Language": ["Anglic", "Aslan", "Vargr", "Vilani", "Zdetl", "Oynprith", "Other"],
            "Mechanic": ["Aircraft", "Gravitics", "Mole", "Walker", "Wheeled"],
            "Melee": ["Blade", "Bludgeon", "Natural", "Unarmed"],
            "Pilot": ["Capital Ships", "Small Craft", "Spacecraft"],
            "Profession": ["Belter", "Biologicals", "Civil Engineering", "Construction", "Hydroponics", "Polymers"],
            "Science": ["Archaeology", "Astronomy", "Biology", "Chemistry", "Cosmology", "Cybernetics", "Economics", "Genetics", "History", "Linguistics", "Mathematics", "Physics", "Political Science", "Psychology", "Physics", "Planetology", "Psionicology", "Robotics", "Sophontology", "Xenology"],
            "Seafarer": ["Ocean Ships", "Personal", "Sail", "Submarine"],
            "Tactics": ["Military", "Naval"]
        };

        // Initialize the character sheet
        document.addEventListener('DOMContentLoaded', function() {
            updateDM('str');
            updateDM('dex');
            updateDM('end');
            updateDM('int');
            updateDM('edu');
            updateDM('soc');
            
            // Add autocomplete to skill search
            const skillSearch = document.getElementById('skillSearch');
            const datalist = document.createElement('datalist');
            datalist.id = 'skill-list';
            
            commonSkills.forEach(skill => {
                const option = document.createElement('option');
                option.value = skill;
                datalist.appendChild(option);
            });
            
            document.body.appendChild(datalist);
            skillSearch.setAttribute('list', 'skill-list');
            
            // Add autocomplete handling for specializations
            const specializationField = document.getElementById('specializationField');
            const specList = document.createElement('datalist');
            specList.id = 'specialization-list';
            document.body.appendChild(specList);
            specializationField.setAttribute('list', 'specialization-list');
            
            // Update specialization options when skill changes
            skillSearch.addEventListener('input', updateSpecializationOptions);
            
            // Load character if exists in localStorage
            if (localStorage.getItem('traveller-character')) {
                const loadNow = confirm('Found a saved character. Load it now?');
                if (loadNow) {
                    loadCharacter();
                }
            }
        });

        // Update specialization options based on selected skill
        function updateSpecializationOptions() {
            const skillName = document.getElementById('skillSearch').value;
            const specList = document.getElementById('specialization-list');
            specList.innerHTML = '';  // Clear existing options
            
            if (skillSpecializations[skillName]) {
                skillSpecializations[skillName].forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec;
                    specList.appendChild(option);
                });
            }
        }

        // Update the DM (Dice Modifier) based on characteristic value
        function updateDM(stat) {
            const value = parseInt(document.getElementById(stat).value);
            let dm = 0;
            
            if (value === 0) dm = -3;
            else if (value <= 2) dm = -2;
            else if (value <= 5) dm = -1;
            else if (value <= 8) dm = 0;
            else if (value <= 11) dm = 1;
            else if (value <= 14) dm = 2;
            else dm = 3;
            
            document.getElementById(`${stat}-dm`).textContent = dm >= 0 ? `+${dm}` : dm;
            
            // Update derived stats
            if (stat === 'end') {
                document.getElementById('endurance').value = value;
                document.getElementById('enduranceMax').value = value;
            }
            
            // Update lifeblood (STR + END)/2
            if (stat === 'str' || stat === 'end') {
                const str = parseInt(document.getElementById('str').value);
                const end = parseInt(document.getElementById('end').value);
                const lifeblood = Math.floor((str + end) / 2);
                
                document.getElementById('lifeblood').value = lifeblood;
                document.getElementById('lifebloodMax').value = lifeblood;
            }

            // Update resolve (INT + EDU)/2
            if (stat === 'int' || stat === 'edu') {
                const int = parseInt(document.getElementById('int').value);
                const edu = parseInt(document.getElementById('edu').value);
                const resolve = Math.floor((int + edu) / 2);
                
                document.getElementById('resolve').value = resolve;
                document.getElementById('resolveMax').value = resolve;
            }
        }

        // Modified addSkill function to handle mandatory specializations
        function addSkill() {
            const skillName = document.getElementById('skillSearch').value;
            const specialization = document.getElementById('specializationField').value;
            const skillLevel = document.getElementById('skillLevel').value || 0;
            
            if (!skillName) return;
            
            // Special handling for skills with mandatory specializations
            if (skillsWithMandatorySpecializations.includes(skillName)) {
                if (!specialization && skillSpecializations[skillName]?.length > 0) {
                    alert(`The skill "${skillName}" requires you to select a specialization.`);
                    return;
                }
                
                // Add all specializations at level 0, with the chosen one at the specified level
                const specs = skillSpecializations[skillName] || [];
                if (specs.length > 0) {
                    // First check if any specializations already exist
                    const existingSpecs = getExistingSpecializations(skillName);
                    
                    // If not all specializations exist yet, add all of them
                    if (existingSpecs.length < specs.length) {
                        for (const spec of specs) {
                            if (!existingSpecs.includes(spec)) {
                                // This is the chosen specialization, add it with the specified level
                                if (spec === specialization) {
                                    addSingleSkill(skillName, spec, skillLevel);
                                } else {
                                    // Other specializations are added at level 0
                                    addSingleSkill(skillName, spec, 0);
                                }
                            }
                        }
                        alert(`All specializations for ${skillName} have been added to your character sheet.`);
                        return;
                    } else {
                        // If all specializations already exist, just update the level of the chosen one
                        updateExistingSkill(skillName, specialization, skillLevel);
                        return;
                    }
                }
            }
            
            // Standard skill addition for non-special skills
            addSingleSkill(skillName, specialization, skillLevel);
            
            // Clear inputs
            document.getElementById('skillSearch').value = '';
            document.getElementById('specializationField').value = '';
            document.getElementById('skillLevel').value = 0;
        }
        
        // Helper function to add a single skill
        function addSingleSkill(skillName, specialization, skillLevel) {
            // Check if skill already exists
            const existingSkills = document.querySelectorAll('.skill-name');
            for (let i = 0; i < existingSkills.length; i++) {
                if (existingSkills[i].getAttribute('data-skill') === skillName && 
                    existingSkills[i].getAttribute('data-specialization') === specialization) {
                    
                    // Update existing skill instead of adding duplicate
                    updateExistingSkill(skillName, specialization, skillLevel);
                    return;
                }
            }
            
            const skillsContainer = document.getElementById('skills-container');
            const skillDiv = document.createElement('div');
            skillDiv.className = 'skill-item';
            
            // Store both skill name and specialization separately for data handling
            skillDiv.innerHTML = `
                <span class="skill-name" data-skill="${skillName}" data-specialization="${specialization || ''}">
                    ${skillName}${specialization ? ` <span class="skill-specialization">(${specialization})</span>` : ''}
                </span>
                <div class="d-flex align-items-center">
                    <input type="number" class="form-control form-control-sm mx-2" value="${skillLevel}" min="0" style="width: 60px;">
                    <button class="btn btn-remove no-print" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            skillsContainer.appendChild(skillDiv);
        }

        // Helper function to get existing specializations for a skill
        function getExistingSpecializations(skillName) {
            const existingSkills = document.querySelectorAll('.skill-name');
            const existingSpecs = [];
            
            for (let i = 0; i < existingSkills.length; i++) {
                if (existingSkills[i].getAttribute('data-skill') === skillName) {
                    const spec = existingSkills[i].getAttribute('data-specialization');
                    if (spec) {
                        existingSpecs.push(spec);
                    }
                }
            }
            
            return existingSpecs;
        }

        // Helper function to update an existing skill's level
        function updateExistingSkill(skillName, specialization, level) {
            const skillItems = document.querySelectorAll('.skill-item');
            
            for (let i = 0; i < skillItems.length; i++) {
                const skillNameElem = skillItems[i].querySelector('.skill-name');
                
                if (skillNameElem.getAttribute('data-skill') === skillName && 
                    skillNameElem.getAttribute('data-specialization') === specialization) {
                    const input = skillItems[i].querySelector('input');
                    input.value = level;
                    return true;
                }
            }
            
            return false;
        }

        // Add armor to the armor table
        function addArmor() {
            const armorName = document.getElementById('armorName').value;
            const armorRating = document.getElementById('armorRating').value;
            const armorTL = document.getElementById('armorTL').value;
            const armorRadiation = document.getElementById('armorRadiation').value;
            
            if (!armorName) return;
            
            const armorContainer = document.getElementById('armor-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${armorName}</td>
                <td>${armorRating}</td>
                <td>${armorTL}</td>
                <td>${armorRadiation}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                </td>
            `;
            
            armorContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('armorName').value = '';
            document.getElementById('armorRating').value = '';
            document.getElementById('armorTL').value = '';
            document.getElementById('armorRadiation').value = '';
        }

        // Add equipment to the equipment table
        function addEquipment() {
            const equipmentName = document.getElementById('equipmentName').value;
            const equipmentTL = document.getElementById('equipmentTL').value;
            const equipmentMass = document.getElementById('equipmentMass').value;
            const equipmentCost = document.getElementById('equipmentCost').value;
            
            if (!equipmentName) return;
            
            const equipmentContainer = document.getElementById('equipment-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${equipmentName}</td>
                <td>${equipmentTL}</td>
                <td>${equipmentMass}</td>
                <td>${equipmentCost}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                </td>
            `;
            
            equipmentContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('equipmentName').value = '';
            document.getElementById('equipmentTL').value = '';
            document.getElementById('equipmentMass').value = '';
            document.getElementById('equipmentCost').value = '';
        }

        // Dice rolling functions
        function rollDice(num, sides) {
            let total = 0;
            let rolls = [];
            
            for (let i = 0; i < num; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            
            document.getElementById('roll-result').innerHTML = `
                Result: ${total} (${rolls.join(' + ')})
            `;
            
            return total;
        }

        function rollTask(target) {
            const result = rollDice(2, 6);
            let success = "FAILURE";
            
            if (result >= target) {
                success = "SUCCESS";
            }
            
            document.getElementById('roll-result').innerHTML = `
                Result: ${result} vs. Target ${target} - ${success}!
            `;
        }

        // Save character to localStorage
        function saveCharacter() {
            const character = {
                // Basic info
                charName: document.getElementById('charName').value,
                species: document.getElementById('species').value,
                age: document.getElementById('age').value,
                
                // Get career details
                careers: Array.from(document.getElementById('careers-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        career: cells[0].getAttribute('data-career') || cells[0].textContent,
                        terms: cells[1].getAttribute('data-terms') || cells[1].textContent,
                        rank: cells[2].getAttribute('data-rank') || cells[2].textContent,
                        benefits: cells[3].getAttribute('data-benefits') || cells[3].textContent
                    };
                }).filter(c => c !== null),
                
                // Characteristics
                str: document.getElementById('str').value,
                dex: document.getElementById('dex').value,
                end: document.getElementById('end').value,
                int: document.getElementById('int').value,
                edu: document.getElementById('edu').value,
                soc: document.getElementById('soc').value,
                
                // Secondary characteristics
                endurance: document.getElementById('endurance').value,
                enduranceMax: document.getElementById('enduranceMax').value,
                lifeblood: document.getElementById('lifeblood').value,
                lifebloodMax: document.getElementById('lifebloodMax').value,
                resolve: document.getElementById('resolve').value,
                resolveMax: document.getElementById('resolveMax').value,
                psi: document.getElementById('psi').value,
                
                // Finances
                credits: document.getElementById('credits').value,
                pension: document.getElementById('pension').value,
                debt: document.getElementById('debt').value,
                
                // Notes
                notes: document.getElementById('notes').value,
                
                // Skills
                skills: Array.from(document.querySelectorAll('.skill-item')).map(item => {
                    const skillElement = item.querySelector('.skill-name');
                    return {
                        name: skillElement.getAttribute('data-skill'),
                        specialization: skillElement.getAttribute('data-specialization'),
                        level: item.querySelector('input').value
                    };
                }),
                
                // Weapons
                weapons: Array.from(document.getElementById('weapons-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        name: cells[0].textContent,
                        skill: cells[1].querySelector('input') ? cells[1].querySelector('input').value : '',
                        damage: cells[2].textContent,
                        range: cells[3].textContent
                    };
                }).filter(w => w !== null),
                
                // Armor
                armor: Array.from(document.getElementById('armor-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        name: cells[0].textContent,
                        rating: cells[1].textContent,
                        tl: cells[2].textContent,
                        radiation: cells[3].textContent
                    };
                }).filter(a => a !== null),
                
                // Equipment
                equipment: Array.from(document.getElementById('equipment-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        name: cells[0].textContent,
                        tl: cells[1].textContent,
                        mass: cells[2].textContent,
                        cost: cells[3].textContent
                    };
                }).filter(e => e !== null)
            };
            
            try {
                localStorage.setItem('traveller-character', JSON.stringify(character));
                alert('Character saved successfully!');
            } catch (e) {
                console.error('Save failed:', e);
                alert('Failed to save character. Error: ' + e.message);
            }
        }
        
        // Load character from localStorage
        function loadCharacter() {
            try {
                const savedCharacter = localStorage.getItem('traveller-character');
                if (!savedCharacter) {
                    alert('No saved character found.');
                    return;
                }
                
                const character = JSON.parse(savedCharacter);
                
                // Basic info
                document.getElementById('charName').value = character.charName || '';
                document.getElementById('species').value = character.species || 'Human';
                document.getElementById('age').value = character.age || '18';
                
                // Clear existing careers
                document.getElementById('careers-container').innerHTML = '';
                
                // Load careers if they exist
                if (character.careers && character.careers.length) {
                    character.careers.forEach(careerData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-career="${careerData.career}">${careerData.career}</td>
                            <td data-terms="${careerData.terms}">${careerData.terms}</td>
                            <td data-rank="${careerData.rank}">${careerData.rank}</td>
                            <td data-benefits="${careerData.benefits}">${careerData.benefits}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                            </td>
                        `;
                        document.getElementById('careers-container').appendChild(row);
                    });
                    
                    updateTotalTerms();
                }
                
                // Characteristics
                document.getElementById('str').value = character.str || '7';
                document.getElementById('dex').value = character.dex || '7';
                document.getElementById('end').value = character.end || '7';
                document.getElementById('int').value = character.int || '7';
                document.getElementById('edu').value = character.edu || '7';
                document.getElementById('soc').value = character.soc || '7';
                
                // Update DMs after setting characteristics
                updateDM('str');
                updateDM('dex');
                updateDM('end');
                updateDM('int');
                updateDM('edu');
                updateDM('soc');
                
                // Secondary characteristics
                document.getElementById('endurance').value = character.endurance || '0';
                document.getElementById('enduranceMax').value = character.enduranceMax || '0';
                document.getElementById('lifeblood').value = character.lifeblood || '0';
                document.getElementById('lifebloodMax').value = character.lifebloodMax || '0';
                document.getElementById('resolve').value = character.resolve || '0';
                document.getElementById('resolveMax').value = character.resolveMax || '0';
                document.getElementById('psi').value = character.psi || '0';
                
                // Finances
                document.getElementById('credits').value = character.credits || '0';
                document.getElementById('pension').value = character.pension || '0';
                document.getElementById('debt').value = character.debt || '0';
                
                // Notes
                document.getElementById('notes').value = character.notes || '';
                
                // Clear existing items
                document.getElementById('skills-container').innerHTML = '';
                document.getElementById('weapons-container').innerHTML = '';
                document.getElementById('armor-container').innerHTML = '';
                document.getElementById('equipment-container').innerHTML = '';
                
                // Skills with specialization support
                if (character.skills && character.skills.length) {
                    character.skills.forEach(skill => {
                        const skillDiv = document.createElement('div');
                        skillDiv.className = 'skill-item';
                        skillDiv.innerHTML = `
                            <span class="skill-name" data-skill="${skill.name}" data-specialization="${skill.specialization || ''}">
                                ${skill.name}${skill.specialization ? ` <span class="skill-specialization">(${skill.specialization})</span>` : ''}
                            </span>
                            <div class="d-flex align-items-center">
                                <input type="number" class="form-control form-control-sm mx-2" value="${skill.level}" min="0" style="width: 60px;">
                                <button class="btn btn-remove no-print" onclick="this.parentElement.parentElement.remove()">×</button>
                            </div>
                        `;
                        document.getElementById('skills-container').appendChild(skillDiv);
                    });
                }
                
                // Weapons
                if (character.weapons && character.weapons.length) {
                    character.weapons.forEach(weapon => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${weapon.name}</td>
                            <td><input type="text" class="form-control form-control-sm" value="${weapon.skill}" placeholder="Skill"></td>
                            <td>${weapon.damage}</td>
                            <td>${weapon.range}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                            </td>
                        `;
                        document.getElementById('weapons-container').appendChild(row);
                    });
                }
                
                // Armor
                if (character.armor && character.armor.length) {
                    character.armor.forEach(armor => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${armor.name}</td>
                            <td>${armor.rating}</td>
                            <td>${armor.tl}</td>
                            <td>${armor.radiation}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                            </td>
                        `;
                        document.getElementById('armor-container').appendChild(row);
                    });
                }
                
                // Equipment
                if (character.equipment && character.equipment.length) {
                    character.equipment.forEach(equipment => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${equipment.name}</td>
                            <td>${equipment.tl}</td>
                            <td>${equipment.mass}</td>
                            <td>${equipment.cost}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                        `;
                        document.getElementById('equipment-container').appendChild(row);
                    });
                }
                
                alert('Character loaded successfully!');
            } catch (e) {
                console.error('Load failed:', e);
                alert('Failed to load character. Error: ' + e.message);
            }
        }
        
        // Reset character sheet
        function resetCharacter() {
            if (confirm('Are you sure you want to reset the character sheet? All data will be lost.')) {
                // Basic info
                document.getElementById('charName').value = '';
                document.getElementById('species').value = 'Human';
                document.getElementById('age').value = '18';
                
                // Characteristics
                document.getElementById('str').value = '7';
                document.getElementById('dex').value = '7';
                document.getElementById('end').value = '7';
                document.getElementById('int').value = '7';
                document.getElementById('edu').value = '7';
                document.getElementById('soc').value = '7';
                
                // Update DMs
                updateDM('str');
                updateDM('dex');
                updateDM('end');
                updateDM('int');
                updateDM('edu');
                updateDM('soc');
                
                // Finances
                document.getElementById('credits').value = '0';
                document.getElementById('pension').value = '0';
                document.getElementById('debt').value = '0';
                
                // Notes
                document.getElementById('notes').value = '';
                
                // Clear containers
                document.getElementById('skills-container').innerHTML = '';
                document.getElementById('weapons-container').innerHTML = '';
                document.getElementById('armor-container').innerHTML = '';
                document.getElementById('equipment-container').innerHTML = '';
                
                alert('Character sheet has been reset.');
            }
        }
        
        // Add shortcut for adding typical human characteristics
        function setHumanCharacteristics() {
            document.getElementById('str').value = '7';
            document.getElementById('dex').value = '7';
            document.getElementById('end').value = '7';
            document.getElementById('int').value = '7';
            document.getElementById('edu').value = '7';
            document.getElementById('soc').value = '7';
            
            updateDM('str');
            updateDM('dex');
            updateDM('end');
            updateDM('int');
            updateDM('edu');
            updateDM('soc');
        }
        
        // Export character to JSON file
        function exportCharacter() {
            const characterData = localStorage.getItem('traveller-character');
            if (!characterData) {
                alert('No character data to export. Please save your character first.');
                return;
            }
            
            const character = JSON.parse(characterData);
            const characterName = character.charName || 'traveller-character';
            const filename = `${characterName.replace(/\s+/g, '-')}.json`;
            
            const blob = new Blob([characterData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Import character from JSON file
        function importCharacter() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const characterData = e.target.result;
                        localStorage.setItem('traveller-character', characterData);
                        loadCharacter();
                    } catch (error) {
                        console.error('Import failed:', error);
                        alert('Failed to import character. The file might be corrupted.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Add weapon to the weapons table
        function addWeapon() {
            const weaponName = document.getElementById('weaponName').value;
            const weaponDamage = document.getElementById('weaponDamage').value;
            const weaponRange = document.getElementById('weaponRange').value;
            
            if (!weaponName) return;
            
            const weaponsContainer = document.getElementById('weapons-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${weaponName}</td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Skill"></td>
                <td>${weaponDamage}</td>
                <td>${weaponRange}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                </td>
            `;
            
            weaponsContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponDamage').value = '';
            document.getElementById('weaponRange').value = '';
        }

        // MGT2 Careers from the rulebook
        const mgt2Careers = [
            "Agent", "Army", "Citizen", "Drifter", "Entertainer", 
            "Marine", "Merchant", "Navy", "Noble", "Rogue", 
            "Scholar", "Scout", "Psion"
        ];
        
        // Additional careers from supplements
        const supplementCareers = [
            "Aerospace Defense", "Advocate", "Barbarian", "Belter", "Bureaucrat",
            "Colony Citizen", "Corsair", "Diplomat", "Doctor", "Explorer", 
            "Flyer", "Hunter", "Journalist", "Pirate", "Prisoner",
            "Scientist", "Spacer", "Technician", "Wanderer"
        ];
        
        // Add career to the careers table
        function addCareer() {
            const careerName = document.getElementById('careerName').value;
            const careerTerms = document.getElementById('careerTerms').value;
            const careerRank = document.getElementById('careerRank').value;
            const careerBenefits = document.getElementById('careerBenefits').value;
            
            if (!careerName) {
                alert("Please select a career");
                return;
            }
            
            const careersContainer = document.getElementById('careers-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-career="${careerName}">${careerName}</td>
                <td data-terms="${careerTerms}">${careerTerms}</td>
                <td data-rank="${careerRank}">${careerRank}</td>
                <td data-benefits="${careerBenefits}">${careerBenefits}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                </td>
            `;
            
            careersContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('careerName').selectedIndex = 0;
            document.getElementById('careerTerms').value = '1';
            document.getElementById('careerRank').value = '';
            document.getElementById('careerBenefits').value = '';
            
            // Update total terms
            updateTotalTerms();
        }
        
        // Calculate total terms across all careers
        function updateTotalTerms() {
            const careerRows = document.querySelectorAll('#careers-container tr');
            let totalTerms = 0;
            
            careerRows.forEach(row => {
                const termsCell = row.querySelector('td[data-terms]');
                if (termsCell) {
                    totalTerms += parseInt(termsCell.getAttribute('data-terms')) || 0;
                }
            });
            
            // Update display of total terms somewhere if needed
            if (document.getElementById('totalTerms')) {
                document.getElementById('totalTerms').textContent = totalTerms;
            }
            
            // Calculate biological age based on terms
            if (document.getElementById('age')) {
                // Base age at character creation is 18
                const biologicalAge = 18 + (totalTerms * 4);
                document.getElementById('age').value = biologicalAge;
            }
        }
        
        // Initialize career dropdown on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Existing init code...
            
            // Populate career dropdown
            const careerSelect = document.getElementById('careerName');
            
            // Add optgroup for core rulebook careers
            const coreGroup = document.createElement('optgroup');
            coreGroup.label = 'Core Rulebook';
            mgt2Careers.forEach(career => {
                const option = document.createElement('option');
                option.value = career;
                option.textContent = career;
                coreGroup.appendChild(option);
            });
            careerSelect.appendChild(coreGroup);
            
            // Add optgroup for supplement careers
            const suppGroup = document.createElement('optgroup');
            suppGroup.label = 'Supplements';
            supplementCareers.forEach(career => {
                const option = document.createElement('option');
                option.value = career;
                option.textContent = career;
                suppGroup.appendChild(option);
            });
            careerSelect.appendChild(suppGroup);
        });

        // Update the saveCharacter function to save careers
        const originalSaveCharacter = saveCharacter;
        
        saveCharacter = function() {
            // Create a character object using the original function's logic
            const character = {
                // Basic info
                charName: document.getElementById('charName').value,
                species: document.getElementById('species').value,
                age: document.getElementById('age').value,
                
                // Get career details
                careers: Array.from(document.getElementById('careers-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        career: cells[0].getAttribute('data-career') || cells[0].textContent,
                        terms: cells[1].getAttribute('data-terms') || cells[1].textContent,
                        rank: cells[2].getAttribute('data-rank') || cells[2].textContent,
                        benefits: cells[3].getAttribute('data-benefits') || cells[3].textContent
                    };
                }).filter(c => c !== null),
                
                // All other characteristics will remain the same
            };
            
            // Store in localStorage
            try {
                localStorage.setItem('traveller-character', JSON.stringify(character));
                alert('Character saved successfully!');
            } catch (e) {
                console.error('Save failed:', e);
                alert('Failed to save character. Error: ' + e.message);
            }
        };
        
        // Update the loadCharacter function to load careers
        const originalLoadCharacter = loadCharacter;
        
        loadCharacter = function() {
            try {
                const savedCharacter = localStorage.getItem('traveller-character');
                if (!savedCharacter) {
                    alert('No saved character found.');
                    return;
                }
                
                const character = JSON.parse(savedCharacter);
                
                // Clear existing careers
                document.getElementById('careers-container').innerHTML = '';
                
                // Load careers if they exist
                if (character.careers && character.careers.length) {
                    character.careers.forEach(careerData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-career="${careerData.career}">${careerData.career}</td>
                            <td data-terms="${careerData.terms}">${careerData.terms}</td>
                            <td data-rank="${careerData.rank}">${careerData.rank}</td>
                            <td data-benefits="${careerData.benefits}">${careerData.benefits}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">×</button>
                            </td>
                        `;
                        document.getElementById('careers-container').appendChild(row);
                    });
                    
                    updateTotalTerms();
                }
                
                // Call the original function to load other data
                originalLoadCharacter();
            } catch (e) {
                console.error('Load failed:', e);
                alert('Failed to load character. Error: ' + e.message);
            }
        };

        // Add the deleteCharacter function
        function deleteCharacter() {
            if (confirm('Are you sure you want to delete your saved character? This cannot be undone.')) {
                try {
                    localStorage.removeItem('traveller-character');
                    alert('Character deleted successfully from storage.');
                } catch (e) {
                    console.error('Delete failed:', e);
                    alert('Failed to delete character. Error: ' + e.message);
                }
            }
        }
    </script>
</body>
</html>
