<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller 2nd Edition Character Sheet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Google Fonts for Traveller-like typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arsenal:wght@400;700&family=Marcellus&family=Roboto:wght@400;500;700&family=Arimo:wght@400;500;700&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode (only mode now) */
            --traveller-primary: #111111;    /* Deep Black for backgrounds, headers, footers */
            --traveller-secondary: #F0F0F0;  /* Light Grey for text and content background */
            --traveller-tertiary: #BB0000;   /* Traveller Red for highlights, call to actions */
            --traveller-supporting: #888888; /* Neutral Grey for supporting elements */
            --traveller-text-on-dark: #FFFFFF; /* White text for dark backgrounds */
            --traveller-text-on-light: #333333; /* Dark text for light backgrounds */
            --traveller-border: #DDDDDD;
            --traveller-content-bg: #FFFFFF;
            --traveller-input-bg: #FFFFFF;
            --traveller-input-border: #CED4DA;
            --traveller-characteristic-box-bg: #F0F0F0;
            --traveller-table-bg: #FFFFFF;
            --traveller-table-border: #DEE2E6;
            --traveller-table-header-bg: rgba(17, 17, 17, 0.1);
            
            /* Font families */
            --font-headlines: 'Arsenal', sans-serif;
            --font-titles: 'Marcellus', serif;
            --font-ui: 'Roboto', sans-serif;
            --font-standard: 'Arimo', sans-serif;
            --font-secondary: 'Work Sans', sans-serif;
        }
        
        body {
            background-color: var(--traveller-secondary);
            font-family: var(--font-standard);
            color: var(--traveller-text-on-light);
            transition: background-color 0.3s ease;
        }
        
        .character-sheet {
            max-width: 1200px;
            margin: 20px auto;
            background-color: var(--traveller-content-bg);
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
            border-radius: 3px;
            position: relative;
            border: 1px solid var(--traveller-border);
            transition: all 0.3s ease;
        }
        
        .characteristic-box {
            border: 2px solid var(--traveller-primary);
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            background-color: var(--traveller-characteristic-box-bg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* Rest of your existing CSS remains the same, the theme variables will apply automatically */
        
        .sheet-header {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            padding: 20px 15px;
            margin-bottom: 25px;
            border-radius: 3px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .sheet-header h1 {
            margin: 0;
            font-family: var(--font-titles);
            font-weight: 400;
            font-size: 2.2rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0px 2px 2px rgba(0, 0, 0, 0.3);
        }
        
        .sheet-header::after {
            content: "";
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 6px;
            background-color: var(--traveller-tertiary);
        }
        
        /* Optional starburst/logo effect */
        .sheet-header::before {
            content: "";
            position: absolute;
            top: -25px;
            right: -25px;
            width: 150px;
            height: 150px;
            background: radial-gradient(var(--traveller-tertiary) 10%, transparent 65%);
            opacity: 0.5;
            border-radius: 50%;
        }
        
        .section-header {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            padding: 8px 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-radius: 3px;
            font-weight: 700;
            font-family: var(--font-headlines);
            letter-spacing: 0.5px;
            border-left: 4px solid var(--traveller-tertiary);
        }
        
        .skill-item, .equipment-item, .weapon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--traveller-border);
        }
        
        .characteristic-box {
            border: 2px solid var(--traveller-primary);
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            background-color: var(--traveller-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .characteristic-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--traveller-tertiary);
        }
        
        .characteristic-box h4 {
            margin: 0;
            color: var(--traveller-primary);
            font-family: var(--font-headlines);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .characteristic-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--traveller-primary);
            font-family: var(--font-standard);
        }
        
        .characteristic-dm {
            font-size: 1.2rem;
            color: var(--traveller-tertiary);
            font-weight: bold;
            font-family: var(--font-standard);
        }
        
        .important-stat {
            font-weight: bold;
            color: var (--traveller-tertiary);
            font-family: var(--font-headlines);
        }
        
        label.form-label {
            font-weight: 500;
            color: var(--traveller-primary);
            font-family: var(--font-headlines);
        }
        
        /* Button styling */
        .dice-btn {
            background-color: var(--traveller-primary);
            color: var(--traveller-text-on-dark);
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .dice-btn:hover {
            background-color: var(--traveller-tertiary);
        
        .dice-btn:hover {
            background-color: var(--traveller-tertiary);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background-color: var(--traveller-supporting);
            border-color: var(--traveller-supporting);
            color: var(--traveller-text-on-dark);
            font-family: var(--font-ui);
            font-weight: 500;
        .btn-secondary:hover {
            background-color: var(--traveller-tertiary);
            border-color: var(--traveller-tertiary);
        }
        
        .btn-info {
            background-color: var(--traveller-supporting);
            border-color: var(--traveller-supporting);
            color: var (--traveller-text-on-dark);
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-info:hover {
            background-color: var (--traveller-tertiary);
            border-color: var(--traveller-tertiary);
        }
        
        .btn-danger {
            background-color: var(--traveller-tertiary);
            border-color: var(--traveller-tertiary);
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-add {
            background-color: var(--traveller-tertiary);  /* Changed to red */
            color: var(--traveller-text-on-dark);
            border: none;
            font-family: var(--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-add:hover {
            background-color: #000000;  /* Changed to black */
            color: var(--traveller-text-on-dark);
        }
        
        .btn-remove {
            background-color: var(--traveller-tertiary);
            color: var (--traveller-text-on-dark);
            border: none;
            padding: 2px 8px;
            font-size: 0.8rem;
            border-radius: 3px;
            font-family: var (--font-ui);
            font-weight: 500;
            letter-spacing: 0.25px;
        }
        
        .btn-remove:hover {
            background-color: #700000;
        }
        
        table thead th {
            background-color: rgba(17, 17, 17, 0.1); /* Semitransparent primary */
            color: var(--traveller-primary);
            font-family: var(--font-headlines);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .skill-name {
            font-weight: 600;
            color: var(--traveller-primary);
            font-family: var(--font-standard);
        }
        
        .skill-specialization {
            font-style: italic;
            color: var(--traveller-supporting);
            margin-left: 3px;
            font-family: var(--font-secondary);
            font-weight: 400;
        }
        
        #specializationField {
            max-width: 150px;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            
            body {
                background-color: white;
            }
            
            .character-sheet {
                box-shadow: none;
                margin: 0;
                padding: 10px;
            }
        }

        .credits {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--traveller-supporting);
            font-family: var(--font-secondary);
        }
        
        #roll-result {
            font-weight: bold;
            font-size: 1.2rem;
            min-height: 30px;
            margin-top: 10px;
            text-align: center;
            font-family: var (--font-ui);
            color: var(--traveller-tertiary);
        }

        /* Improved focus styles for accessibility */
        input:focus, select:focus, textarea:focus, button:focus {
            outline: 2px solid var(--traveller-tertiary);
            box-shadow: 0 0 0 2px rgba(187, 0, 0, 0.25);
        }
        
        /* Custom scrollbar to match theme */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--traveller-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--traveller-supporting);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--traveller-tertiary);
        }
    </style>
</head>
<body>
    <div class="container character-sheet">
        <div class="sheet-header">
            <h1>TRAVELLER 2ND EDITION</h1>
        </div>
        
        <!-- Character Information -->
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="charName" class="form-label">Character Name</label>
                <input type="text" class="form-control" id="charName">
            </div>
            <div class="col-md-4 mb-3">
                <label for="species" class="form-label">Species</label>
                <input type="text" class="form-control" id="species" value="Human">
            </div>
            <div class="col-md-4 mb-3">
                <label for="age" class="form-label">Age</label>
                <input type="number" class="form-control" id="age" value="18">
            </div>
        </div>
        
        <!-- Pre-Career Education Section -->
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="section-header">
                    PRE-CAREER EDUCATION
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Years</th>
                                <th>Qualification</th>
                                <th>Skills Gained</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="education-container">
                            <!-- Education entries will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="row mb-3 no-print">
                    <div class="col-md-12">
                        <div class="input-group">
                            <select class="form-control" id="educationType">
                                <option value="">Select Education Type...</option>
                                <option value="University">University</option>
                                <option value="Military Academy">Military Academy</option>
                                <option value="Technical College">Technical College</option>
                                <option value="Trade School">Trade School</option>
                                <option value="Apprenticeship">Apprenticeship</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="number" class="form-control" id="educationYears" placeholder="Years" min="1" value="4" style="max-width: 80px;">
                            <input type="text" class="form-control" id="educationQualification" placeholder="Qualification/Degree">
                            <input type="text" class="form-control" id="educationSkills" placeholder="Skills Gained">
                            <button class="btn btn-add" onclick="addEducation()">Add Education</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="section-header">
                    CAREER HISTORY
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Career</th>
                                <th>Assignment</th>
                                <th>Terms</th>
                                <th>Rank & Title</th>
                                <th>Benefits</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="careers-container">
                            <!-- Careers will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="row mb-3 no-print">
                    <div class="col-md-12">
                        <div class="input-group">
                            <select class="form-control" id="careerName" onchange="updateAssignments()">
                                <option value="">Select Career...</option>
                                <!-- Career options will be populated by JavaScript -->
                            </select>
                            <select class="form-control" id="careerAssignment">
                                <option value="">Select Assignment...</option>
                                <!-- Assignments will be populated based on career -->
                            </select>
                            <input type="number" class="form-control" id="careerTerms" placeholder="Terms" min="1" value="1" style="max-width: 100px;" onchange="suggestRank()">
                            <input type="text" class="form-control" id="careerRank" placeholder="Rank & Title">
                            <button class="btn btn-info" type="button" onclick="suggestRank()" style="max-width: 40px;">
                                <i class="fa fa-sync">â†»</i>
                            </button>
                            <input type="text" class="form-control" id="careerBenefits" placeholder="Benefits">
                            <button class="btn btn-add" onclick="addCareer()">Add Career</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Characteristics Section -->
        <div class="section-header">
            CHARACTERISTICS
        </div>

        <div class="row">
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>STR</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="str" value="7" min="0" max="15" oninput="updateDM('str')">
                    <span class="characteristic-dm" id="str-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>DEX</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="dex" value="7" min="0" max="15" oninput="updateDM('dex')">
                    <span class="characteristic-dm" id="dex-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>END</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="end" value="7" min="0" max="15" oninput="updateDM('end')">
                    <span class="characteristic-dm" id="end-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>INT</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="int" value="7" min="0" max="15" oninput="updateDM('int')">
                    <span class="characteristic-dm" id="int-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>EDU</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="edu" value="7" min="0" max="15" oninput="updateDM('edu')">
                    <span class="characteristic-dm" id="edu-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="characteristic-box">
                    <h4>SOC</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="soc" value="7" min="0" max="15" oninput="updateDM('soc')">
                    <span class="characteristic-dm" id="soc-dm">-1</span>
                </div>
            </div>
        </div>

        <!-- Additional Characteristics Section (replacing Secondary Characteristics) -->
        <div class="section-header mt-4">
            ADDITIONAL CHARACTERISTICS
        </div>
        
        <div class="row">
            <div class="col-md-2 mb-3">
                <div class="characteristic-box">
                    <h4>PSI</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="psi" value="7" min="0" max="15" oninput="updateDM('psi')">
                    <span class="characteristic-dm" id="psi-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="characteristic-box">
                    <h4>Wealth</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="wlt" value="7" min="0" max="15" oninput="updateDM('wlt')">
                    <span class="characteristic-dm" id="wlt-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="characteristic-box">
                    <h4>Luck</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="lck" value="7" min="0" max="15" oninput="updateDM('lck')">
                    <span class="characteristic-dm" id="lck-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="characteristic-box">
                    <h4>Morale</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="mrl" value="7" min="0" max="15" oninput="updateDM('mrl')">
                    <span class="characteristic-dm" id="mrl-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="characteristic-box">
                    <h4>Sanity</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="sty" value="7" min="0" max="15" oninput="updateDM('sty')">
                    <span class="characteristic-dm" id="sty-dm">-1</span>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="characteristic-box">
                    <h4>Standing</h4>
                    <input type="number" class="form-control mb-2 characteristic-value" id="std" value="7" min="0" max="15" oninput="updateDM('std')">
                    <span class="characteristic-dm" id="std-dm">-1</span>
                </div>
            </div>
        </div>

        <!-- Skills Section -->
        <div class="section-header">
            SKILLS
        </div>
        
        <div class="row skill-search no-print">
            <div class="col-md-10 mb-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="skillSearch" placeholder="Skill name...">
                    <input type="text" class="form-control" id="specializationField" placeholder="Specialization (optional)">
                    <input type="number" class="form-control" id="skillLevel" placeholder="Level" min="0" value="0" style="max-width: 80px;">
                    <button class="btn btn-add" onclick="addSkill()">Add</button>
                </div>
            </div>
        </div>
        
        <div id="skills-container">
            <!-- Skills will be added here by JavaScript -->
        </div>

        <!-- Weapons Section -->
        <div class="section-header">
            WEAPONS & ATTACKS
        </div>
        
        <div class="row mb-3 no-print">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" class="form-control" id="weaponName" placeholder="Weapon Name">
                    <input type="text" class="form-control" id="weaponDamage" placeholder="Damage" style="max-width: 120px;">
                    <input type="number" class="form-control" id="weaponRange" placeholder="Range" style="max-width: 80px;">
                    <button class="btn btn-add" onclick="addWeapon()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Weapon</th>
                        <th>Skill</th>
                        <th>Damage</th>
                        <th>Range</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="weapons-container">
                    <!-- Weapons will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Armor Section -->
        <div class="section-header">
            ARMOR
        </div>
        
        <div class="row mb-3 no-print">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" class="form-control" id="armorName" placeholder="Armor Name">
                    <input type="number" class="form-control" id="armorRating" placeholder="Rating" style="max-width: 100px;" min="0">
                    <input type="text" class="form-control" id="armorTL" placeholder="TL" style="max-width: 60px;">
                    <input type="text" class="form-control" id="armorRadiation" placeholder="Rad" style="max-width: 60px;">
                    <button class="btn btn-add" onclick="addArmor()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Armor</th>
                        <th>Rating</th>
                        <th>TL</th>
                        <th>Rad</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="armor-container">
                    <!-- Armor will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Equipment Section -->
        <div class="section-header">
            EQUIPMENT
        </div>
        
        <div class="row mb-3 no-print">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" class="form-control" id="equipmentName" placeholder="Equipment Name">
                    <input type="text" class="form-control" id="equipmentTL" placeholder="TL" style="max-width: 60px;">
                    <input type="number" class="form-control" id="equipmentMass" placeholder="Mass" style="max-width: 80px;" step="0.1">
                    <input type="number" class="form-control" id="equipmentCost" placeholder="Cost" style="max-width: 100px;">
                    <button class="btn btn-add" onclick="addEquipment()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Equipment</th>
                        <th>TL</th>
                        <th>Mass</th>
                        <th>Cost (Cr)</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="equipment-container">
                    <!-- Equipment will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Finances -->
        <div class="section-header">
            FINANCES
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="credits" class="form-label">Credits</label>
                <div class="input-group">
                    <span class="input-group-text">Cr</span>
                    <input type="number" class="form-control" id="credits" value="0">
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="pension" class="form-label">Pension</label>
                <div class="input-group">
                    <span class="input-group-text">Cr</span>
                    <input type="number" class="form-control" id="pension" value="0">
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="debt" class="form-label">Debt</label>
                <div class="input-group">
                    <span class="input-group-text">Cr</span>
                    <input type="number" class="form-control" id="debt" value="0">
                </div>
            </div>
        </div>

        <!-- Dice Roller -->
        <div class="section-header no-print">
            DICE ROLLER
        </div>
        
        <div class="row no-print">
            <div class="col-md-12 text-center mb-3">
                <button class="btn dice-btn" onclick="rollDice(2, 6)">Roll 2D</button>
                <button class="btn dice-btn" onclick="rollTask(8)">Task (8+)</button>
                <button class="btn dice-btn" onclick="rollTask(10)">Hard Task (10+)</button>
                <button class="btn dice-btn" onclick="rollTask(12)">Formidable (12+)</button>
                <button class="btn dice-btn" onclick="rollTask(14)">Impossible (14+)</button>
                <div id="roll-result"></div>
            </div>
        </div>

        <!-- Notes -->
        <div class="section-header">
            NOTES
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <textarea class="form-control" id="notes" rows="5"></textarea>
            </div>
        </div>

        <!-- Print Button -->
        <div class="row no-print">
            <div class="col-md-12 text-center">
                <button class="btn dice-btn" onclick="window.print()">Print Character Sheet</button>
                <button class="btn btn-secondary" onclick="saveCharacter()">Save Character</button>
                <button class="btn btn-secondary" onclick="loadCharacter()">Load Character</button>
                <button class="btn btn-danger" onclick="resetCharacter()">Reset Sheet</button>
                <button class="btn btn-info" onclick="exportCharacter()">Export Character</button>
                <button class="btn btn-info" onclick="importCharacter()">Import Character</button>
                <button class="btn btn-danger" onclick="deleteCharacter()">Delete Saved Character</button>
            </div>
        </div>
        
        <div class="credits">
            Traveller is a registered trademark of Far Future Enterprises. This character sheet is unofficial and for personal use only.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Common Traveller Skills and data definitions
        const commonSkills = [
            "Admin", "Advocate", "Animals", "Art", "Athletics", "Astrogation", "Battle Dress",
            "Broker", "Carouse", "Deception", "Diplomat", "Drive", "Electronics", "Engineer",
            "Explosives", "Flyer", "Gambler", "Gun Combat", "Gunner", "Heavy Weapons", "Investigate",
            "Jack of all Trades", "Language", "Leadership", "Mechanic", "Medic", "Melee", "Navigation",
            "Persuade", "Pilot", "Profession", "Recon", "Science", "Seafarer", "Stealth", "Steward",
            "Streetwise", "Survival", "Tactics", "Vacc Suit"
        ];

        // Skills that require adding all specializations when one is learned
        const skillsWithMandatorySpecializations = [
            "Athletics", "Drive", "Flyer", "Gunner", "Heavy Weapons", 
            "Melee", "Pilot", "Seafarer"
        ];

        // Common specializations for skills
        const skillSpecializations = {
            "Animals": ["Handling", "Training", "Veterinary"],
            "Art": ["Performer", "Holography", "Instrument", "Visual Media", "Write"],
            "Athletics": ["Dexterity", "Endurance", "Strength"],
            "Drive": ["Hovercraft", "Mole", "Tracked", "Walker", "Wheeled"],
            "Electronics": ["Comms", "Computers", "Remote Ops", "Sensors"],
            "Engineer": ["J-Drive", "Life Support", "M-Drive", "Power"],
            "Flyer": ["Airship", "Grav", "Ornithopter", "Rotor", "Wing"],
            "Gun Combat": ["Archaic", "Energy", "Slug"],
            "Gunner": ["Capital", "Ortillery", "Screen", "Turret"],
            "Heavy Weapons": ["Artillery", "Man Portable", "Vehicle"],
            "Language": ["Anglic", "Aslan", "Vargr", "Vilani", "Zdetl", "Oynprith", "Other"],
            "Mechanic": ["Aircraft", "Gravitics", "Mole", "Walker", "Wheeled"],
            "Melee": ["Blade", "Bludgeon", "Natural", "Unarmed"],
            "Pilot": ["Capital Ships", "Small Craft", "Spacecraft"],
            "Profession": ["Belter", "Biologicals", "Civil Engineering", "Construction", "Hydroponics", "Polymers"],
            "Science": ["Archaeology", "Astronomy", "Biology", "Chemistry", "Cosmology", "Cybernetics", "Economics", "Genetics", "History", "Linguistics", "Mathematics", "Physics", "Political Science", "Psychology", "Physics", "Planetology", "Psionicology", "Robotics", "Sophontology", "Xenology"],
            "Seafarer": ["Ocean Ships", "Personal", "Sail", "Submarine"],
            "Tactics": ["Military", "Naval"]
        };

        // Career data structure with assignment-specific rank structures and discipline level
        const careerData = {
            "Agent (1)": {
                discipline: 0.5,  // Disciplined non-military
                assignments: {
                    "Law Enforcement": {
                        ranks: [
                            { title: "Rookie", level: 0 },
                            { title: "Corporal", level: 1 },
                            { title: "Sergeant", level: 2 },
                            { title: "Detective", level: 3 },
                            { title: "Lieutenant", level: 4 },
                            { title: "Chief", level: 5 },
                            { title: "Commissioner", level: 6 }
                        ]
                    },
                    "Intelligence": {
                        ranks: [
                            { title: " - ", level: 0 },
                            { title: "Agent", level: 1 },
                            { title: "Field Agent", level: 2 },
                            { title: "Field Agent", level: 3 },
                            { title: "Special Agent Director", level: 4 },
                            { title: "Assistant Director", level: 5 },
                            { title: "Director", level: 6 }
                        ]
                    },
                    "Corporate": {
                        ranks: [
                            { title: " - ", level: 0 },
                            { title: "Agent", level: 1 },
                            { title: "Field Agent", level: 2 },
                            { title: "Field Agent", level: 3 },
                            { title: "Special Agent Director", level: 4 },
                            { title: "Assistant Director", level: 5 },
                            { title: "Director", level: 6 }
                        ]
                    }
                }
            },
            "Army (2)": {
                discipline: 1.0,  // Military
                assignments: {
                    "Support": {
                        ranks: [
                            { title: "Private", level: 0 },
                            { title: "Lance Corporal", level: 1 },
                            { title: "Corporal", level: 2 },
                            { title: "Lance Sergeant", level: 3 },
                            { title: "Sergeant", level: 4 },
                            { title: "Gunnery Sergeant", level: 5 },
                            { title: "Sergeant Major", level: 6 }
                        ]
                    },
                    "Infantry": {
                        ranks: [
                            { title: "Private", level: 0 },
                            { title: "Lance Corporal", level: 1 },
                            { title: "Corporal", level: 2 },
                            { title: "Lance Sergeant", level: 3 },
                            { title: "Sergeant", level: 4 },
                            { title: "Gunnery Sergeant", level: 5 },
                            { title: "Sergeant Major", level: 6 }
                        ]
                    },
                    "Cavalry": {
                        ranks: [
                            { title: "Private", level: 0 },
                            { title: "Lance Corporal", level: 1 },
                            { title: "Corporal", level: 2 },
                            { title: "Lance Sergeant", level: 3 },
                            { title: "Sergeant", level: 4 },
                            { title: "Gunnery Sergeant", level: 5 },
                            { title: "Sergeant Major", level: 6 }
                        ]
                    },
                    "Support Officer": {
                            ranks: [
                                { title: "Lieutenant", level: 1 },
                                { title: "Captain", level: 2 },
                                { title: "Major", level: 3 },
                                { title: "Lieutenant Colonel", level: 4 },
                                { title: "Colonel", level: 5 },
                                { title: "General", level: 6 }
                            ]
                        },
                        "Infantry Officer": {
                            ranks: [
                                { title: "Lieutenant", level: 1 },
                                { title: "Captain", level: 2 },
                                { title: "Major", level: 3 },
                                { title: "Lieutenant Colonel", level: 4 },
                                { title: "Colonel", level: 5 },
                                { title: "General", level: 6 }
                            ]
                        },
                        "Cavalry Officer": {
                            ranks: [
                                { title: "Lieutenant", level: 1 },
                                { title: "Captain", level: 2 },
                                { title: "Major", level: 3 },
                                { title: "Lieutenant Colonel", level: 4 },
                                { title: "Colonel", level: 5 },
                                { title: "General", level: 6 }
                            ]




                    }
                }
            },
            "Citizen (3)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Corporate": {
                        ranks: [
                            { title: "Intern", level: 0 },
                            { title: "Junior Associate", level: 1 },
                            { title: "Associate", level: 2 },
                            { title: "Manager", level: 3 },
                            { title: "Director", level: 4 },
                            { title: "Vice President", level: 5 },
                            { title: "CEO", level: 6 }
                        ]
                    },
                    "Worker": {
                        ranks: [
                            { title: "Apprentice", level: 0 },
                            { title: "Journeyman", level: 1 },
                            { title: "Professional", level: 2 },
                            { title: "Master", level: 3 },
                            { title: "Expert", level: 4 },
                            { title: "Union Representative", level: 5 },
                            { title: "Union Leader", level: 6 }
                        ]
                    },
                    "Colonist": {
                        ranks: [
                            { title: "Settler", level: 0 },
                            { title: "Colonist", level: 1 },
                            { title: "Specialist", level: 2 },
                            { title: "Colony Coordinator", level: 3 },
                            { title: "Colony Leader", level: 4 },
                            { title: "Colony Governor", level: 5 },
                            { title: "Planetary Governor", level: 6 }
                        ]
                    }
                }
            },
            "Drifter (4)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Barbarian": {
                        ranks: [
                            { title: "Outcast", level: 0 },
                            { title: "Warrior", level: 1 },
                            { title: "Weapon Master", level: 2 },
                            { title: "Champion", level: 3 },
                            { title: "Chieftain", level: 4 },
                            { title: "Warlord", level: 5 },
                            { title: "Tribal King", level: 6 }
                        ]
                    },
                    "Wanderer": {
                        ranks: [
                            { title: "Drifter", level: 0 },
                            { title: "Wanderer", level: 1 },
                            { title: "Explorer", level: 2 },
                            { title: "Guide", level: 3 },
                            { title: "Pathfinder", level: 4 },
                            { title: "Nomad Leader", level: 5 },
                            { title: "Nomad Chief", level: 6 }
                        ]
                    },
                    "Scavenger": {
                        ranks: [
                            { title: "Scrounger", level: 0 },
                            { title: "Scavenger", level: 1 },
                            { title: "Salvager", level: 2 },
                            { title: "Recovery Expert", level: 3 },
                            { title: "Salvage Master", level: 4 },
                            { title: "Recovery Operations Chief", level: 5 },
                            { title: "Salvage Fleet Commander", level: 6 }
                        ]
                    }
                }
            },
            "Entertainer (5)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Artist": {
                        ranks: [
                            { title: "Student", level: 0 },
                            { title: "Apprentice", level: 1 },
                            { title: "Professional", level: 2 },
                            { title: "Recognized Artist", level: 3 },
                            { title: "Famous Artist", level: 4 },
                            { title: "Master Artist", level: 5 },
                            { title: "Legendary Artist", level: 6 }
                        ]
                    },
                    "Journalist": {
                        ranks: [
                            { title: "Intern", level: 0 },
                            { title: "Junior Reporter", level: 1 },
                            { title: "Reporter", level: 2 },
                            { title: "Correspondent", level: 3 },
                            { title: "Editor", level: 4 },
                            { title: "Senior Editor", level: 5 },
                            { title: "Editor in Chief", level: 6 }
                        ]
                    },
                    "Performer": {
                        ranks: [
                            { title: "Extra", level: 0 },
                            { title: "Featured Performer", level: 1 },
                            { title: "Supporting Cast", level: 2 },
                            { title: "Lead Performer", level: 3 },
                            { title: "Star", level: 4 },
                            { title: "Famous Star", level: 5 },
                            { title: "Legendary Performer", level: 6 }
                        ]
                    }
                }
            },
            "Marine (6)": {
                discipline: 1.0,  // Military
                assignments: {
                    "Support": {
                        ranks: [
                            { title: "Marine", level: 0 },
                            { title: "Corporal", level: 1 },
                            { title: "Sergeant", level: 2 },
                            { title: "Gunnery Sergeant", level: 3 },
                            { title: "Sergeant Major", level: 4 },
                            { title: "Lieutenant", level: 5 },
                            { title: "Captain", level: 6 }
                        ]
                    },
                    "Star Marine": {
                        ranks: [
                            { title: "Star Marine", level: 0 },
                            { title: "Lieutenant", level: 1 },
                            { title: "Captain", level: 2 },
                            { title: "Force Commander", level: 3 },
                            { title: "Lt Colonel", level: 4 },
                            { title: "Colonel", level: 5 },
                            { title: "Brigadier", level: 6 }
                        ]
                    },
                    "Ground Assault": {
                        ranks: [
                            { title: "Assault Trooper", level: 0 },
                            { title: "Assault Leader", level: 1 },
                            { title: "Strike Commander", level: 2 },
                            { title: "Assault Commander", level: 3 },
                            { title: "Strike Colonel", level: 4 },
                            { title: "Assault Colonel", level: 5 },
                            { title: "Assault General", level: 6 }
                        ]
                    }
                }
            },
            "Merchant (7)": {
                discipline: 0.5,  // Disciplined non-military
                assignments: {
                    "Merchant Marine": {
                        ranks: [
                            { title: "Crewman", level: 0 },
                            { title: "Fourth Officer", level: 1 },
                            { title: "Third Officer", level: 2 },
                            { title: "Second Officer", level: 3 },
                            { title: "First Officer", level: 4 },
                            { title: "Captain", level: 5 },
                            { title: "Fleet Captain", level: 6 }
                        ]
                    },
                    "Free Trader": {
                        ranks: [
                            { title: "Trader", level: 0 },
                            { title: "Senior Trader", level: 1 },
                            { title: "Independent Merchant", level: 2 },
                            { title: "Ship Owner", level: 3 },
                            { title: "Fleet Owner", level: 4 },
                            { title: "Merchant Prince", level: 5 },
                            { title: "Trade Magnate", level: 6 }
                        ]
                    },
                    "Broker": {
                        ranks: [
                            { title: "Apprentice", level: 0 },
                            { title: "Broker", level: 1 },
                            { title: "Senior Broker", level: 2 },
                            { title: "Deal-Maker", level: 3 },
                            { title: "Master Broker", level: 4 },
                            { title: "Trade Consortium Leader", level: 5 },
                            { title: "Merchant Guild Master", level: 6 }
                        ]
                    }
                }
            },
            "Navy (8)": {
                discipline: 1.0,  // Military
                assignments: {
                    "Line/Crew": {
                        ranks: [
                            { title: "Crewman", level: 0 },
                            { title: "Ensign", level: 1 },
                            { title: "Lieutenant", level: 2 },
                            { title: "Lt Commander", level: 3 },
                            { title: "Commander", level: 4 },
                            { title: "Captain", level: 5 },
                            { title: "Admiral", level: 6 }
                        ]
                    },
                    "Engineering": {
                        ranks: [
                            { title: "Engineer's Mate", level: 0 },
                            { title: "Junior Engineer", level: 1 },
                            { title: "Engineer", level: 2 },
                            { title: "Senior Engineer", level: 3 },
                            { title: "Chief Engineer", level: 4 },
                            { title: "Fleet Engineer", level: 5 },
                            { title: "Engineering Admiral", level: 6 }
                        ]
                    },
                    "Flight": {
                        ranks: [
                            { title: "Flight Cadet", level: 0 },
                            { title: "Flight Ensign", level: 1 },
                            { title: "Flight Lieutenant", level: 2 },
                            { title: "Flight Commander", level: 3 },
                            { title: "Wing Commander", level: 4 },
                            { title: "Air Group Commander", level: 5 },
                            { title: "Fleet Air Marshal", level: 6 }
                        ]
                    }
                }
            },
            "Scout (12)": {
                discipline: 0.5,  // Disciplined non-military
                assignments: {
                    "Courier": {
                        ranks: [
                            { title: "Courier", level: 0 },
                            { title: "Senior Courier", level: 1 },
                            { title: "Relay Operator", level: 2 },
                            { title: "Relay Supervisor", level: 3 },
                            { title: "Courier Chief", level: 4 },
                            { title: "Courier Director", level: 5 },
                            { title: "XBoat Network Commander", level: 6 }
                        ]
                    },
                    "Surveyor": {
                        ranks: [
                            { title: "Survey Technician", level: 0 },
                            { title: "Surveyor", level: 1 },
                            { title: "Senior Surveyor", level: 2 },
                            { title: "Survey Leader", level: 3 },
                            { title: "Lead Surveyor", level: 4 },
                            { title: "Senior Survey Director", level: 5 },
                            { title: "Head of Survey Operations", level: 6 }
                        ]
                    },
                    "Explorer": {
                        ranks: [
                            { title: "Scout", level: 0 },
                            { title: "Scout Explorer", level: 1 },
                            { title: "Senior Scout", level: 2 },
                            { title: "Lead Explorer", level: 3 },
                            { title: "Exploration Director", level: 4 },
                            { title: "Senior Scout Director", level: 5 },
                            { title: "Scout Commander", level: 6 }
                        ]
                    }
                }
            },
            "Truther (14)": {
                discipline: 0.0,  // Other - not formally disciplined
                assignments: {
                    "Truther": {
                        ranks: [
                            { title: "Harmless Crank", level: 0 },
                            { title: "Typical minor truther", level: 1 },
                            { title: "Noteable Figure", level: 2 },
                            { title: "Highly Influential Truther", level: 3 },
                            { title: "Legend or Public menace", level: 4 }
                        ]
                    }
                }
            },
            "Believer (15)": {
                discipline: 0.5,  // Disciplined non-military (religious orders)
                assignments: {
                    "Mainstream Believer": {
                        ranks: [
                            { title: "Lay Person", level: 0 },
                            { title: "Initiate ", level: 1 },
                            { title: "Lay Preacher", level: 2 },
                            { title: "Priest/Priestess", level: 3 },
                            { title: "Senior Priest/Priestess", level: 4 },
                            { title: "Bishop", level: 5 },
                            { title: "Archbishop", level: 6 }
                        ]
                    },
                    "Missionary/Humanitarian": {
                        ranks: [
                            { title: "Junior Project Worker", level: 0 },
                            { title: "Project Worker", level: 1 },
                            { title: "Team Leader", level: 2 },
                            { title: "Project Leader", level: 3 },
                            { title: "Project Coordinator", level: 4 },
                            { title: "Department Director", level: 5 },
                            { title: "Director", level: 6 }
                        ]
                    },
                    "Holy Warrior": {
                        ranks: [
                            { title: "Hopeful", level: 0 },
                            { title: "Fighter", level: 1 },
                            { title: "Combat Leader", level: 2 },
                            { title: "Force Commander", level: 3 },
                            { title: "Area Commander", level: 4 },
                            { title: "Movement Sub-Leader", level: 5 },
                            { title: "Movement Leader", level: 6 }
                        ]
                    }
                }
            },
            "Noble (9)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Administrator": {
                        ranks: [
                            { title: "Courtier", level: 0 },
                            { title: "Administrator", level: 1 },
                            { title: "Minister", level: 2 },
                            { title: "Advisor", level: 3 },
                            { title: "High Advisor", level: 4 },
                            { title: "Planetary Governor", level: 5 },
                            { title: "Sector Governor", level: 6 }
                        ]
                    },
                    "Diplomat": {
                        ranks: [
                            { title: "AttachÃ©", level: 0 },
                            { title: "Diplomat", level: 1 },
                            { title: "Consul", level: 2 },
                            { title: "Ambassador", level: 3 },
                            { title: "High Ambassador", level: 4 },
                            { title: "Plenipotentiary", level: 5 },
                            { title: "Imperial Legate", level: 6 }
                        ]
                    },
                    "Dilettante": {
                        ranks: [
                            { title: "Wastrel", level: 0 },
                            { title: "IngÃ©nue", level: 1 },
                            { title: "Socialite", level: 2 },
                            { title: "Minor Noble", level: 3 },
                            { title: "Prominent Noble", level: 4 },
                            { title: "High Noble", level: 5 },
                            { title: "Imperial Peer", level: 6 }
                        ]
                    }
                }
            },
            
            "Rogue (10)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Thief": {
                        ranks: [
                            { title: "Pickpocket", level: 0 },
                            { title: "Burglar", level: 1 },
                            { title: "Skilled Thief", level: 2 },
                            { title: "Master Thief", level: 3 },
                            { title: "Heist Planner", level: 4 },
                            { title: "Master Planner", level: 5 },
                            { title: "Legendary Thief", level: 6 }
                        ]
                    },
                    "Enforcer": {
                        ranks: [
                            { title: "Thug", level: 0 },
                            { title: "Bodyguard", level: 1 },
                            { title: "Enforcer", level: 2 },
                            { title: "Lieutenant", level: 3 },
                            { title: "Underboss", level: 4 },
                            { title: "Consigliere", level: 5 },
                            { title: "Boss", level: 6 }
                        ]
                    },
                    "Corsair": {
                        ranks: [
                            { title: "Pirate", level: 0 },
                            { title: "Experienced Pirate", level: 1 },
                            { title: "Leading Hand", level: 2 },
                            { title: "Ship's Master", level: 3 },
                            { title: "Notorious Captain", level: 4 },
                            { title: "Pirate Lord", level: 5 },
                            { title: "Pirate King", level: 6 }
                        ]
                    }
                }
            },
            
            "Scholar (11)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Researcher": {
                        ranks: [
                            { title: "Research Assistant", level: 0 },
                            { title: "Junior Researcher", level: 1 },
                            { title: "Researcher", level: 2 },
                            { title: "Senior Researcher", level: 3 },
                            { title: "Assistant Professor", level: 4 },
                            { title: "Associate Professor", level: 5 },
                            { title: "Professor", level: 6 }
                        ]
                    },
                    "Field Researcher": {
                        ranks: [
                            { title: "Field Assistant", level: 0 },
                            { title: "Field Researcher", level: 1 },
                            { title: "Experienced Researcher", level: 2 },
                            { title: "Senior Researcher", level: 3 },
                            { title: "Lead Researcher", level: 4 },
                            { title: "Research Director", level: 5 },
                            { title: "World-Renowned Expert", level: 6 }
                        ]
                    }
                }
            },
            "Prisoner (13)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Inmate": {
                        ranks: [
                            { title: "-", level: 0 },
                            { title: "-", level: 1 },
                            { title: "-", level: 2 },
                            { title: "-", level: 3 },
                            { title: "-", level: 4 },
                            { title: "-", level: 5 },
                            { title: "-", level: 6 }
                        ]
                    },
                    "Thug": {
                        ranks: [
                            { title: "-", level: 0 },
                            { title: "-", level: 1 },
                            { title: "-", level: 2 },
                            { title: "-", level: 3 },
                            { title: "-", level: 4 },
                            { title: "-", level: 5 },
                            { title: "-", level: 6 }
                        ]
                    },
                    "Fixer": {
                        ranks: [
                            { title: "-", level: 0 },
                            { title: "-", level: 1 },
                            { title: "-", level: 2 },
                            { title: "-", level: 3 },
                            { title: "-", level: 4 },
                            { title: "-", level: 5 },
                            { title: "-", level: 6 }
                        ]
                    }
                }
            },
            "Psionic (X)": {
                discipline: 0.0,  // Other
                assignments: {
                    "Wild Talent": {
                        ranks: [
                            { title: " - ", level: 0 },
                            { title: "Survivor", level: 1 },
                            { title: "Survivor", level: 2 },
                            { title: "Witch", level: 3 },
                            { title: "Witch", level: 4 },
                            { title: "Witch", level: 5 },
                            { title: "Witch", level: 6 }
                        ]
                    },
                    "Adept": {
                        ranks: [
                            { title: " - ", level: 0 },
                            { title: "Initiate", level: 1 },
                            { title: "Initiate", level: 2 },
                            { title: "Acolyte", level: 3 },
                            { title: "Acolyte", level: 4 },
                            { title: "Acolyte", level: 5 },
                            { title: "Master", level: 6 }
                        ]
                    },
                    "Psi-Warrior": {
                        ranks: [
                            { title: "Marine", level: 0 },
                            { title: "Marine", level: 1 },
                            { title: "Captain", level: 2 },
                            { title: "Captain", level: 3 },
                            { title: "Captain", level: 4 },
                            { title: "Force Commander", level: 5 },
                            { title: "Force Commander", level: 6 }
                        ]
                    }
                }
            },




        };

        // Also define discipline levels for supplemental careers
        const careerDiscipline = {
            // Military careers (1.0)
            "Aerospace Defense": 1.0,
            
            // Disciplined non-military (0.5)
            "Advocate": 0.5,
            "Diplomat": 0.5,
            "Doctor": 0.5,
            "Technician": 0.5,
            
            // All others (0.0) - just listing a few examples
            "Barbarian": 0.0,
            "Belter": 0.0,
            "Bureaucrat": 0.0,
            "Colony Citizen": 0.0,
            "Corsair": 0.0,
            "Explorer": 0.0,
            "Flyer": 0.0,
            "Hunter": 0.0,
            "Journalist": 0.0,
            "Pirate": 0.0,
            "Prisoner": 0.0,
            "Scientist": 0.0,
            "Spacer": 0.0,
            "Wanderer": 0.0
        };
        
        // Helper function to get discipline level for any career
        function getCareerDiscipline(careerName) {
            if (careerData[careerName] && typeof careerData[careerName].discipline !== 'undefined') {
                return careerData[careerName].discipline;
            } else if (typeof careerDiscipline[careerName] !== 'undefined') {
                return careerDiscipline[careerName];
            } else {
                // Default value for unknown careers
                return 0.0;
            }
        }

        // Generic data for supplemental careers
        const genericRankStructure = [
            { title: "Novice", level: 0 },
            { title: "Apprentice", level: 1 },
            { title: "Journeyman", level: 2 },
            { title: "Expert", level: 3 },
            { title: "Master", level: 4 },
            { title: "Senior Master", level: 5 },
            { title: "Grandmaster", level: 6 }
        ];

        // MGT2 Careers from the rulebook
        const mgt2Careers = [
            "Agent", "Army", "Citizen", "Drifter", "Entertainer", 
            "Marine", "Merchant", "Navy", "Noble", "Rogue", 
            "Scholar", "Scout", "Psionic", "Prisoner", "Truther", "Believer"
        ];
        
        // Additional careers from supplements
        const supplementCareers = [
            "Aerospace Defense", "Advocate", "Barbarian", "Belter", "Bureaucrat",
            "Colony Citizen", "Corsair", "Diplomat", "Doctor", "Explorer", 
            "Flyer", "Hunter", "Journalist", "Pirate", "Prisoner",
            "Scientist", "Spacer", "Technician", "Wanderer"
        ];

        // Define core functions before they are used
        
        // Update the DM (Dice Modifier) based on characteristic value
        function updateDM(stat) {
            const value = parseInt(document.getElementById(stat).value);
            let dm = 0;
            
            if (value === 0) dm = -3;
            else if (value <= 2) dm = -2;
            else if (value <= 5) dm = -1;
            else if (value <= 8) dm = 0;
            else if (value <= 11) dm = 1;
            else if (value <= 14) dm = 2;
            else dm = 3;
            
            document.getElementById(`${stat}-dm`).textContent = dm >= 0 ? `+${dm}` : dm;
        }
        
        // Calculate total years across education and careers
        function updateTotalYears() {
            // First get education years
            const educationRows = document.querySelectorAll('#education-container tr');
            let totalEducationYears = 0;
            
            educationRows.forEach(row => {
                const yearsCell = row.querySelector('td[data-years]');
                if (yearsCell) {
                    totalEducationYears += parseInt(yearsCell.getAttribute('data-years')) || 0;
                }
            });
            
            // Then get career terms
            const careerRows = document.querySelectorAll('#careers-container tr');
            let totalCareerTerms = 0;
            
            careerRows.forEach(row => {
                const termsCell = row.querySelector('td[data-terms]');
                if (termsCell) {
                    totalCareerTerms += parseInt(termsCell.getAttribute('data-terms')) || 0;
                }
            });
            
            // Calculate biological age: base + education years + (career terms * 4)
            if (document.getElementById('age')) {
                // Base age at character creation is 18
                const biologicalAge = 18 + totalEducationYears + (totalCareerTerms * 4);
                document.getElementById('age').value = biologicalAge;
            }
        }
        
        // Calculate total terms across all careers
        function updateTotalTerms() {
            const careerRows = document.querySelectorAll('#careers-container tr');
            let totalTerms = 0;
            
            careerRows.forEach(row => {
                const termsCell = row.querySelector('td[data-terms]');
                if (termsCell) {
                    totalTerms += parseInt(termsCell.getAttribute('data-terms')) || 0;
                }
            });
            
            // Update display of total terms somewhere if needed
            if (document.getElementById('totalTerms')) {
                document.getElementById('totalTerms').textContent = totalTerms;
            }
            
            // Update age including education years
            updateTotalYears();
        }
        
        // Update specialization options based on selected skill
        function updateSpecializationOptions() {
            const skillName = document.getElementById('skillSearch').value;
            const specList = document.getElementById('specialization-list');
            specList.innerHTML = '';  // Clear existing options
            
            if (skillSpecializations[skillName]) {
                skillSpecializations[skillName].forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec;
                    specList.appendChild(option);
                });
            }
        }
        
        // Update assignments dropdown when career is selected
        function updateAssignments() {
            const careerName = document.getElementById('careerName').value;
            const assignmentSelect = document.getElementById('careerAssignment');
            
            console.log("Selected career:", careerName); // Debug line
            
            // Clear current options
            assignmentSelect.innerHTML = '<option value="">Select Assignment...</option>';
            
            // First try exact match
            if (careerData[careerName] && careerData[careerName].assignments) {
                populateAssignments(careerName, assignmentSelect);
            } 
            // Try matching without the parenthesized number
            else {
                // Try to find a matching career name with numbering
                const careerKeys = Object.keys(careerData);
                const matchingCareer = careerKeys.find(key => 
                    key.startsWith(careerName + " (") || key === careerName
                );
                
                console.log("Matching career found:", matchingCareer); // Debug line
                
                if (matchingCareer && careerData[matchingCareer].assignments) {
                    populateAssignments(matchingCareer, assignmentSelect);
                }
            }
            
            // Clear and update rank field
            document.getElementById('careerRank').value = '';
            suggestRank();
        }
        
        // Helper function to populate assignments dropdown
        function populateAssignments(careerKey, selectElement) {
            const assignments = Object.keys(careerData[careerKey].assignments);
            
            assignments.forEach(assignment => {
                const option = document.createElement('option');
                option.value = assignment;
                option.textContent = assignment;
                selectElement.appendChild(option);
            });
            
            console.log(`Added ${assignments.length} assignments for ${careerKey}`); // Debug line
        }
        
        // Suggest rank based on career and terms
        function suggestRank() {
            const careerName = document.getElementById('careerName').value;
            const assignment = document.getElementById('careerAssignment').value;
            const careerTerms = parseInt(document.getElementById('careerTerms').value) || 1;
            const rankField = document.getElementById('careerRank');
            
            // Calculate recommended rank based on terms
            // Each term potentially allows you to advance one rank level
            let rankLevel = Math.min(careerTerms - 1, 6);
            if (rankLevel < 0) rankLevel = 0;
            
            // First try exact career name match
            let careerFound = careerData[careerName];
            
            // If not found, try to match without the parenthesized number
            if (!careerFound) {
                const careerKeys = Object.keys(careerData);
                const matchingCareer = careerKeys.find(key => 
                    key.startsWith(careerName + " (") || key === careerName
                );
                
                if (matchingCareer) {
                    careerFound = careerData[matchingCareer];
                }
            }
            
            // Get proper rank title if available
            if (
                careerFound && 
                careerFound.assignments && 
                assignment && 
                careerFound.assignments[assignment] &&
                careerFound.assignments[assignment].ranks &&
                careerFound.assignments[assignment].ranks[rankLevel]
            ) {
                rankField.value = careerFound.assignments[assignment].ranks[rankLevel].title;
            } else {
                // Use generic rank structure
                rankField.value = genericRankStructure[rankLevel].title;
            }
        }
        
        // Helper functions for skill management
        function getExistingSpecializations(skillName) {
            const existingSkills = document.querySelectorAll('.skill-name');
            const existingSpecs = [];
            
            for (let i = 0; i < existingSkills.length; i++) {
                if (existingSkills[i].getAttribute('data-skill') === skillName) {
                    const spec = existingSkills[i].getAttribute('data-specialization');
                    if (spec) {
                        existingSpecs.push(spec);
                    }
                }
            }
            
            return existingSpecs;
        }
        
        function updateExistingSkill(skillName, specialization, level) {
            const skillItems = document.querySelectorAll('.skill-item');
            
            for (let i = 0; i < skillItems.length; i++) {
                const skillNameElem = skillItems[i].querySelector('.skill-name');
                
                if (skillNameElem.getAttribute('data-skill') === skillName && 
                    skillNameElem.getAttribute('data-specialization') === specialization) {
                    const input = skillItems[i].querySelector('input');
                    input.value = level;
                    return true;
                }
            }
            
            return false;
        }
        
        function addSingleSkill(skillName, specialization, skillLevel) {
            // Check if skill already exists
            const existingSkills = document.querySelectorAll('.skill-name');
            for (let i = 0; i < existingSkills.length; i++) {
                if (existingSkills[i].getAttribute('data-skill') === skillName && 
                    existingSkills[i].getAttribute('data-specialization') === specialization) {
                    
                    // Update existing skill instead of adding duplicate
                    updateExistingSkill(skillName, specialization, skillLevel);
                    return;
                }
            }
            
            const skillsContainer = document.getElementById('skills-container');
            const skillDiv = document.createElement('div');
            skillDiv.className = 'skill-item';
            
            // Store both skill name and specialization separately for data handling
            skillDiv.innerHTML = `
                <span class="skill-name" data-skill="${skillName}" data-specialization="${specialization || ''}">
                    ${skillName}${specialization ? ` <span class="skill-specialization">(${specialization})</span>` : ''}
                </span>
                <div class="d-flex align-items-center">
                    <input type="number" class="form-control form-control-sm mx-2" value="${skillLevel}" min="0" style="width: 60px;">
                    <button class="btn btn-remove no-print" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                </div>
            `;
            
            skillsContainer.appendChild(skillDiv);
        }

        // Modified addSkill function to handle mandatory specializations
        function addSkill() {
            const skillName = document.getElementById('skillSearch').value;
            const specialization = document.getElementById('specializationField').value;
            const skillLevel = document.getElementById('skillLevel').value || 0;
            
            if (!skillName) return;
            
            // Special handling for skills with mandatory specializations
            if (skillsWithMandatorySpecializations.includes(skillName)) {
                if (!specialization && skillSpecializations[skillName]?.length > 0) {
                    alert(`The skill "${skillName}" requires you to select a specialization.`);
                    return;
                }
                
                // Add all specializations at level 0, with the chosen one at the specified level
                const specs = skillSpecializations[skillName] || [];
                if (specs.length > 0) {
                    // First check if any specializations already exist
                    const existingSpecs = getExistingSpecializations(skillName);
                    
                    // If not all specializations exist yet, add all of them
                    if (existingSpecs.length < specs.length) {
                        for (const spec of specs) {
                            if (!existingSpecs.includes(spec)) {
                                // This is the chosen specialization, add it with the specified level
                                if (spec === specialization) {
                                    addSingleSkill(skillName, spec, skillLevel);
                                } else {
                                    // Other specializations are added at level 0
                                    addSingleSkill(skillName, spec, 0);
                                }
                            }
                        }
                        alert(`All specializations for ${skillName} have been added to your character sheet.`);
                        return;
                    } else {
                        // If all specializations already exist, just update the level of the chosen one
                        updateExistingSkill(skillName, specialization, skillLevel);
                        return;
                    }
                }
            }
            
            // Standard skill addition for non-special skills
            addSingleSkill(skillName, specialization, skillLevel);
            
            // Clear inputs
            document.getElementById('skillSearch').value = '';
            document.getElementById('specializationField').value = '';
            document.getElementById('skillLevel').value = 0;
        }

        // Add education to education table
        function addEducation() {
            const educationType = document.getElementById('educationType').value;
            const educationYears = document.getElementById('educationYears').value;
            const educationQualification = document.getElementById('educationQualification').value;
            const educationSkills = document.getElementById('educationSkills').value;
            
            if (!educationType) {
                alert("Please select an education type");
                return;
            }
            
            const educationContainer = document.getElementById('education-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-type="${educationType}">${educationType}</td>
                <td data-years="${educationYears}">${educationYears}</td>
                <td data-qualification="${educationQualification}">${educationQualification}</td>
                <td data-skills="${educationSkills}">${educationSkills}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove(); updateTotalYears();">Ã—</button>
                </td>
            `;
            
            educationContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('educationType').selectedIndex = 0;
            document.getElementById('educationYears').value = '4';
            document.getElementById('educationQualification').value = '';
            document.getElementById('educationSkills').value = '';
            
            // Update age based on education years
            updateTotalYears();
        }
        
        // Add career to the careers table
        function addCareer() {
            const careerName = document.getElementById('careerName').value;
            const careerAssignment = document.getElementById('careerAssignment').value;
            const careerTerms = document.getElementById('careerTerms').value;
            const careerRank = document.getElementById('careerRank').value;
            const careerBenefits = document.getElementById('careerBenefits').value;
            
            if (!careerName) {
                alert("Please select a career");
                return;
            }
            
            const careersContainer = document.getElementById('careers-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-career="${careerName}">${careerName}</td>
                <td data-assignment="${careerAssignment}">${careerAssignment}</td>
                <td data-terms="${careerTerms}">${careerTerms}</td>
                <td data-rank="${careerRank}">${careerRank}</td>
                <td data-benefits="${careerBenefits}">${careerBenefits}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove(); updateTotalYears();">Ã—</button>
                </td>
            `;
            
            careersContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('careerName').selectedIndex = 0;
            document.getElementById('careerAssignment').innerHTML = '<option value="">Select Assignment...</option>';
            document.getElementById('careerTerms').value = '1';
            document.getElementById('careerRank').value = '';
            document.getElementById('careerBenefits').value = '';
            
            // Update total terms
            updateTotalTerms();
        }
        
        // Add armor to the armor table
        function addArmor() {
            const armorName = document.getElementById('armorName').value;
            const armorRating = document.getElementById('armorRating').value;
            const armorTL = document.getElementById('armorTL').value;
            const armorRadiation = document.getElementById('armorRadiation').value;
            
            if (!armorName) return;
            
            const armorContainer = document.getElementById('armor-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${armorName}</td>
                <td>${armorRating}</td>
                <td>${armorTL}</td>
                <td>${armorRadiation}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">Ã—</button>
                </td>
            `;
            
            armorContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('armorName').value = '';
            document.getElementById('armorRating').value = '';
            document.getElementById('armorTL').value = '';
            document.getElementById('armorRadiation').value = '';
        }
        
        // Add equipment to the equipment table
        function addEquipment() {
            const equipmentName = document.getElementById('equipmentName').value;
            const equipmentTL = document.getElementById('equipmentTL').value;
            const equipmentMass = document.getElementById('equipmentMass').value;
            const equipmentCost = document.getElementById('equipmentCost').value;
            
            if (!equipmentName) return;
            
            const equipmentContainer = document.getElementById('equipment-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${equipmentName}</td>
                <td>${equipmentTL}</td>
                <td>${equipmentMass}</td>
                <td>${equipmentCost}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">Ã—</button>
                </td>
            `;
            
            equipmentContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('equipmentName').value = '';
            document.getElementById('equipmentTL').value = '';
            document.getElementById('equipmentMass').value = '';
            document.getElementById('equipmentCost').value = '';
        }
        
        // Add weapon to the weapons table
        function addWeapon() {
            const weaponName = document.getElementById('weaponName').value;
            const weaponDamage = document.getElementById('weaponDamage').value;
            const weaponRange = document.getElementById('weaponRange').value;
            
            if (!weaponName) return;
            
            const weaponsContainer = document.getElementById('weapons-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${weaponName}</td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Skill"></td>
                <td>${weaponDamage}</td>
                <td>${weaponRange}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove()">Ã—</button>
                </td>
            `;
            
            weaponsContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponDamage').value = '';
            document.getElementById('weaponRange').value = '';
        }
        
        // Dice rolling functions
        function rollDice(num, sides) {
            let total = 0;
            let rolls = [];
            
            for (let i = 0; i < num; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            
            document.getElementById('roll-result').innerHTML = `
                Result: ${total} (${rolls.join(' + ')})
            `;
            
            return total;
        }
        
        function rollTask(target) {
            const result = rollDice(2, 6);
            let success = "FAILURE";
            
            if (result >= target) {
                success = "SUCCESS";
            }
            
            document.getElementById('roll-result').innerHTML = `
                Result: ${result} vs. Target ${target} - ${success}!
            `;
        }
        
        // Character save/load functions - these MUST be defined after the utility functions
        
        // Save character to localStorage - consolidated version 
        function saveCharacter() {
            const character = {
                // Basic info
                charName: document.getElementById('charName').value,
                species: document.getElementById('species').value,
                age: document.getElementById('age').value,
                
                // Get education details
                education: Array.from(document.getElementById('education-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        type: cells[0].getAttribute('data-type') || cells[0].textContent,
                        years: cells[1].getAttribute('data-years') || cells[1].textContent,
                        qualification: cells[2].getAttribute('data-qualification') || cells[2].textContent,
                        skills: cells[3].getAttribute('data-skills') || cells[3].textContent
                    };
                }).filter(e => e !== null),
                
                // Get career details with assignments
                careers: Array.from(document.getElementById('careers-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 5) return null;
                    return {
                        career: cells[0].getAttribute('data-career') || cells[0].textContent,
                        assignment: cells[1].getAttribute('data-assignment') || cells[1].textContent,
                        terms: cells[2].getAttribute('data-terms') || cells[2].textContent,
                        rank: cells[3].getAttribute('data-rank') || cells[3].textContent,
                        benefits: cells[4].getAttribute('data-benefits') || cells[4].textContent
                    };
                }).filter(c => c !== null),
                
                // Characteristics
                str: document.getElementById('str').value,
                dex: document.getElementById('dex').value,
                end: document.getElementById('end').value,
                int: document.getElementById('int').value,
                edu: document.getElementById('edu').value,
                soc: document.getElementById('soc').value,
                
                // Additional characteristics
                psi: document.getElementById('psi').value,
                wlt: document.getElementById('wlt').value,
                lck: document.getElementById('lck').value,
                mrl: document.getElementById('mrl').value,
                sty: document.getElementById('sty').value,
                std: document.getElementById('std').value,
                
                // Finances
                credits: document.getElementById('credits').value,
                pension: document.getElementById('pension').value,
                debt: document.getElementById('debt').value,
                
                // Notes
                notes: document.getElementById('notes').value,
                
                // Skills
                skills: Array.from(document.querySelectorAll('.skill-item')).map(item => {
                    const skillElement = item.querySelector('.skill-name');
                    return {
                        name: skillElement.getAttribute('data-skill'),
                        specialization: skillElement.getAttribute('data-specialization'),
                        level: item.querySelector('input').value
                    };
                }),
                
                // Weapons
                weapons: Array.from(document.getElementById('weapons-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        name: cells[0].textContent,
                        skill: cells[1].querySelector('input') ? cells[1].querySelector('input').value : '',
                        damage: cells[2].textContent,
                        range: cells[3].textContent
                    };
                }).filter(w => w !== null),
                
                // Armor
                armor: Array.from(document.getElementById('armor-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        name: cells[0].textContent,
                        rating: cells[1].textContent,
                        tl: cells[2].textContent,
                        radiation: cells[3].textContent
                    };
                }).filter(a => a !== null),
                
                // Equipment
                equipment: Array.from(document.getElementById('equipment-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 4) return null;
                    return {
                        name: cells[0].textContent,
                        tl: cells[1].textContent,
                        mass: cells[2].textContent,
                        cost: cells[3].textContent
                    };
                }).filter(e => e !== null)
            };
            
            try {
                localStorage.setItem('traveller-character', JSON.stringify(character));
                alert('Character saved successfully!');
            } catch (e) {
                console.error('Save failed:', e);
                alert('Failed to save character. Error: ' + e.message);
            }
        }
        
        // Load character from localStorage - consolidated version
        function loadCharacter() {
            try {
                const savedCharacter = localStorage.getItem('traveller-character');
                if (!savedCharacter) {
                    alert('No saved character found.');
                    return;
                }
                
                const character = JSON.parse(savedCharacter);
                
                // Basic info
                document.getElementById('charName').value = character.charName || '';
                document.getElementById('species').value = character.species || 'Human';
                document.getElementById('age').value = character.age || '18';
                
                // Clear existing education entries
                document.getElementById('education-container').innerHTML = '';
                
                // Load education data if it exists
                if (character.education && character.education.length) {
                    character.education.forEach(educationData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-type="${educationData.type}">${educationData.type}</td>
                            <td data-years="${educationData.years}">${educationData.years}</td>
                            <td data-qualification="${educationData.qualification}">${educationData.qualification}</td>
                            <td data-skills="${educationData.skills}">${educationData.skills}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove(); updateTotalYears();">Ã—</button>
                            </td>
                        `;
                        document.getElementById('education-container').appendChild(row);
                    });
                }
                
                // Clear existing careers
                document.getElementById('careers-container').innerHTML = '';
                
                // Load careers if they exist
                if (character.careers && character.careers.length) {
                    character.careers.forEach(careerData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-career="${careerData.career}">${careerData.career}</td>
                            <td data-assignment="${careerData.assignment || ''}">${careerData.assignment || ''}</td>
                            <td data-terms="${careerData.terms}">${careerData.terms}</td>
                            <td data-rank="${careerData.rank}">${careerData.rank}</td>
                            <td data-benefits="${careerData.benefits}">${careerData.benefits}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove(); updateTotalYears();">Ã—</button>
                            </td>
                        `;
                        document.getElementById('careers-container').appendChild(row);
                    });
                    
                    updateTotalTerms();
                }
                
                // Characteristics
                document.getElementById('str').value = character.str || '7';
                document.getElementById('dex').value = character.dex || '7';
                document.getElementById('end').value = character.end || '7';
                document.getElementById('int').value = character.int || '7';
                document.getElementById('edu').value = character.edu || '7';
                document.getElementById('soc').value = character.soc || '7';
                
                // Update DMs after setting characteristics
                updateDM('str');
                updateDM('dex');
                updateDM('end');
                updateDM('int');
                updateDM('edu');
                updateDM('soc');
                
                // Additional Characteristics
                document.getElementById('psi').value = character.psi || '7';
                document.getElementById('wlt').value = character.wlt || '7';
                document.getElementById('lck').value = character.lck || '7';
                document.getElementById('mrl').value = character.mrl || '7';
                document.getElementById('sty').value = character.sty || '7';
                document.getElementById('std').value = character.std || '7';
                
                // Update DMs for additional characteristics
                updateDM('psi');
                updateDM('wlt');
                updateDM('lck');
                updateDM('mrl');
                updateDM('sty');
                updateDM('std');
                
                // Finances
                document.getElementById('credits').value = character.credits || '0';
                document.getElementById('pension').value = character.pension || '0';
                document.getElementById('debt').value = character.debt || '0';
                
                // Notes
                document.getElementById('notes').value = character.notes || '';
                
                // Clear existing items
                document.getElementById('skills-container').innerHTML = '';
                document.getElementById('weapons-container').innerHTML = '';
                document.getElementById('armor-container').innerHTML = '';
                document.getElementById('equipment-container').innerHTML = '';
                
                // Skills with specialization support
                if (character.skills && character.skills.length) {
                    character.skills.forEach(skill => {
                        const skillDiv = document.createElement('div');
                        skillDiv.className = 'skill-item';
                        skillDiv.innerHTML = `
                            <span class="skill-name" data-skill="${skill.name}" data-specialization="${skill.specialization || ''}">
                                ${skill.name}${skill.specialization ? ` <span class="skill-specialization">(${skill.specialization})</span>` : ''}
                            </span>
                            <div class="d-flex align-items-center">
                                <input type="number" class="form-control form-control-sm mx-2" value="${skill.level}" min="0" style="width: 60px;">
                                <button class="btn btn-remove no-print" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                            </div>
                        `;
                        document.getElementById('skills-container').appendChild(skillDiv);
                    });
                }
                
                // Weapons
                if (character.weapons && character.weapons.length) {
                    character.weapons.forEach(weapon => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${weapon.name}</td>
                            <td><input type="text" class="form-control form-control-sm" value="${weapon.skill}" placeholder="Skill"></td>
                            <td>${weapon.damage}</td>
                            <td>${weapon.range}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">Ã—</button>
                            </td>
                        `;
                        document.getElementById('weapons-container').appendChild(row);
                    });
                }
                
                // Armor
                if (character.armor && character.armor.length) {
                    character.armor.forEach(armor => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${armor.name}</td>
                            <td>${armor.rating}</td>
                            <td>${armor.tl}</td>
                            <td>${armor.radiation}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">Ã—</button>
                        `;
                        document.getElementById('armor-container').appendChild(row);
                    });
                }
                
                // Equipment
                if (character.equipment && character.equipment.length) {
                    character.equipment.forEach(equipment => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${equipment.name}</td>
                            <td>${equipment.tl}</td>
                            <td>${equipment.mass}</td>
                            <td>${equipment.cost}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove()">Ã—</button>
                        `;
                        document.getElementById('equipment-container').appendChild(row);
                    });
                }
                
                alert('Character loaded successfully!');
            } catch (e) {
                console.error('Load failed:', e);
                alert('Failed to load character. Error: ' + e.message);
            }
        }
        
        // Reset character sheet
        function resetCharacter() {
            if (confirm('Are you sure you want to reset the character sheet? All data will be lost.')) {
                // Basic info
                document.getElementById('charName').value = '';
                document.getElementById('species').value = 'Human';
                document.getElementById('age').value = '18';
                
                // Characteristics
                document.getElementById('str').value = '7';
                document.getElementById('dex').value = '7';
                document.getElementById('end').value = '7';
                document.getElementById('int').value = '7';
                document.getElementById('edu').value = '7';
                document.getElementById('soc').value = '7';
                
                // Additional Characteristics
                document.getElementById('psi').value = '7';
                document.getElementById('wlt').value = '7';
                document.getElementById('lck').value = '7';
                document.getElementById('mrl').value = '7';
                document.getElementById('sty').value = '7';
                document.getElementById('std').value = '7';
                
                // Update DMs
                updateDM('str');
                updateDM('dex');
                updateDM('end');
                updateDM('int');
                updateDM('edu');
                updateDM('soc');
                
                // Update DMs for additional characteristics
                updateDM('psi');
                updateDM('wlt');
                updateDM('lck');
                updateDM('mrl');
                updateDM('sty');
                updateDM('std');
                
                // Finances
                document.getElementById('credits').value = '0';
                document.getElementById('pension').value = '0';
                document.getElementById('debt').value = '0';
                
                // Notes
                document.getElementById('notes').value = '';
                
                // Clear containers
                document.getElementById('skills-container').innerHTML = '';
                document.getElementById('weapons-container').innerHTML = '';
                document.getElementById('armor-container').innerHTML = '';
                document.getElementById('equipment-container').innerHTML = '';
                
                alert('Character sheet has been reset.');
            }
        }
        
        // Add shortcut for adding typical human characteristics
        function setHumanCharacteristics() {
            document.getElementById('str').value = '7';
            document.getElementById('dex').value = '7';
            document.getElementById('end').value = '7';
            document.getElementById('int').value = '7';
            document.getElementById('edu').value = '7';
            document.getElementById('soc').value = '7';
            
            updateDM('str');
            updateDM('dex');
            updateDM('end');
            updateDM('int');
            updateDM('edu');
            updateDM('soc');
        }
        
        // Export character to JSON file
        function exportCharacter() {
            const characterData = localStorage.getItem('traveller-character');
            if (!characterData) {
                alert('No character data to export. Please save your character first.');
                return;
            }
            
            const character = JSON.parse(characterData);
            const characterName = character.charName || 'traveller-character';
            const filename = `${characterName.replace(/\s+/g, '-')}.json`;
            
            const blob = new Blob([characterData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Import character from JSON file
        function importCharacter() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const characterData = e.target.result;
                        localStorage.setItem('traveller-character', characterData);
                        loadCharacter();
                    } catch (error) {
                        console.error('Import failed:', error);
                        alert('Failed to import character. The file might be corrupted.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Add career to the careers table
        function addCareer() {
            const careerName = document.getElementById('careerName').value;
            const careerAssignment = document.getElementById('careerAssignment').value;
            const careerTerms = document.getElementById('careerTerms').value;
            const careerRank = document.getElementById('careerRank').value;
            const careerBenefits = document.getElementById('careerBenefits').value;
            
            if (!careerName) {
                alert("Please select a career");
                return;
            }
            
            const careersContainer = document.getElementById('careers-container');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-career="${careerName}">${careerName}</td>
                <td data-assignment="${careerAssignment}">${careerAssignment}</td>
                <td data-terms="${careerTerms}">${careerTerms}</td>
                <td data-rank="${careerRank}">${careerRank}</td>
                <td data-benefits="${careerBenefits}">${careerBenefits}</td>
                <td class="no-print">
                    <button class="btn btn-remove" onclick="this.closest('tr').remove(); updateTotalYears();">Ã—</button>
                </td>
            `;
            
            careersContainer.appendChild(row);
            
            // Clear inputs
            document.getElementById('careerName').selectedIndex = 0;
            document.getElementById('careerAssignment').innerHTML = '<option value="">Select Assignment...</option>';
            document.getElementById('careerTerms').value = '1';
            document.getElementById('careerRank').value = '';
            document.getElementById('careerBenefits').value = '';
            
            // Update total terms
            updateTotalTerms();
        }
        
        // Initialize career dropdown on page load
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing initialization code...
            
            // Add event listener for career terms to suggest ranks
            document.getElementById('careerTerms').addEventListener('input', suggestRank);
        });

        // Update the saveCharacter function to save careers with assignments
        const originalSaveCharacter = saveCharacter;
        
        saveCharacter = function() {
            const character = {
                // ...existing character data...
                
                // Get career details with assignments
                careers: Array.from(document.getElementById('careers-container').querySelectorAll('tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 5) return null;
                    return {
                        career: cells[0].getAttribute('data-career') || cells[0].textContent,
                        assignment: cells[1].getAttribute('data-assignment') || cells[1].textContent,
                        terms: cells[2].getAttribute('data-terms') || cells[2].textContent,
                        rank: cells[3].getAttribute('data-rank') || cells[3].textContent,
                        benefits: cells[4].getAttribute('data-benefits') || cells[4].textContent
                    };
                }).filter(c => c !== null),
                
                // ...rest of character data...
            };
            
            // Store in localStorage
            try {
                localStorage.setItem('traveller-character', JSON.stringify(character));
                alert('Character saved successfully!');
            } catch (e) {
                console.error('Save failed:', e);
                alert('Failed to save character. Error: ' + e.message);
            }
        };
        
        // Update the loadCharacter function to load careers with assignments
        const originalLoadCharacter = loadCharacter;
        
        loadCharacter = function() {
            try {
                const savedCharacter = localStorage.getItem('traveller-character');
                if (!savedCharacter) {
                    alert('No saved character found.');
                    return;
                }
                
                const character = JSON.parse(savedCharacter);
                
                // Clear existing careers
                document.getElementById('careers-container').innerHTML = '';
                
                // Load careers if they exist
                if (character.careers && character.careers.length) {
                    character.careers.forEach(careerData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-career="${careerData.career}">${careerData.career}</td>
                            <td data-assignment="${careerData.assignment || ''}">${careerData.assignment || ''}</td>
                            <td data-terms="${careerData.terms}">${careerData.terms}</td>
                            <td data-rank="${careerData.rank}">${careerData.rank}</td>
                            <td data-benefits="${careerData.benefits}">${careerData.benefits}</td>
                            <td class="no-print">
                                <button class="btn btn-remove" onclick="this.closest('tr').remove(); updateTotalYears();">Ã—</button>
                            </td>
                        `;
                        document.getElementById('careers-container').appendChild(row);
                    });
                    
                    updateTotalTerms();
                }
                
                // Call the original function to load other data
                originalLoadCharacter();
            } catch (e) {
                console.error('Load failed:', e);
                alert('Failed to load character. Error: ' + e.message);
            }
        };

        // ...existing code...

        // Create a comprehensive initialization function
        function initializeCharacterSheet() {
            console.log("Initializing character sheet...");
            
            // Initialize characteristics
            updateDM('str');
            updateDM('dex');
            updateDM('end');
            updateDM('int');
            updateDM('edu');
            updateDM('soc');
            
            // Initialize additional characteristics
            updateDM('psi');
            updateDM('wlt');
            updateDM('lck');
            updateDM('mrl');
            updateDM('sty');
            updateDM('std');
            
            // Create the skills datalist for autocomplete
            const skillSearch = document.getElementById('skillSearch');
            
            // First check if datalist already exists and remove if so
            const existingDatalist = document.getElementById('skill-list');
            if (existingDatalist) {
                existingDatalist.remove();
            }
            
            // Create fresh datalist
            const datalist = document.createElement('datalist');
            datalist.id = 'skill-list';
            
            commonSkills.forEach(skill => {
                const option = document.createElement('option');
                option.value = skill;
                datalist.appendChild(option);
            });
            
            document.body.appendChild(datalist);
            
            // Make sure the input element has the list attribute
            if (skillSearch) {
                skillSearch.setAttribute('list', 'skill-list');
                console.log("Skills datalist connected to input");
            } else {
                console.error("Could not find skillSearch element");
            }
            
            // Add autocomplete handling for specializations
            const specializationField = document.getElementById('specializationField');
            
            // First check if specialization datalist already exists
            const existingSpecList = document.getElementById('specialization-list');
            if (existingSpecList) {
                existingSpecList.remove();
            }
            
            // Create fresh specialization datalist
            const specList = document.createElement('datalist');
            specList.id = 'specialization-list';
            document.body.appendChild(specList);
            
            if (specializationField) {
                specializationField.setAttribute('list', 'specialization-list');
                // Update specialization options when skill changes
                skillSearch.addEventListener('input', updateSpecializationOptions);
                console.log("Specialization datalist connected");
            } else {
                console.error("Could not find specializationField element");
            }
            
            // Populate career dropdown
            const careerSelect = document.getElementById('careerName');
            if (careerSelect) {
                // Clear existing options except the first one
                while (careerSelect.options.length > 1) {
                    careerSelect.remove(1);
                }
                
                // Add optgroup for core rulebook careers
                const coreGroup = document.createElement('optgroup');
                coreGroup.label = 'Core Rulebook';
                mgt2Careers.forEach(career => {
                    // Look for matching career in careerData (with or without numeric suffix)
                    const careerKeys = Object.keys(careerData);
                    const matchingCareer = careerKeys.find(key => 
                        key.startsWith(career + " (") || key === career
                    ) || career;
                    
                    const option = document.createElement('option');
                    // Use the exact key from careerData to maintain consistency
                    option.value = matchingCareer;
                    // Display the clean career name without the number
                    option.textContent = matchingCareer.replace(/\s*\(\d+\)$/, '');
                    coreGroup.appendChild(option);
                });
                careerSelect.appendChild(coreGroup);
                
                // ...existing supplement career code...
                
                // Make sure the event handler is properly attached
                careerSelect.addEventListener('change', updateAssignments);
                
                // ...existing code...
            }
            
            // ...rest of initialization code...
        }

        // Set up event listener to initialize the sheet when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded");
            initializeCharacterSheet();
        });
    </script>
</body>
</html>
