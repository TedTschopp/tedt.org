<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Fractal World Generator v1.0.2</title>
    <script type="text/javascript">
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// this is a completely self-contained random world generator,
// implemented in HTML5 and JavaScript.
//
//   version 1.0.2      es2015 updates
//   version 1.0.1      updated save_canvas to use filename
//   version 1.0        initial release
//
// written by drow [drow@bin.sh]
// http://creativecommons.org/licenses/by-nc/3.0/

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// config functions

    function random (n) { 
        return Math.floor(Math.random() * n); 
    }

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// configuration

  // Using var to ensure these are accessible as globals for world.js
  var default_query = {
    'seed':             Date.now(),
    'projection':       'square',
    'palette':          'atlas',
    'pct_water':        random(50) + 25,
    'pct_ice':          random(10) + 5,
    'height':           400,
    'iter':             5000,
    'rotate':            0,
    'terrain_variation': 75, // Default terrain variation value (75%)
    'algorithm':        'voss_a7', // Default algorithm
    'erode':            true, // Default erosion setting
    'horizontal_factor': 0.5, // Default horizontal distortion factor
    'vertical_factor':   0.2, // Default vertical distortion factor
    'enable_hack_theta': true, // Default theta hack setting
    'ocean_currents':    true, // Default ocean currents setting
    'enable_time_simulation': true, // Default time simulation setting
    'time_passage':      1.5 // Default time passage in million years
  };
  var max_height      = 1000;
  var max_iter        = 25000;

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// palettes

  var palette = {
    'olsson': {                         // john olsson
      'title':          'Olsson',
      'sea': [
        [0x00,0x00,0x44], [0x00,0x11,0x66], [0x00,0x33,0x88],
        [0x00,0x55,0xAA], [0x00,0x77,0xBB], [0x00,0x99,0xDD],
        [0x00,0xCC,0xFF], [0x22,0xDD,0xFF], [0x44,0xEE,0xFF],
        [0x66,0xFF,0xFF], [0x77,0xFF,0xFF], [0x88,0xFF,0xFF],
        [0x99,0xFF,0xFF], [0xAA,0xFF,0xFF], [0xBB,0xFF,0xFF]
      ],
      'land': [
        [0x00,0x44,0x00], [0x22,0x66,0x00], [0x22,0x88,0x00],
        [0x77,0xAA,0x00], [0xBB,0xDD,0x00], [0xFF,0xBB,0x22],
        [0xEE,0xAA,0x22], [0xDD,0x88,0x22], [0xCC,0x88,0x22],
        [0xBB,0x66,0x22], [0xAA,0x55,0x22], [0x99,0x55,0x22],
        [0x88,0x44,0x22], [0x77,0x33,0x22], [0x55,0x33,0x11],
        [0x44,0x22,0x00]
      ]
    },
    'mogensen': {                       // toben mogensen
      'title':          'Mogensen',
      'sea': [
        [0x00,0x00,0xC0], [0x00,0x09,0xC4], [0x00,0x12,0xC9],
        [0x00,0x1B,0xCD], [0x00,0x24,0xD2], [0x00,0x2D,0xD6],
        [0x00,0x36,0xDB], [0x00,0x40,0xDF], [0x00,0x49,0xE4],
        [0x00,0x52,0xE8], [0x00,0x5B,0xED], [0x00,0x64,0xF1],
        [0x00,0x6D,0xF6], [0x00,0x76,0xFA], [0x00,0x80,0xFF]
      ],
      'land': [
        [0x00,0x60,0x00], [0x00,0x80,0x00], [0x00,0xA0,0x00],
        [0x00,0xC0,0x00], [0x00,0xE0,0x00], [0x20,0xD4,0x00],
        [0x40,0xC8,0x00], [0x60,0xBC,0x00], [0x80,0xB0,0x00],
        [0x80,0xA4,0x20], [0x80,0x98,0x40], [0x80,0x8C,0x60],
        [0x80,0x80,0x80], [0xAA,0xAA,0xAA], [0xD4,0xD4,0xD4],
        [0xFF,0xFF,0xFF]
      ]
    },
    'atlas': {
      'title':          'Atlas',
      'sea': [
        [0x80,0xB0,0xBD], [0x86,0xB5,0xC1], [0x8D,0xBA,0xC6],
        [0x94,0xBF,0xCA], [0x9A,0xC4,0xCF], [0xA1,0xC9,0xD4],
        [0xA8,0xCE,0xD8], [0xAF,0xD3,0xDD], [0xB5,0xD8,0xE2],
        [0xBC,0xDD,0xE6], [0xC3,0xE2,0xEB], [0xCA,0xE8,0xF0],
        [0xCA,0xE8,0xF0], [0xCA,0xE8,0xF0], [0xCA,0xE8,0xF0]
      ],
      'land': [
        [0x84,0xB6,0x77], [0x93,0xBD,0x80], [0xA2,0xC5,0x8A],
        [0xB1,0xCC,0x93], [0xC0,0xD4,0x9D], [0xCF,0xDB,0xA6],
        [0xDE,0xE3,0xB0], [0xED,0xEB,0xBA], [0xE0,0xD9,0xAF],
        [0xD3,0xC7,0xA3], [0xC6,0xB5,0x98], [0xB9,0xA3,0x8C],
        [0xCA,0xBA,0xA8], [0xDC,0xD1,0xC5], [0xED,0xE8,0xE2],
        [0xFF,0xFF,0xFF]
      ]
    },
    'antique': {
      'title':          'Antique',
      'set':            { 'pct_ice': 0 },
      'sea': [
        [0xEB,0xD2,0xB0], [0xE8,0xD0,0xAE], [0xE5,0xCD,0xAC],
        [0xE2,0xCA,0xAA], [0xDF,0xC8,0xA7], [0xDC,0xC5,0xA5],
        [0xD9,0xC2,0xA3], [0xD6,0xC0,0xA0],
        [0xD3,0xBD,0x9E], [0xD0,0xBA,0x9C], [0xCC,0xB7,0x99],
        [0x99,0x8A,0x73], [0x66,0x5C,0x4D], [0x33,0x2E,0x27],
        [0x00,0x00,0x00]
      ],
      'land': [
        [0xE2,0xCA,0xAA], [0xE2,0xCA,0xAA], [0xE3,0xCB,0xAA],
        [0xE3,0xCB,0xAB], [0xE4,0xCC,0xAB], [0xE5,0xCC,0xAC],
        [0xE5,0xCD,0xAC], [0xE6,0xCD,0xAC], [0xE6,0xCE,0xAD],
        [0xE7,0xCE,0xAD], [0xE8,0xCF,0xAE], [0xE8,0xCF,0xAE],
        [0xE9,0xD0,0xAE], [0xE9,0xD0,0xAF], [0xEA,0xD1,0xAF],
        [0xEB,0xD2,0xB0]
      ]
    },
    'barren': {
      'title':          'Barren',
      'sea': [
        [0x00,0x00,0xC0], [0x00,0x09,0xC4], [0x00,0x12,0xC9],
        [0x00,0x1B,0xCD], [0x00,0x24,0xD2], [0x00,0x2D,0xD6],
        [0x00,0x36,0xDB], [0x00,0x40,0xDF], [0x00,0x49,0xE4],
        [0x00,0x52,0xE8], [0x00,0x5B,0xED], [0x00,0x64,0xF1],
        [0x00,0x6D,0xF6], [0x00,0x76,0xFA], [0x00,0x80,0xFF]
      ],
      'land': [
        [0x94,0x64,0x52], [0xA9,0x74,0x54], [0xBE,0x84,0x56],
        [0xD3,0x94,0x58], [0xE8,0xA4,0x5A], [0xEC,0xA8,0x5A],
        [0xF0,0xAC,0x5B], [0xF4,0xB0,0x5B], [0xF8,0xB4,0x5C],
        [0xE4,0xA7,0x60], [0xCF,0x9A,0x64], [0xBA,0x8D,0x68],
        [0xA5,0x80,0x6C], [0xC3,0xAA,0x9D], [0xE1,0xD4,0xCE],
        [0xFF,0xFF,0xFF]
      ]
    },
    'martian': {
      'title':          'Martian',
      'set':            { 'pct_water': 0 },
      'sea': [
        [0x00,0x00,0xC0], [0x00,0x09,0xC4], [0x00,0x12,0xC9],
        [0x00,0x1B,0xCD], [0x00,0x24,0xD2], [0x00,0x2D,0xD6],
        [0x00,0x36,0xDB], [0x00,0x40,0xDF], [0x00,0x49,0xE4],
        [0x00,0x52,0xE8], [0x00,0x5B,0xED], [0x00,0x64,0xF1],
        [0x00,0x6D,0xF6], [0x00,0x76,0xFA], [0x00,0x80,0xFF]
      ],
      'land': [
        [0x94,0x64,0x52], [0xA9,0x74,0x54], [0xBE,0x84,0x56],
        [0xD3,0x94,0x58], [0xE8,0xA4,0x5A], [0xEC,0xA8,0x5A],
        [0xF0,0xAC,0x5B], [0xF4,0xB0,0x5B], [0xF8,0xB4,0x5C],
        [0xE4,0xA7,0x60], [0xCF,0x9A,0x64], [0xBA,0x8D,0x68],
        [0xA5,0x80,0x6C], [0xC3,0xAA,0x9D], [0xE1,0xD4,0xCE],
        [0xFF,0xFF,0xFF]
      ]
    },
    'chthonian': {
      'title':          'Chthonian',
      'set':            { 'pct_ice': 0 },
      'sea': [
        [0xFB,0xE7,0x2E], [0xFB,0xC3,0x2C], [0xFC,0x9E,0x29],
        [0xFD,0x7A,0x27], [0xFE,0x55,0x24], [0xF8,0x4D,0x21],
        [0xF2,0x44,0x1D], [0xEC,0x3C,0x1A], [0xE6,0x33,0x16],
        [0xDF,0x2B,0x12], [0xD9,0x22,0x0F], [0xD3,0x1A,0x0B],
        [0xCD,0x11,0x08], [0xC7,0x09,0x04], [0xC0,0x00,0x00]
      ],
      'land': [
        [0x10,0x10,0x10], [0x14,0x14,0x14], [0x18,0x18,0x18],
        [0x1D,0x1D,0x1D], [0x21,0x21,0x21], [0x25,0x25,0x25],
        [0x2A,0x2A,0x2A], [0x2E,0x2E,0x2E], [0x32,0x32,0x32],
        [0x37,0x37,0x37], [0x3B,0x3B,0x3B], [0x40,0x40,0x40],
        [0x50,0x50,0x50], [0x60,0x60,0x60], [0x70,0x70,0x70],
        [0x80,0x80,0x80]
      ]
    },
    'greyscale': {
      'title':          'Greyscale',
      'set':            { 'pct_water': 0, 'pct_ice': 0 },
      'sea': [
        [0x00,0x00,0xC0], [0x00,0x09,0xC4], [0x00,0x12,0xC9],
        [0x00,0x1B,0xCD], [0x00,0x24,0xD2], [0x00,0x2D,0xD6],
        [0x00,0x36,0xDB], [0x00,0x40,0xDF], [0x00,0x49,0xE4],
        [0x00,0x52,0xE8], [0x00,0x5B,0xED], [0x00,0x64,0xF1],
        [0x00,0x6D,0xF6], [0x00,0x76,0xFA], [0x00,0x80,0xFF]
      ],
      'land': [
        [0x40,0x40,0x40], [0x48,0x48,0x48], [0x51,0x51,0x51],
        [0x59,0x59,0x59], [0x62,0x62,0x62], [0x6A,0x6A,0x6A],
        [0x73,0x73,0x73], [0x7B,0x7B,0x7B], [0x84,0x84,0x84],
        [0x8C,0x8C,0x8C], [0x95,0x95,0x95], [0x9D,0x9D,0x9D],
        [0xA6,0xA6,0xA6], [0xAE,0xAE,0xAE], [0xB7,0xB7,0xB7],
        [0xC0,0xC0,0xC0]
      ]
    },
    'landmask': {
      'title':          'Landmask',
      'set':            { 'pct_ice': 0 },
      'sea': [
        [0x00,0x00,0x00], [0x00,0x00,0x00], [0x00,0x00,0x00],
        [0x00,0x00,0x00], [0x00,0x00,0x00], [0x00,0x00,0x00],
        [0x00,0x00,0x00], [0x00,0x00,0x00], [0x00,0x00,0x00],
        [0x00,0x00,0x00], [0x00,0x00,0x00], [0x00,0x00,0x00],
        [0x00,0x00,0x00], [0x00,0x00,0x00], [0x00,0x00,0x00]
      ],
      'land': [
        [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF],
        [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF],
        [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF],
        [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF],
        [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF], [0xFF,0xFF,0xFF],
        [0xFF,0xFF,0xFF]
      ]
    },
    'temperature': {
      'title':          'Temperature',
      'set':            { 'pct_ice': 5 },
      'sea': [
        [0x00,0x00,0x80], [0x00,0x00,0x90], [0x00,0x00,0xA0],
        [0x00,0x00,0xB0], [0x00,0x00,0xC0], [0x00,0x00,0xD0],
        [0x00,0x00,0xE0], [0x00,0x00,0xF0], [0x00,0x00,0xFF],
        [0x00,0x40,0xFF], [0x00,0x80,0xFF], [0x00,0xC0,0xFF],
        [0x40,0xE0,0xFF], [0x80,0xF0,0xFF], [0xC0,0xFF,0xFF]
      ],
      'land': [
        [0x00,0xFF,0x00], [0x40,0xFF,0x00], [0x80,0xFF,0x00],
        [0xC0,0xFF,0x00], [0xFF,0xFF,0x00], [0xFF,0xE0,0x00],
        [0xFF,0xC0,0x00], [0xFF,0xA0,0x00], [0xFF,0x80,0x00],
        [0xFF,0x60,0x00], [0xFF,0x40,0x00], [0xFF,0x20,0x00],
        [0xFF,0x00,0x00], [0xE0,0x00,0x00], [0xC0,0x00,0x00],
        [0xA0,0x00,0x00]
      ]
    },
    'rainfall': {
      'title':          'Rainfall',
      'set':            { 'pct_ice': 0 },
      'sea': [
        [0x30,0x60,0x90], [0x30,0x64,0x94], [0x30,0x68,0x98],
        [0x30,0x6C,0x9C], [0x30,0x70,0xA0], [0x30,0x74,0xA4],
        [0x30,0x78,0xA8], [0x30,0x7C,0xAC], [0x30,0x80,0xB0],
        [0x30,0x84,0xB4], [0x30,0x88,0xB8], [0x30,0x8C,0xBC],
        [0x30,0x90,0xC0], [0x30,0x94,0xC4], [0x30,0x98,0xC8]
      ],
      'land': [
        [0xF0,0xE0,0xD0], [0xE0,0xF0,0xD0], [0xD0,0xF0,0xD0],
        [0xC0,0xF0,0xD0], [0xB0,0xF0,0xE0], [0xA0,0xF0,0xE0],
        [0x90,0xF0,0xE0], [0x80,0xF0,0xE0], [0x70,0xE0,0xF0],
        [0x60,0xD0,0xF0], [0x50,0xC0,0xF0], [0x40,0xB0,0xF0],
        [0x30,0xA0,0xF0], [0x20,0x90,0xF0], [0x10,0x80,0xF0],
        [0x00,0x70,0xF0]
      ]
    },
    'evaporation': {
      'title':          'Evaporation',
      'set':            { 'pct_ice': 0 },
      'sea': [
        [0x60,0x60,0x60], [0x64,0x64,0x64], [0x68,0x68,0x68],
        [0x6C,0x6C,0x6C], [0x70,0x70,0x70], [0x74,0x74,0x74],
        [0x78,0x78,0x78], [0x7C,0x7C,0x7C], [0x80,0x80,0x80],
        [0x84,0x84,0x84], [0x88,0x88,0x88], [0x8C,0x8C,0x8C],
        [0x90,0x90,0x90], [0x94,0x94,0x94], [0x98,0x98,0x98]
      ],
      'land': [
        [0x80,0x40,0x00], [0x90,0x50,0x10], [0xA0,0x60,0x20],
        [0xB0,0x70,0x30], [0xC0,0x80,0x40], [0xD0,0x90,0x50],
        [0xE0,0xA0,0x60], [0xF0,0xB0,0x70], [0xFF,0xC0,0x80],
        [0xFF,0xD0,0x90], [0xFF,0xE0,0xA0], [0xFF,0xF0,0xB0],
        [0xFF,0xFF,0xC0], [0xFF,0xFF,0xD0], [0xFF,0xFF,0xE0],
        [0xFF,0xFF,0xF0]
      ]
    },
    // Snowfall palette: blue gradient for snow accumulation, warm colors for melt areas
    // Perennial snow (positive mass balance) shown in white/light blue
    'snowfall': {
      'title':          'Snowfall & Perennial Snow',
      'set':            { 'pct_ice': 0 },
      'sea': [
        // Ocean - dark blue gradient (not relevant for snow)
        [0x20,0x30,0x50], [0x24,0x34,0x54], [0x28,0x38,0x58],
        [0x2C,0x3C,0x5C], [0x30,0x40,0x60], [0x34,0x44,0x64],
        [0x38,0x48,0x68], [0x3C,0x4C,0x6C], [0x40,0x50,0x70],
        [0x44,0x54,0x74], [0x48,0x58,0x78], [0x4C,0x5C,0x7C],
        [0x50,0x60,0x80], [0x54,0x64,0x84], [0x58,0x68,0x88]
      ],
      'land': [
        // Negative mass balance (heavy melt) - warm/brown colors
        [0x8B,0x45,0x13], [0x9C,0x55,0x21], [0xAD,0x65,0x2F],
        [0xBE,0x75,0x3D], [0xCF,0x85,0x4B], [0xD4,0x95,0x60],
        // Near-zero balance - yellow/beige transition
        [0xDA,0xA5,0x75], [0xE0,0xB5,0x8A], [0xE6,0xC5,0x9F],
        // Low positive balance - light blue/gray
        [0xE8,0xE8,0xF0], [0xD8,0xE4,0xF0], [0xC8,0xDC,0xF4],
        // Moderate positive - blue tones
        [0xB0,0xD0,0xF8], [0x98,0xC8,0xFC],
        // High positive balance (deep snow) - bright blue to white
        [0x80,0xC0,0xFF], [0xF0,0xF8,0xFF]  // Last = perennial snow white
      ]
    },
    // Ice cap classification palette
    // Shows ice caps (white), glaciers (blue), perennial snow (light gray), bare land (brown)
    'icecap': {
      'title':          'Ice Cap Classification',
      'set':            { 'pct_ice': 0 },
      'sea': [
        // Ocean - dark blue gradient
        [0x20,0x30,0x50], [0x24,0x34,0x54], [0x28,0x38,0x58],
        [0x2C,0x3C,0x5C], [0x30,0x40,0x60], [0x34,0x44,0x64],
        [0x38,0x48,0x68], [0x3C,0x4C,0x6C], [0x40,0x50,0x70],
        [0x44,0x54,0x74], [0x48,0x58,0x78], [0x4C,0x5C,0x7C],
        [0x50,0x60,0x80], [0x54,0x64,0x84], [0x58,0x68,0x88]
      ],
      'land': [
        // Bare land - brown/tan gradient (indices 0-7)
        [0x8B,0x73,0x55], [0x9C,0x82,0x64], [0xAD,0x91,0x73],
        [0xBE,0xA0,0x82], [0xCF,0xAF,0x91], [0xD4,0xBE,0xA0],
        [0xDA,0xCD,0xAF], [0xE0,0xDC,0xBE],
        // Perennial snowfield - light gray/white (indices 8-10)
        [0xD0,0xD0,0xD8], [0xE0,0xE0,0xE8], [0xEA,0xEA,0xF0],
        // Glacier - blue tones (indices 11-13)
        [0x70,0xA0,0xE0], [0x88,0xB8,0xF0], [0xA0,0xD0,0xFF],
        // Ice cap - bright white/cyan (indices 14-15)
        [0xE8,0xF8,0xFF], [0xF8,0xFF,0xFF]
      ]
    }
  };
    </script>
    <style>
        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
        /* structure */

        body { margin: 0px; padding: 0px;
            font-family: 'Asul', sans-serif; font-size: 14px; 
        }

        /* Cell info tooltip (Islands-style) */
        #cell_info {
            position: fixed;
            z-index: 1000;
            white-space: pre;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.85);
            color: rgba(255,255,255,0.96);
            font-size: 12px;
            line-height: 1.35;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            pointer-events: none;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        #cell_info.visible {
            display: block;
        }

        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
        /* common */

        h1 { 
            text-align: center; font-size: 150%; font-weight: bold; 
        }

        form { 
            margin: 2ex 2em; padding: 0px; 
        }
        input { margin-right: 0.5em; padding: 0.5ex 0.5em;
            font-family: Monaco, monospace; font-size: 11px; 
        }
        select {
             min-width: 10em; margin-right: 0.5em; font-size: 11px; 
        }

        table {
            margin: 0px 2em; border: none; border-collapse: collapse; 
        }
        td {
            padding: 0.5ex 0.5em; text-align: left; vertical-align: top; 
        }
        td.key {
            text-align: right; font-weight: bold; 
        }

        canvas {
            margin: 2ex auto; 
        }

        .center {
            text-align: center; 
        }

        table.center {
            margin-left: auto; margin-right: auto;
        }

        /* Slider styles */
        .slider-container {
            display: flex;
            align-items: center;
        }
        
        .slider {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .slider-value {
            width: 30px;
            text-align: center;
        }

        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
        /* screen */

        @media screen {
            h1.title { display: none; }
            form { display: block; }
        }

        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
        /* print */

        @media print {
            h1.title { display: block; }
            form, .control { display: none; }
        }

        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */


    </style>
  </head>
  <body>
    <form class="scripted">
      <h1>Fractal World Generator</h1>
      <table id="form" class="center">
        <tr>
          <td class="key">Random Seed:</td>
          <td colspan="5" class="value"><input id="seed" size="20" /> &nbsp; <input type="button" id="new_seed" value="New" /> </td>
        </tr>
        <tr>
          <td class="key">Projection:</td>
          <td class="value"><select id="projection"></select></td>
          <td class="key">Palette:</td>
          <td class="value"><select id="palette"></select></td>
        </tr>
        <tr>
          <td class="key">% Water:</td>
          <td class="value"><input id="pct_water" size="5" /></td>
          <td class="key">% Ice:</td>
          <td class="value"><input id="pct_ice" size="5" /></td>
        </tr>
        <tr>
          <td class="key">Height:</td>
          <td class="value"><input id="height" size="5" /></td>
          <td class="key">Iterations:</td>
          <td class="value"><input id="iter" size="5" /></td>
          <td class="key">Rotate:</td>
          <td class="value"><input id="rotate" size="5" /></td>
        </tr>
        <tr>
          <td class="key">Terrain Variation:</td>
          <td colspan="5" class="value">
            <div class="slider-container">
              <input type="range" id="terrain_variation" min="0" max="100" step="1" class="slider" value="75" />
              <span id="terrain_variation_value" class="slider-value">75%</span>
            </div>
          </td>
        </tr>
        <tr>
          <td class="key">Algorithm:</td>
          <td class="value">
            <select id="algorithm">
              <option value="voss">Basic Voss</option>
              <option value="voss_x3">Voss x3</option>
              <option value="voss_a7" selected>Voss a7</option>
            </select>
          </td>
          <td class="key">Apply Erosion:</td>
          <td class="value"><input type="checkbox" id="erode" checked /></td>
        </tr>
        <tr>
          <td class="key">Simulate Ocean Currents:</td>
          <td class="value"><input type="checkbox" id="ocean_currents" checked /></td>
          <td class="key">Enable Theta Hack:</td>
          <td class="value"><input type="checkbox" id="enable_hack_theta" checked /></td>
        </tr>
        <tr>
          <td class="key">Time Simulation:</td>
          <td class="value"><input type="checkbox" id="enable_time_simulation" checked /></td>
          <td class="key">Time (Million Years):</td>
          <td class="value">
            <div class="slider-container">
              <input type="range" id="time_passage" min="0" max="50" step="0.5" class="slider" value="1.5" />
              <span id="time_passage_value" class="slider-value">1.5 MY</span>
            </div>
          </td>
        </tr>
        <tr>
          <td class="key">Show Rivers:</td>
          <td class="value"><input type="checkbox" id="show_rivers" checked /></td>
          <td class="key">Show Coastlines:</td>
          <td class="value"><input type="checkbox" id="show_coastlines" checked /></td>
        </tr>
        <tr>
          <td class="key">Horizontal Factor:</td>
          <td colspan="5" class="value">
            <div class="slider-container">
              <input type="range" id="horizontal_factor" min="0" max="100" step="1" class="slider" value="50" />
              <span id="horizontal_factor_value" class="slider-value">0.50</span>
            </div>
          </td>
        </tr>
        <tr>
          <td class="key">Vertical Factor:</td>
          <td colspan="5" class="value">
            <div class="slider-container">
              <input type="range" id="vertical_factor" min="0" max="100" step="1" class="slider" value="20" />
              <span id="vertical_factor_value" class="slider-value">0.20</span>
            </div>
          </td>
        </tr>
        <tr>
          <td colspan="6"></td>
        </tr>
        <tr>
          <td colspan="6" class="center" style="background: #dedede;">
            <input id="save_map" type="button" value="Save as PNG" />
            &nbsp; <input id="print_map" type="button" value="Print" />
          </td>
        </tr>
      </table>
    </form>
    <div class="center">
      <h2>World Map</h2>
      <canvas id="map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>
      
      <h2>Temperature Map</h2>
      <canvas id="temperature-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>
      
      <h2>Rainfall Map</h2>
      <canvas id="rainfall-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>
      
      <h2>Evaporation Map</h2>
      <canvas id="evaporation-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Snowfall & Perennial Snow Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        Mass balance model: Perennial snow (white) exists where annual accumulation ≥ ablation (melt + sublimation).
        Blue gradient shows snow accumulation; warmer colors show areas with net melt.
      </p>
      <canvas id="snowfall-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Whittaker Biome Model</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        Whittaker diagram classification based on temperature and rainfall (from planet.c).
      </p>
      <div style="margin: 0 2em 1em; display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px;">
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(255,255,255); border: 1px solid #ccc;"></span> Ice/Polar</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(210,210,210); border: 1px solid #ccc;"></span> Tundra</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(105,155,120); border: 1px solid #ccc;"></span> Boreal</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(155,215,170); border: 1px solid #ccc;"></span> Temperate Forest</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(170,195,200); border: 1px solid #ccc;"></span> Temperate Rain</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(250,215,165); border: 1px solid #ccc;"></span> Grassland</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(225,155,100); border: 1px solid #ccc;"></span> Steppe</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(185,150,160); border: 1px solid #ccc;"></span> Woodland</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(220,195,175); border: 1px solid #ccc;"></span> Desert</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(130,190,25); border: 1px solid #ccc;"></span> Tropical Forest</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(110,160,170); border: 1px solid #ccc;"></span> Tropical Rain</span>
        <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(65,105,170); border: 1px solid #ccc;"></span> Ocean</span>
      </div>
      <canvas id="biome-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Holdridge Life Zones</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        Classification based on biotemperature (mean annual temp with &lt;0°C and &gt;30°C treated as dormant) 
        and annual precipitation, using the PET (Potential Evapotranspiration) ratio.
      </p>
      <div style="margin: 0 2em 1em; font-size: 10px; line-height: 1.4;">
        <!-- Tropical (>24°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Tropical (&gt;24°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(0,102,51); border: 1px solid #999;"></span> Rain Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(0,128,64); border: 1px solid #999;"></span> Wet Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(34,153,84); border: 1px solid #999;"></span> Moist Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(102,170,85); border: 1px solid #999;"></span> Dry Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(170,170,85); border: 1px solid #999;"></span> Thorn Woodland</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(230,220,170); border: 1px solid #999;"></span> Desert</span>
        </div>
        <!-- Subtropical (18-24°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Subtropical (18-24°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(0,110,70); border: 1px solid #999;"></span> Rain Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(34,139,87); border: 1px solid #999;"></span> Wet Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(85,170,110); border: 1px solid #999;"></span> Moist Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(153,187,102); border: 1px solid #999;"></span> Dry Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(190,180,120); border: 1px solid #999;"></span> Thorn Woodland</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(235,225,180); border: 1px solid #999;"></span> Desert</span>
        </div>
        <!-- Warm Temperate (12-18°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Warm Temperate (12-18°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(34,102,68); border: 1px solid #999;"></span> Rain Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(60,130,90); border: 1px solid #999;"></span> Wet Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(102,160,120); border: 1px solid #999;"></span> Moist Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(170,190,130); border: 1px solid #999;"></span> Dry Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(200,200,150); border: 1px solid #999;"></span> Steppe</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(235,230,190); border: 1px solid #999;"></span> Desert</span>
        </div>
        <!-- Cool Temperate (6-12°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Cool Temperate (6-12°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(40,90,80); border: 1px solid #999;"></span> Rain Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(70,120,110); border: 1px solid #999;"></span> Wet Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(110,150,140); border: 1px solid #999;"></span> Moist Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(170,190,170); border: 1px solid #999;"></span> Dry Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(210,210,190); border: 1px solid #999;"></span> Steppe</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(235,235,215); border: 1px solid #999;"></span> Desert</span>
        </div>
        <!-- Boreal (3-6°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Boreal (3-6°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(45,80,90); border: 1px solid #999;"></span> Rain Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(70,110,130); border: 1px solid #999;"></span> Wet Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(110,140,160); border: 1px solid #999;"></span> Moist Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(160,180,190); border: 1px solid #999;"></span> Dry Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(200,210,210); border: 1px solid #999;"></span> Steppe</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(230,235,235); border: 1px solid #999;"></span> Desert</span>
        </div>
        <!-- Subpolar (1.5-3°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Subpolar (1.5-3°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(160,190,200); border: 1px solid #999;"></span> Wet Tundra</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(190,210,220); border: 1px solid #999;"></span> Moist Tundra</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(210,225,235); border: 1px solid #999;"></span> Tundra</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(225,235,240); border: 1px solid #999;"></span> Dry Tundra</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(230,240,245); border: 1px solid #999;"></span> Steppe</span>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(240,245,248); border: 1px solid #999;"></span> Desert</span>
        </div>
        <!-- Polar (<1.5°C) -->
        <div style="margin-bottom: 6px;">
          <strong>Polar (&lt;1.5°C):</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(245,245,245); border: 1px solid #999;"></span> Polar Desert</span>
        </div>
        <!-- Ocean -->
        <div>
          <strong>Ocean:</strong>
          <span style="display: inline-flex; align-items: center; gap: 2px; margin-left: 4px;"><span style="width: 12px; height: 12px; background: rgb(65,105,170); border: 1px solid #999;"></span> Ocean</span>
        </div>
      </div>
      <canvas id="holdridge-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <!-- Ecosystem Simulation Maps -->
      <div id="ecosystem-simulation-section">
        <h2>Ecosystem Maps</h2>
        <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
          Ecosystem characteristics derived from Holdridge Life Zones. Maps show initial conditions based on climate;
          use the simulation controls to model ecosystem dynamics over time (soil development, vegetation succession, fauna populations, fire cycles).
        </p>
        <div style="margin: 10px auto 20px; text-align: center; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          <button id="btn_init_ecosystem" type="button" style="padding: 10px 20px; font-size: 14px; cursor: pointer; background: #2a7d4f; color: white; border: none; border-radius: 6px;">
            Start Dynamic Simulation
          </button>
          <button id="btn_step_ecosystem_1" type="button" style="padding: 10px 20px; font-size: 14px; cursor: pointer; background: #3a8d5f; color: white; border: none; border-radius: 6px;" disabled>
            Step +1 Year
          </button>
          <button id="btn_step_ecosystem_10" type="button" style="padding: 10px 20px; font-size: 14px; cursor: pointer; background: #4a9d6f; color: white; border: none; border-radius: 6px;" disabled>
            Step +10 Years
          </button>
          <button id="btn_step_ecosystem_100" type="button" style="padding: 10px 20px; font-size: 14px; cursor: pointer; background: #5aad7f; color: white; border: none; border-radius: 6px;" disabled>
            Step +100 Years
          </button>
        </div>
        <div id="ecosystem-status" style="margin: 10px auto 20px; padding: 12px 16px; background: rgba(0,0,0,0.04); border-radius: 8px; font-family: system-ui, -apple-system, sans-serif; max-width: 800px;">
          <output id="ecosystem_readout" style="font-weight: 600; color: #333;">Showing initial conditions from climate data</output>
          <div id="ecosystem_stats" style="margin-top: 8px; font-size: 13px; color: #666; display: none;"></div>
        </div>

        <h3>Soil Map</h3>
        <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
          Soil color indicates type and composition based on organic matter, leaching, salinity, and drainage.
        </p>
        <div style="margin: 0 2em 1em; display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px;">
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(139,119,101); border: 1px solid #ccc;"></span> Typical (Inceptisol)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(178,102,76); border: 1px solid #ccc;"></span> Red (Oxisol/Ultisol)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(50,45,40); border: 1px solid #ccc;"></span> Black (Mollisol)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(235,225,200); border: 1px solid #ccc;"></span> Pale (Aridisol)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(140,145,150); border: 1px solid #ccc;"></span> Gray (Gelisol)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(30,60,100); border: 1px solid #ccc;"></span> Ocean</span>
        </div>
        <canvas id="soil-map" width="1" height="1">
          <p>Your web browser does not appear to support HTML5 canvas.</p>
        </canvas>

        <h3>Vegetation Map</h3>
        <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
          Vegetation cover shows canopy density and ground cover type based on the Holdridge life zone targets.
        </p>
        <div style="margin: 0 2em 1em; display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px;">
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(20,80,20); border: 1px solid #ccc;"></span> Dense Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(60,120,60); border: 1px solid #ccc;"></span> Open Forest</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(100,160,80); border: 1px solid #ccc;"></span> Woodland</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(180,200,80); border: 1px solid #ccc;"></span> Grassland</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(100,140,90); border: 1px solid #ccc;"></span> Moss/Tundra</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(139,90,43); border: 1px solid #ccc;"></span> Litter Floor</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(180,160,130); border: 1px solid #ccc;"></span> Desert Crust</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(200,180,150); border: 1px solid #ccc;"></span> Sparse/Bare</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(30,50,90); border: 1px solid #ccc;"></span> Ocean</span>
        </div>
        <canvas id="vegetation-map" width="1" height="1">
          <p>Your web browser does not appear to support HTML5 canvas.</p>
        </canvas>

        <h3>Fauna Map</h3>
        <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
          Fauna guild abundance encoded as RGB color channels. Brightness indicates total biodiversity.
        </p>
        <div style="margin: 0 2em 1em; display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px;">
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(240,60,60); border: 1px solid #ccc;"></span> <strong>R:</strong> Large Mammals</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(60,240,60); border: 1px solid #ccc;"></span> <strong>G:</strong> Invertebrates + Amphibians</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(60,60,240); border: 1px solid #ccc;"></span> <strong>B:</strong> Reptiles + Birds</span>
        </div>
        <div style="margin: 0 2em 1em; display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px;">
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(240,240,60); border: 1px solid #ccc;"></span> Savanna (mammals + invertebrates)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(60,240,240); border: 1px solid #ccc;"></span> Wetland (invertebrates + birds)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(240,60,240); border: 1px solid #ccc;"></span> Desert (mammals + reptiles)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(240,240,240); border: 1px solid #ccc;"></span> High Diversity (all guilds)</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(60,60,60); border: 1px solid #ccc;"></span> Low Diversity</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(30,50,90); border: 1px solid #ccc;"></span> Ocean</span>
        </div>
        <canvas id="fauna-map" width="1" height="1">
          <p>Your web browser does not appear to support HTML5 canvas.</p>
        </canvas>

        <h3>Fire Risk Map</h3>
        <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
          Composite fire danger based on annual fire probability, fuel load, and dryness.
        </p>
        <div style="margin: 0 2em 1em; display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px;">
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(0,200,80); border: 1px solid #ccc;"></span> Very Low</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(128,228,40); border: 1px solid #ccc;"></span> Low</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(255,255,0); border: 1px solid #ccc;"></span> Moderate</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(255,180,0); border: 1px solid #ccc;"></span> High</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(255,100,0); border: 1px solid #ccc;"></span> Very High</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(255,0,0); border: 1px solid #ccc;"></span> Extreme</span>
          <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="width: 16px; height: 16px; background: rgb(30,50,90); border: 1px solid #ccc;"></span> Ocean</span>
        </div>
        <canvas id="fire-risk-map" width="1" height="1">
          <p>Your web browser does not appear to support HTML5 canvas.</p>
        </canvas>
      </div>

      <div id="simulation-status" style="margin: 20px 0; padding: 12px 16px; background: rgba(0,0,0,0.04); border-radius: 8px; font-family: system-ui, -apple-system, sans-serif;">
        <output id="sim_time_readout" style="font-weight: 600; color: #333;">Simulation: Ready</output>
        <span id="sim_progress_readout" style="margin-left: 12px; color: #666;"></span>
      </div>

      <h2>River Map</h2>
      <canvas id="river-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Coastline Map</h2>
      <canvas id="coastline-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Water Cover Map</h2>
      <canvas id="lake-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Ice Cap Classification</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        Mass-balance driven classification: <span style="color: #F8FFFF;">■</span> Ice Caps (large, low-relief, thick),
        <span style="color: #88B8F0;">■</span> Glaciers (smaller/steeper),
        <span style="color: #E0E0E8;">■</span> Perennial Snowfields.
      </p>
      <canvas id="icecap-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Terrain Map (with Erosion)</h2>
      <canvas id="terrain-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Final Simulated Map</h2>
      <canvas id="final-map" width="1" height="1">
        <p>Your web browser does not appear to support HTML5 canvas.</p>
      </canvas>

      <h2>Islands-Style WebGL Terrain</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated terrain rendering with elevation-based coloring, hillshade, and water effects.
      </p>
      <canvas id="islands-webgl-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>
      <div id="webgl-controls" style="margin: 10px auto; max-width: 600px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 20px;">
          <input type="checkbox" id="webgl_show_coastlines" checked /> Show Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_show_rivers" checked /> Show Rivers
        </label>
      </div>

      <!-- ================================================================ -->
      <!-- Islands-Style WebGL Multi-Mode Maps                             -->
      <!-- GPU-accelerated versions of each data layer with projection     -->
      <!-- support (Square, Mercator, Mollweide, Sinusoidal)               -->
      <!-- ================================================================ -->

      <h2>WebGL Temperature Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated temperature visualization with hillshade. Blue (cold) to Red (hot).
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_temp_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_temp_hillshade" checked /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_temp_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_temp_rivers" /> Rivers
        </label>
      </div>
      <canvas id="webgl-temperature-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Rainfall Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated rainfall visualization. Tan (dry) to Blue (wet), measured in mm/year.
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_rain_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_rain_hillshade" checked /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_rain_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_rain_rivers" checked /> Rivers
        </label>
      </div>
      <canvas id="webgl-rainfall-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Evaporation Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated evaporation visualization. Low (blue) to High (red), measured in mm/year equivalent.
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_evap_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_evap_hillshade" checked /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_evap_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_evap_rivers" /> Rivers
        </label>
      </div>
      <canvas id="webgl-evaporation-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Snowfall Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated snow accumulation. Brown (no snow) to White (permanent snow), in mm/year.
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_snow_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_snow_hillshade" checked /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_snow_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_snow_rivers" /> Rivers
        </label>
      </div>
      <canvas id="webgl-snowfall-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Whittaker Biome Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated Whittaker biome classification with optional hillshade overlay.
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_biome_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_biome_hillshade" /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_biome_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_biome_rivers" checked /> Rivers
        </label>
      </div>
      <canvas id="webgl-biome-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Holdridge Life Zone Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated Holdridge Life Zone classification based on biotemperature and PET ratio.
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_holdridge_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_holdridge_hillshade" /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_holdridge_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_holdridge_rivers" checked /> Rivers
        </label>
      </div>
      <canvas id="webgl-holdridge-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Ice Cap Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated ice classification: Perennial Snow (light), Glaciers (blue), Ice Caps (white).
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_ice_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_ice_hillshade" checked /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_ice_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_ice_rivers" /> Rivers
        </label>
      </div>
      <canvas id="webgl-icecap-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <h2>WebGL Elevation Map</h2>
      <p style="margin: 0 2em 1em; color: #666; font-size: 13px;">
        GPU-accelerated terrain elevation with full ocean depth visualization and hillshade.
      </p>
      <div class="webgl-multi-controls" style="margin: 0 auto 10px; max-width: 700px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 6px;">
        <label style="margin-right: 15px;">
          Projection: 
          <select id="webgl_elev_projection" style="padding: 2px 6px;">
            <option value="square" selected>Square (Equirectangular)</option>
            <option value="mercator">Mercator</option>
            <option value="mollweide">Mollweide (Equal-Area)</option>
            <option value="sinusoidal">Sinusoidal</option>
          </select>
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_elev_hillshade" checked /> Hillshade
        </label>
        <label style="margin-right: 15px;">
          <input type="checkbox" id="webgl_elev_coastlines" checked /> Coastlines
        </label>
        <label>
          <input type="checkbox" id="webgl_elev_rivers" checked /> Rivers
        </label>
      </div>
      <canvas id="webgl-elevation-map" width="1" height="1" style="border: 1px solid #ccc; background: #1a3a5c;">
        <p>Your web browser does not appear to support WebGL.</p>
      </canvas>

      <p class="control"><b>Time:</b> <span id="dt"></span> seconds</p>
    </div>

    <!-- Cell info tooltip (Islands-style) -->
    <div id="cell_info"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.3/prototype.js"></script>
    <script src="./js/cell-data-model.js"></script>
    <script src="./js/ecosystem-templates.js"></script>
    <script src="./js/holdridge-simulation.js"></script>
    <script src="./js/erosion-simulation.js"></script>
    <script src="./js/islands-webgl-renderer.js"></script>
    <script src="./js/islands-webgl-multi-renderer.js"></script>
    <script src="./js/world.js"></script>
    <script src="./js/canvas.js"></script>
    <script src="./js/custom-seeded-random.js"></script>

    <script>
      // Wait for both DOM and all scripts to be fully loaded
      window.onload = function() {
        // Check if updateMap function exists before setting up event handlers
        if (typeof updateMap !== "function") {
          console.error("Error: updateMap function not available. Make sure world.js is loaded properly.");
          return;
        }
        
        // Set up terrain variation slider
        const terrainSlider = $('terrain_variation');
        const terrainValueDisplay = $('terrain_variation_value');
        
        terrainSlider.observe('input', function() {
          const value = terrainSlider.value;
          terrainValueDisplay.update(value + '%');
          // Don't call updateMap directly here as it might trigger too many redraws
        });

        // Set up terrain variation change event (fires when slider is released)
        terrainSlider.observe('change', updateMap);

        // Set up horizontal factor slider
        const horizontalSlider = $('horizontal_factor');
        const horizontalValueDisplay = $('horizontal_factor_value');
        
        horizontalSlider.observe('input', function() {
          const value = (horizontalSlider.value / 100).toFixed(2);
          horizontalValueDisplay.update(value);
          // Don't call updateMap directly here
        });
        
        // Horizontal factor change event
        horizontalSlider.observe('change', updateMap);

        // Set up vertical factor slider
        const verticalSlider = $('vertical_factor');
        const verticalValueDisplay = $('vertical_factor_value');
        
        verticalSlider.observe('input', function() {
          const value = (verticalSlider.value / 100).toFixed(2);
          verticalValueDisplay.update(value);
          // Don't call updateMap directly here
        });
        
        // Vertical factor change event
        verticalSlider.observe('change', updateMap);

        // Set up algorithm dropdown
        $('algorithm').observe('change', updateMap);

        // Set up checkbox events
        $('erode').observe('change', updateMap);
        $('enable_hack_theta').observe('change', updateMap);
        $('ocean_currents').observe('change', updateMap);
        
        // Set up time simulation controls
        const timeSimCheckbox = $('enable_time_simulation');
        const timeSlider = $('time_passage');
        const timeValueDisplay = $('time_passage_value');
        
        timeSlider.observe('input', function() {
          const value = timeSlider.value;
          timeValueDisplay.update(value + ' MY');
        });
        
        timeSlider.observe('change', function() {
          if (timeSimCheckbox.checked) {
            updateMap();
          }
        });
        
        timeSimCheckbox.observe('change', updateMap);
        
        // Set up river and coastline toggles
        $('show_rivers').observe('change', updateMap);
        $('show_coastlines').observe('change', updateMap);
        
        // ================================================================
        // Cell Info Tooltip (Islands-style mouse tracking)
        // ================================================================
        const cellInfoEl = document.getElementById('cell_info');
        const mapCanvas = document.getElementById('map');
        let mouseInCanvas = false;
        let mouseX = 0;
        let mouseY = 0;
        
        // Track mouse position over the main map canvas
        mapCanvas.addEventListener('mousemove', function(event) {
          const rect = mapCanvas.getBoundingClientRect();
          mouseX = event.clientX - rect.left;
          mouseY = event.clientY - rect.top;
          
          // Position tooltip near cursor
          cellInfoEl.style.left = (event.clientX + 20) + 'px';
          cellInfoEl.style.top = (event.clientY + 20) + 'px';
          
          updateCellInfo();
        });
        
        mapCanvas.addEventListener('mouseenter', function() {
          mouseInCanvas = true;
          cellInfoEl.classList.add('visible');
        });
        
        mapCanvas.addEventListener('mouseleave', function() {
          mouseInCanvas = false;
          cellInfoEl.classList.remove('visible');
        });
        
        function updateCellInfo() {
          if (!mouseInCanvas || !window.worldCellData) {
            cellInfoEl.textContent = '';
            return;
          }
          
          const cellData = window.worldCellData;
          const scaleX = cellData.cols / mapCanvas.width;
          const scaleY = cellData.rows / mapCanvas.height;
          
          const col = Math.floor(mouseX * scaleX);
          const row = Math.floor(mouseY * scaleY);
          
          if (row < 0 || row >= cellData.rows || col < 0 || col >= cellData.cols) {
            cellInfoEl.textContent = '';
            return;
          }
          
          const cell = row * cellData.cols + col;
          const info = cellData.getCellInfo(cell);
          
          // Format tooltip with full layer stack
          const lines = [];
          lines.push(`Cell ${info.cell} (${info.status})`);
          lines.push('');
          
          // Layer stack (bottom to top) - always show all layers
          lines.push('─── Layer Stack ───');
          lines.push(`  Bedrock surface: ${info.bedrockSurface.toFixed(1)} m`);
          lines.push(`  + Sediment: ${info.sedimentThickness.toFixed(1)} m → Ground: ${info.groundElevation.toFixed(1)} m`);
          
          // Water layer (always show, indicate type or "none")
          const waterLabel = info.waterType ? `+ ${info.waterType}` : '+ Water';
          if (info.waterThickness > 0.01) {
            lines.push(`  ${waterLabel}: ${info.waterThickness.toFixed(1)} m → Surface: ${info.waterElevation.toFixed(1)} m`);
          } else {
            lines.push(`  + Water: 0.0 m`);
          }
          
          // Ice layer (always show, indicate type or "none")
          const iceLabel = info.iceType ? `+ ${info.iceType}` : '+ Ice';
          if (info.iceThickness > 0.01) {
            lines.push(`  ${iceLabel}: ${info.iceThickness.toFixed(1)} m → Top: ${info.iceElevation.toFixed(1)} m`);
          } else {
            lines.push(`  + Ice: 0.0 m`);
          }
          
          // Snow layer (always show)
          if (info.snowThickness > 0.01) {
            lines.push(`  + Snow: ${info.snowThickness.toFixed(1)} m → Top: ${info.snowElevation.toFixed(1)} m`);
          } else {
            lines.push(`  + Snow: 0.0 m`);
          }
          
          lines.push('');
          lines.push(`Overall Elevation: ${info.surface.toFixed(1)} m`);
          lines.push(`Sea Level: ${info.seaLevel.toFixed(1)} m (${info.surfaceVsSea >= 0 ? '+' : ''}${info.surfaceVsSea.toFixed(1)} m vs sea)`);
          lines.push('');
          
          // Climate data
          lines.push(`Temperature: ${info.temperature.toFixed(1)}°C (warmest: ${info.warmestMonthTemp.toFixed(1)}°C)`);
          lines.push(`Rainfall: ${info.rainfall.toFixed(0)} mm/year`);
          lines.push(`Evaporation: ${info.evaporation.toFixed(0)} mm/year`);
          lines.push(`Whittaker Biome: ${info.biomeName}`);
          lines.push(`Holdridge Zone: ${info.holdridgeZoneName}`);
          lines.push(`  (Biotemperature: ${info.biotemperature.toFixed(1)}°C, PET Ratio: ${info.petRatio.toFixed(2)})`);
          lines.push('');
          
          // Mass balance
          lines.push(`Snow fraction: ${(info.snowFraction * 100).toFixed(0)}%`);
          lines.push(`Accum: ${info.snowAccumulation.toFixed(0)} mm, Ablation: ${info.snowAblation.toFixed(0)} mm`);
          lines.push(`Balance: ${info.snowMassBalance >= 0 ? '+' : ''}${info.snowMassBalance.toFixed(0)} mm/yr`);
          if (info.localRelief > 0) {
            lines.push(`Local relief: ${info.localRelief.toFixed(0)} m`);
          }
          
          // Ice classification
          if (info.isIceCap) {
            lines.push('🏔️ ICE CAP (patch #' + info.icePatchId + ')');
          } else if (info.isGlacier) {
            lines.push('🧊 GLACIER (patch #' + info.icePatchId + ')');
          } else if (info.hasPerennialSnow) {
            lines.push('❄️ PERENNIAL SNOW');
          }
          
          // ================================================================
          // ECOSYSTEM DATA
          // ================================================================
          
          // Only show ecosystem data if we're on land (not ocean)
          if (info.holdridgeIndex !== 255) {
            lines.push('');
            lines.push('─── Ecosystem ───');
            
            // Soil section
            lines.push(`🪨 Soil: ${info.soilTypeName} (${info.soilTextureName})`);
            lines.push(`   Depth: ${info.soilDepth.toFixed(2)} m`);
            if (info.soilOrganicMatter > 0.01) {
              lines.push(`   Organic Matter: ${(info.soilOrganicMatter * 100).toFixed(1)}%`);
            }
            if (info.soilMoisture > 0 || info.fieldCapacity > 0) {
              lines.push(`   Moisture: ${info.soilMoisture.toFixed(0)} mm / ${info.fieldCapacity.toFixed(0)} mm capacity`);
            }
            if (info.soilSalinity > 0.05) {
              lines.push(`   ⚠️ Saline: ${(info.soilSalinity * 100).toFixed(0)}%`);
            }
            if (info.soilWaterlogging > 0.3) {
              lines.push(`   💧 Waterlogged: ${(info.soilWaterlogging * 100).toFixed(0)}%`);
            }
            if (info.soilPermafrost) {
              lines.push('   🧊 Permafrost present');
            }
            
            // Vegetation section
            lines.push('');
            lines.push(`🌿 Vegetation: ${(info.vegCover * 100).toFixed(0)}% cover`);
            if (info.vegCanopy > 0.01) {
              lines.push(`   Canopy: ${(info.vegCanopy * 100).toFixed(0)}%`);
            }
            lines.push(`   Ground: ${info.vegGroundCoverModeName} (${(info.vegGroundCover * 100).toFixed(0)}%)`);
            if (info.vegNPP > 0) {
              lines.push(`   NPP: ${info.vegNPP.toFixed(0)} g C/m²/yr`);
            }
            
            // Fauna section
            lines.push('');
            const totalFauna = info.faunaTotalAbundance;
            if (totalFauna > 0.01) {
              lines.push(`🦌 Fauna: ${(totalFauna * 100).toFixed(0)}% abundance`);
              lines.push(`   Dominant: ${info.faunaDominantGuild}`);
              // Show individual guilds if notable
              const guilds = [];
              if (info.faunaGrazers > 0.1) guilds.push(`Grazers ${(info.faunaGrazers * 100).toFixed(0)}%`);
              if (info.faunaBrowsers > 0.1) guilds.push(`Browsers ${(info.faunaBrowsers * 100).toFixed(0)}%`);
              if (info.faunaPredators > 0.05) guilds.push(`Predators ${(info.faunaPredators * 100).toFixed(0)}%`);
              if (info.faunaBirds > 0.1) guilds.push(`Birds ${(info.faunaBirds * 100).toFixed(0)}%`);
              if (guilds.length > 0) {
                lines.push(`   ${guilds.join(', ')}`);
              }
            } else {
              lines.push('🦌 Fauna: Sparse');
            }
            
            // Fire section
            lines.push('');
            lines.push(`🔥 Fire Risk: ${info.fireRiskCategory} (${(info.fireRisk * 100).toFixed(0)}%)`);
            lines.push(`   Fuel Load: ${(info.vegFuelLoad * 100).toFixed(0)}%`);
            if (info.yearsSinceFire > 0) {
              lines.push(`   Years since fire: ${info.yearsSinceFire}`);
            }
          }
          
          cellInfoEl.textContent = lines.join('\n');
        }
        
        // ================================================================
        // Islands-Style WebGL Renderer Setup
        // ================================================================
        const webglCanvas = document.getElementById('islands-webgl-map');
        let webglRenderer = null;
        
        // Set up WebGL controls
        const webglShowCoastlines = document.getElementById('webgl_show_coastlines');
        const webglShowRivers = document.getElementById('webgl_show_rivers');
        
        if (webglShowCoastlines) {
          webglShowCoastlines.addEventListener('change', function() {
            if (webglRenderer) {
              webglRenderer.options.showCoastlines = this.checked;
              webglRenderer.render();
            }
          });
        }
        
        if (webglShowRivers) {
          webglShowRivers.addEventListener('change', function() {
            if (webglRenderer) {
              webglRenderer.options.showRivers = this.checked;
              webglRenderer.render();
            }
          });
        }
        
        // Create a MutationObserver to detect when cell data is ready/updated
        // This watches for the worldCellData global to be set
        let lastCellDataUpdate = 0;
        
        function initOrUpdateWebGLRenderer() {
          if (!window.worldCellData) return;
          if (!window.IslandsWebGLRenderer) {
            console.warn('IslandsWebGLRenderer not available');
            return;
          }
          
          const cellData = window.worldCellData;
          
          // Create renderer if needed
          if (!webglRenderer) {
            webglRenderer = new window.IslandsWebGLRenderer(webglCanvas, cellData, {
              showCoastlines: webglShowCoastlines?.checked !== false,
              showRivers: webglShowRivers?.checked !== false,
              meanSeaLevel: cellData.config?.meanSeaLevel || 2000,
              lakeThreshold: cellData.config?.lakeThreshold || 5
            });
            
            if (!webglRenderer.init()) {
              console.error('Failed to initialize WebGL renderer');
              webglRenderer = null;
              return;
            }
          } else {
            // Update cell data reference
            webglRenderer.cellData = cellData;
          }
          
          // Render
          webglRenderer.render();
        }
        
        // Hook into the updateMap function to trigger WebGL re-renders
        // We poll periodically for worldCellData changes since map generation is async
        let webglUpdateInterval = setInterval(function() {
          if (window.worldCellData) {
            const cellData = window.worldCellData;
            // Check if data was recently updated (by checking a timestamp if available)
            if (cellData._lastUpdate !== lastCellDataUpdate) {
              lastCellDataUpdate = cellData._lastUpdate || Date.now();
              initOrUpdateWebGLRenderer();
              initOrUpdateMultiModeRenderers();
            }
          }
        }, 500);
        
        // Also trigger on initial load after a delay
        setTimeout(function() {
          initOrUpdateWebGLRenderer();
          initOrUpdateMultiModeRenderers();
        }, 1500);
        
        // ================================================================
        // Islands-Style Multi-Mode WebGL Renderers Setup
        // ================================================================
        
        // Configuration for each multi-mode WebGL map
        const multiModeConfigs = [
          { id: 'webgl-temperature-map', mode: 'temperature', prefix: 'webgl_temp' },
          { id: 'webgl-rainfall-map', mode: 'rainfall', prefix: 'webgl_rain' },
          { id: 'webgl-evaporation-map', mode: 'evaporation', prefix: 'webgl_evap' },
          { id: 'webgl-snowfall-map', mode: 'snowfall', prefix: 'webgl_snow' },
          { id: 'webgl-biome-map', mode: 'biome', prefix: 'webgl_biome' },
          { id: 'webgl-holdridge-map', mode: 'holdridge', prefix: 'webgl_holdridge' },
          { id: 'webgl-icecap-map', mode: 'icecap', prefix: 'webgl_ice' },
          { id: 'webgl-elevation-map', mode: 'elevation', prefix: 'webgl_elev' }
        ];
        
        // Store renderers
        const multiModeRenderers = {};
        
        // Initialize or update all multi-mode renderers
        function initOrUpdateMultiModeRenderers() {
          if (!window.worldCellData) return;
          if (!window.IslandsWebGLMultiRenderer) {
            console.warn('IslandsWebGLMultiRenderer not available');
            return;
          }
          
          const cellData = window.worldCellData;
          
          for (const config of multiModeConfigs) {
            const canvas = document.getElementById(config.id);
            if (!canvas) continue;
            
            // Get control elements
            const projectionSelect = document.getElementById(config.prefix + '_projection');
            const hillshadeCheck = document.getElementById(config.prefix + '_hillshade');
            const coastlinesCheck = document.getElementById(config.prefix + '_coastlines');
            const riversCheck = document.getElementById(config.prefix + '_rivers');
            
            const projection = projectionSelect?.value || 'square';
            const showHillshade = hillshadeCheck?.checked !== false;
            const showCoastlines = coastlinesCheck?.checked !== false;
            const showRivers = riversCheck?.checked || false;
            
            // Create renderer if needed
            if (!multiModeRenderers[config.id]) {
              const renderer = new window.IslandsWebGLMultiRenderer(canvas, cellData, {
                mode: config.mode,
                projection: projection,
                showHillshade: showHillshade,
                showCoastlines: showCoastlines,
                showRivers: showRivers,
                meanSeaLevel: cellData.config?.meanSeaLevel || 2000,
                lakeThreshold: cellData.config?.lakeThreshold || 5
              });
              
              if (!renderer.init()) {
                console.error('Failed to initialize WebGL multi-renderer for ' + config.id);
                continue;
              }
              
              multiModeRenderers[config.id] = renderer;
              
              // Set up event listeners for this renderer
              setupMultiModeControls(config, renderer);
            } else {
              // Update existing renderer
              const renderer = multiModeRenderers[config.id];
              renderer.cellData = cellData;
              
              // Check if projection changed (requires shader recompile)
              if (renderer.options.projection !== projection) {
                renderer.setProjection(projection);
              }
              
              renderer.options.showHillshade = showHillshade;
              renderer.options.showCoastlines = showCoastlines;
              renderer.options.showRivers = showRivers;
            }
            
            // Render
            multiModeRenderers[config.id].render();
          }
        }
        
        // Set up controls for a single multi-mode renderer
        function setupMultiModeControls(config, renderer) {
          const projectionSelect = document.getElementById(config.prefix + '_projection');
          const hillshadeCheck = document.getElementById(config.prefix + '_hillshade');
          const coastlinesCheck = document.getElementById(config.prefix + '_coastlines');
          const riversCheck = document.getElementById(config.prefix + '_rivers');
          
          if (projectionSelect) {
            projectionSelect.addEventListener('change', function() {
              renderer.setProjection(this.value);
              renderer.render();
            });
          }
          
          if (hillshadeCheck) {
            hillshadeCheck.addEventListener('change', function() {
              renderer.options.showHillshade = this.checked;
              renderer.render();
            });
          }
          
          if (coastlinesCheck) {
            coastlinesCheck.addEventListener('change', function() {
              renderer.options.showCoastlines = this.checked;
              renderer.render();
            });
          }
          
          if (riversCheck) {
            riversCheck.addEventListener('change', function() {
              renderer.options.showRivers = this.checked;
              renderer.render();
            });
          }
        }
        
        // Initial attempt to initialize multi-mode renderers
        setTimeout(initOrUpdateMultiModeRenderers, 2000);
        
        // ================================================================
        // Ecosystem Simulation Controls
        // ================================================================
        const ecosystemReadout = document.getElementById('ecosystem_readout');
        const ecosystemStats = document.getElementById('ecosystem_stats');
        const btnInit = document.getElementById('btn_init_ecosystem');
        const btnStep1 = document.getElementById('btn_step_ecosystem_1');
        const btnStep10 = document.getElementById('btn_step_ecosystem_10');
        const btnStep100 = document.getElementById('btn_step_ecosystem_100');
        
        let holdridgeSim = null;
        
        // Get image config from the main map canvas for ecosystem rendering
        function getEcosystemImageConfig() {
          const mainCanvas = document.getElementById('map');
          return {
            width: mainCanvas.width || 800,
            height: mainCanvas.height || 600
          };
        }
        
        // Update ecosystem status display
        function updateEcosystemStatus() {
          if (!holdridgeSim) {
            ecosystemReadout.textContent = 'Ecosystem: Not initialized';
            ecosystemStats.style.display = 'none';
            return;
          }
          
          const stats = holdridgeSim.getStats();
          ecosystemReadout.textContent = `Ecosystem: Year ${stats.simulationYear}`;
          
          ecosystemStats.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
              <span>🌱 Avg Veg Cover: ${(stats.avgVegCover * 100).toFixed(1)}%</span>
              <span>🌲 Avg Canopy: ${(stats.avgCanopy * 100).toFixed(1)}%</span>
              <span>🪱 Avg Soil OM: ${(stats.avgSoilOM * 100).toFixed(2)}%</span>
              <span>🦌 Avg Fauna: ${(stats.avgFaunaBiomass * 100).toFixed(1)}%</span>
              <span>🔥 Fires This Year: ${stats.fireEventsThisYear}</span>
              <span>🗺️ Land Cells: ${stats.landCells.toLocaleString()}</span>
            </div>
          `;
          ecosystemStats.style.display = 'block';
        }
        
        // Initialize ecosystem simulation
        if (btnInit) {
          btnInit.addEventListener('click', function() {
            if (!window.worldCellData) {
              alert('Generate a world first!');
              return;
            }
            
            btnInit.disabled = true;
            btnInit.textContent = 'Initializing...';
            
            setTimeout(function() {
              try {
                // Create simulation
                holdridgeSim = new HoldridgeSimulation(window.worldCellData);
                holdridgeSim.initialize();
                
                // Render initial maps
                const imageConfig = getEcosystemImageConfig();
                const mapConfig = window.worldMapConfig || { rpx: 0 };
                window.renderAllEcosystemMaps(mapConfig, imageConfig);
                
                // Enable step buttons
                btnStep1.disabled = false;
                btnStep10.disabled = false;
                btnStep100.disabled = false;
                
                btnInit.textContent = 'Re-Initialize';
                btnInit.disabled = false;
                
                updateEcosystemStatus();
                
                console.log('Ecosystem simulation initialized');
              } catch (e) {
                console.error('Failed to initialize ecosystem:', e);
                alert('Failed to initialize ecosystem simulation: ' + e.message);
                btnInit.disabled = false;
                btnInit.textContent = 'Initialize Ecosystem';
              }
            }, 50);
          });
        }
        
        // Step 1 year
        if (btnStep1) {
          btnStep1.addEventListener('click', function() {
            if (!holdridgeSim) return;
            
            btnStep1.textContent = 'Running...';
            btnStep1.disabled = true;
            
            setTimeout(function() {
              holdridgeSim.stepYear();
              
              const imageConfig = getEcosystemImageConfig();
              const mapConfig = window.worldMapConfig || { rpx: 0 };
              window.renderAllEcosystemMaps(mapConfig, imageConfig);
              
              updateEcosystemStatus();
              
              btnStep1.textContent = 'Step +1 Year';
              btnStep1.disabled = false;
            }, 10);
          });
        }
        
        // Step 10 years
        if (btnStep10) {
          btnStep10.addEventListener('click', function() {
            if (!holdridgeSim) return;
            
            btnStep10.textContent = 'Running...';
            btnStep10.disabled = true;
            
            setTimeout(function() {
              holdridgeSim.stepYears(10, function(year, total) {
                ecosystemReadout.textContent = `Ecosystem: Running year ${year}/${total}...`;
              });
              
              const imageConfig = getEcosystemImageConfig();
              const mapConfig = window.worldMapConfig || { rpx: 0 };
              window.renderAllEcosystemMaps(mapConfig, imageConfig);
              
              updateEcosystemStatus();
              
              btnStep10.textContent = 'Step +10 Years';
              btnStep10.disabled = false;
            }, 10);
          });
        }
        
        // Step 100 years
        if (btnStep100) {
          btnStep100.addEventListener('click', function() {
            if (!holdridgeSim) return;
            
            btnStep100.textContent = 'Running...';
            btnStep100.disabled = true;
            
            // Run in chunks to allow UI updates
            let year = 0;
            const totalYears = 100;
            const chunkSize = 10;
            
            function runChunk() {
              const endYear = Math.min(year + chunkSize, totalYears);
              
              while (year < endYear) {
                holdridgeSim.stepYear();
                year++;
              }
              
              ecosystemReadout.textContent = `Ecosystem: Running year ${year}/${totalYears}...`;
              
              if (year < totalYears) {
                setTimeout(runChunk, 10);
              } else {
                // Done
                const imageConfig = getEcosystemImageConfig();
                const mapConfig = window.worldMapConfig || { rpx: 0 };
                window.renderAllEcosystemMaps(mapConfig, imageConfig);
                
                updateEcosystemStatus();
                
                btnStep100.textContent = 'Step +100 Years';
                btnStep100.disabled = false;
              }
            }
            
            setTimeout(runChunk, 10);
          });
        }
        
        // Store simulation reference globally for debugging
        window.holdridgeSim = holdridgeSim;
      };
    </script>
  </body>
</html>
