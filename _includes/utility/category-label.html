{%- comment -%}
  Unified category label renderer (uses category_registry.yml)
  Params:
    category (string) - required raw name or canonical slug
    as, href, class_extra, text_override, debug (same as before)
{%- endcomment -%}
{% assign raw_category = include.category | to_s | strip %}
{% assign registry = site.data.category_registry %}
{%- assign canonical = nil -%}
{%- comment -%} First try direct key (already a slug) {%- endcomment -%}
{% if registry[raw_category] %}
  {% assign canonical = raw_category %}
{% else %}
  {%- comment -%} Search raw_names arrays case-insensitively {%- endcomment -%}
  {% assign lower = raw_category | downcase %}
  {% for pair in registry %}
    {% assign slug = pair[0] %}
    {% assign data = pair[1] %}
    {% if canonical %}{% break %}{% endif %}
    {% if data.raw_names %}
      {% for variant in data.raw_names %}
        {% if variant and variant downcase == lower %}
          {% assign canonical = slug %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endif %}
{% if canonical == nil %}
  {% assign canonical = raw_category | slugify %}
{% endif %}
{% assign entry = registry[canonical] %}
{% assign label_text = include.text_override | default: entry.label | default: entry.title | default: raw_category %}
{% assign class_to_add = entry.class | default: canonical %}
{% if include.href and include.href != '' %}
  {% assign element = 'a' %}
{% else %}
  {% assign element = include.as | default: 'span' %}
{% endif %}
<span class="category-theme" data-category="{{ raw_category | escape }}" data-cat="{{ canonical }}">
  <{{element}} {% if include.href and include.href != '' %}href="{{ include.href }}"{% endif %} class="{{ class_to_add }}{% if include.class_extra %} {{ include.class_extra }}{% endif %}">{{ label_text }}</{{element}}>
</span>{% if include.debug %}<!-- raw:'{{raw_category}}' canonical:'{{canonical}}' class:'{{class_to_add}}' text:'{{label_text}}' -->{% endif %}
