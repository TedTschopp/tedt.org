<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fix for Variable Display</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #222; color: #fff; }
        .prompt-content { background: #333; padding: 20px; border-radius: 5px; white-space: pre-wrap; }
        .variables-form { margin: 20px 0; padding: 20px; background: #444; border-radius: 5px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, select { padding: 5px; margin-bottom: 10px; width: 200px; }
        button { padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 3px; cursor: pointer; }
        #original-prompt { display: block; }
        #customized-prompt { display: none; }
    </style>
</head>
<body>
    <h1>Test Variable Replacement Fix</h1>
    
    <div class="variables-form">
        <h2>Test Variables</h2>
        <div class="form-group">
            <label for="paper_title">Paper Title:</label>
            <input type="text" id="paper_title" data-variable="paper_title" placeholder="Enter paper title">
        </div>
        <div class="form-group">
            <label for="author_names">Author(s):</label>
            <input type="text" id="author_names" data-variable="author_names" placeholder="Enter author names">
        </div>
        <div class="form-group">
            <label for="critique_depth">Critique Depth:</label>
            <select id="critique_depth" data-variable="critique_depth">
                <option value="brief overview">Brief Overview</option>
                <option value="standard analysis" selected>Standard Analysis</option>
                <option value="comprehensive evaluation">Comprehensive Evaluation</option>
            </select>
        </div>
        <button type="button" onclick="updatePreview()">Update Preview</button>
        <button type="button" onclick="resetForm()">Reset</button>
    </div>

    <div>
        <h2>Original Prompt (should show placeholders AND XML tags):</h2>
        <div class="prompt-content" id="original-prompt">**Critique Level:** {{critique_depth}}
**Paper Title:** {{paper_title}}
**Author(s):** {{author_names}}

## Introduction

&lt;Purpose&gt;
* Clearly introduce the critique by summarizing the paper's identity and key message.
* State explicitly the main point or argument presented by the original author.
&lt;/Purpose&gt;

&lt;Instructions&gt;
* Identify and state the full name(s) of the paper's author(s) exactly as listed on the paper.
* Provide the complete, accurately formatted title of the article being critiqued.
&lt;/Instructions&gt;

This is a test prompt with variables that should show as placeholders until user fills them.</div>
        
        <h2>Customized Prompt (should show only when user inputs values):</h2>
        <div class="prompt-content" id="customized-prompt">Customized content will appear here...</div>
    </div>

    <script>
        // Simulate the fixed JavaScript from prompt-details.html
        let originalPrompt = `**Critique Level:** {{critique_depth}}
**Paper Title:** {{paper_title}}
**Author(s):** {{author_names}}

## Introduction

<Purpose>
* Clearly introduce the critique by summarizing the paper's identity and key message.
* State explicitly the main point or argument presented by the original author.
</Purpose>

<Instructions>
* Identify and state the full name(s) of the paper's author(s) exactly as listed on the paper.
* Provide the complete, accurately formatted title of the article being critiqued.
</Instructions>

This is a test prompt with variables that should show as placeholders until user fills them.`;
        
        let customizedPrompt = originalPrompt;
        
        let variableDefinitions = [
            { name: "paper_title", default: "" },
            { name: "author_names", default: "" },
            { name: "critique_depth", default: "standard analysis" }
        ];

        // Fixed function to replace variables only when they have real values
        function replaceVariables(content, variables) {
            let result = content;
            
            // Only replace variables that have actual values (not empty or just default values)
            for (const [key, value] of Object.entries(variables)) {
                const variable = variableDefinitions.find(v => v.name === key);
                const hasRealValue = value && value.trim() !== '' && value !== (variable?.default || '');
                
                if (hasRealValue) {
                    // Handle both {{variable}} and {{ variable }} formats
                    const regex = new RegExp(`\\{\\{\\s*${key}\\s*\\}\\}`, 'g');
                    result = result.replace(regex, value);
                }
            }
            return result;
        }

        function collectVariableValues() {
            const values = {};
            variableDefinitions.forEach(variable => {
                const element = document.querySelector(`[data-variable="${variable.name}"]`);
                values[variable.name] = element ? element.value : (variable.default || '');
            });
            return values;
        }

        function updatePreview() {
            const variables = collectVariableValues();
            
            // Check if any variables have been filled with actual user input (not just defaults)
            const hasUserInput = Object.entries(variables).some(([key, value]) => {
                const variable = variableDefinitions.find(v => v.name === key);
                return value && value.trim() !== '' && value !== (variable?.default || '');
            });
            
            const customizedElement = document.getElementById('customized-prompt');
            const originalElement = document.getElementById('original-prompt');
            
            if (hasUserInput) {
                // Only replace variables and show customized version if user has actual input
                customizedPrompt = replaceVariables(originalPrompt, variables);
                customizedElement.textContent = customizedPrompt;
                
                originalElement.style.display = 'none';
                customizedElement.style.display = 'block';
            } else {
                // Show original prompt with placeholders intact
                originalElement.style.display = 'block';
                customizedElement.style.display = 'none';
            }
        }

        function resetForm() {
            document.getElementById('paper_title').value = '';
            document.getElementById('author_names').value = '';
            document.getElementById('critique_depth').value = 'standard analysis';
            updatePreview();
        }

        // Add event listeners for real-time updates
        document.querySelectorAll('[data-variable]').forEach(input => {
            ['input', 'change'].forEach(eventType => {
                input.addEventListener(eventType, updatePreview);
            });
        });

        // Initialize
        updatePreview();
    </script>

    <script src="js/add-winer-links-and-header-links.js"></script>
</body>
</html>
