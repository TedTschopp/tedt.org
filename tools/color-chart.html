<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Chart</title>
    <link rel="stylesheet" href="/css/consolidated-fonts.css">
    <style>
        :root {
            /* Generic (browser-defined) default fonts */
            --swatch-font-family: sans-serif;
        }

        body {
            margin: 0;
            background-color: #f4f4f4;
            height: 100vh;
            overflow: hidden;
            font-family: sans-serif;
        }

        [data-color-chart] {
            font-family: var(--swatch-font-family);
        }

        #viewport {
            position: fixed;
            inset: 0;
            overflow: hidden;
            background: #f4f4f4;
            touch-action: none;
        }

        #world {
            position: absolute;
            left: 0;
            top: 0;
            transform-origin: 0 0;
            will-change: transform;
        }

        #controls {
            position: fixed;
            top: 14px;
            left: 14px;
            z-index: 10;
            display: grid;
            grid-template-columns: 44px 44px 44px;
            grid-auto-rows: 44px;
            gap: 8px;
            padding: 10px;
            box-sizing: border-box;
            width: calc(44px * 3 + 8px * 2 + 10px * 2);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.82);
            border: 1px solid rgba(0, 0, 0, 0.12);
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.10),
                0 2px 8px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        #controls button {
            appearance: none;
            border: 1px solid rgba(0, 0, 0, 0.14);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            line-height: 1;
            display: grid;
            place-items: center;
        }

        #controls button:hover {
            background: rgba(255, 255, 255, 1);
        }

        #controls button:active {
            transform: translateY(1px);
        }

        #controls button:focus-visible {
            outline: 3px solid rgba(0, 169, 224, 0.55);
            outline-offset: 2px;
        }

        #fontSelect {
            height: 44px;
            appearance: none;
            border: 1px solid rgba(0, 0, 0, 0.14);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 13px;
            font-weight: 650;
            padding: 0 12px;
            cursor: pointer;
            grid-column: 1 / -1;
            width: 100%;
            min-width: 0;
        }

        #fontSelect:focus-visible {
            outline: 3px solid rgba(0, 169, 224, 0.55);
            outline-offset: 2px;
        }

        #loadLocalFonts {
            height: 44px;
            appearance: none;
            border: 1px solid rgba(0, 0, 0, 0.14);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            font-size: 13px;
            font-weight: 650;
            padding: 0 12px;
            cursor: pointer;
            grid-column: 1 / -1;
            width: 100%;
            min-width: 0;
            display: grid;
            place-items: center;
        }

        #loadLocalFonts:hover {
            background: rgba(255, 255, 255, 1);
        }

        #loadLocalFonts:active {
            transform: translateY(1px);
        }

        #loadLocalFonts:disabled {
            cursor: not-allowed;
            opacity: 0.55;
        }

        #loadLocalFonts:focus-visible {
            outline: 3px solid rgba(0, 169, 224, 0.55);
            outline-offset: 2px;
        }

        #fontHint {
            grid-column: 1 / -1;
            font-size: 11px;
            line-height: 1.25;
            color: rgba(0, 0, 0, 0.72);
            margin-top: -2px;
        }

        #fontHint a {
            color: inherit;
        }


        #status {
            position: fixed;
            left: 14px;
            top: 260px;
            z-index: 10;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(16, 24, 32, 0.78);
            color: rgba(255, 255, 255, 0.92);
            font-size: 12px;
            letter-spacing: 0.2px;
            user-select: none;
        }

        #sr-help {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.2/tinycolor.min.js"></script>
</head>

<body>
    <div id="sr-help">
        Pan with the arrow buttons or drag. Zoom with plus/minus or mouse wheel.
    </div>

    <div id="viewport" aria-describedby="sr-help">
        <div id="world"></div>
    </div>

    <div id="controls" role="group" aria-label="Chart controls">
        <button id="zoomIn" type="button" aria-label="Zoom in">+</button>
        <button id="reset" type="button" aria-label="Reset view">⟲</button>
        <button id="zoomOut" type="button" aria-label="Zoom out">−</button>
        <button id="panLeft" type="button" aria-label="Pan left">←</button>
        <button id="panDown" type="button" aria-label="Pan down">↓</button>
        <button id="panRight" type="button" aria-label="Pan right">→</button>
        <button id="panUp" type="button" aria-label="Pan up">↑</button>
        <button id="panCenter" type="button" aria-label="Center chart">◎</button>
        <button id="toggleStatus" type="button" aria-label="Toggle status">i</button>
        <select id="fontSelect" aria-label="Swatch font"></select>
        <button id="loadLocalFonts" type="button">Load installed fonts</button>
        <div id="fontHint">
            Installed fonts require the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Local_Font_Access_API" target="_blank" rel="noreferrer">Local Font Access API</a> (permission + secure context).
        </div>
    </div>

    <div id="status" aria-live="polite"></div>
    <script>
        const viewportEl = document.getElementById('viewport');
        const worldEl = document.getElementById('world');
        const statusEl = document.getElementById('status');

        const fontSelectEl = document.getElementById('fontSelect');
        const loadLocalFontsBtnEl = document.getElementById('loadLocalFonts');
        const fontHintEl = document.getElementById('fontHint');

        const DEFAULT_SWATCH_FONT = 'sans-serif';
        const SWATCH_FONT_STORAGE_KEY = 'tedt_color_chart_swatch_font';

        const fontCatalog = [
            // Browser-generic defaults (defined by the user agent)
            { group: 'Default', label: 'Sans-serif', css: 'sans-serif' },
            { group: 'Default', label: 'Serif', css: 'serif' },
            { group: 'Default', label: 'Monospace', css: 'monospace' },
            { group: 'Default', label: 'Cursive', css: 'cursive' },
            { group: 'Default', label: 'Fantasy', css: 'fantasy' },
            { group: 'Default', label: 'System UI', css: 'system-ui' },
            { group: 'Default', label: 'UI Sans-serif', css: 'ui-sans-serif, sans-serif' },
            { group: 'Default', label: 'UI Serif', css: 'ui-serif, serif' },
            { group: 'Default', label: 'UI Monospace', css: 'ui-monospace, monospace' },

            // Google fonts (loaded via /css/consolidated-fonts.css)
            { group: 'Google Fonts', label: 'Cal Sans', css: '"Cal Sans", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Titillium Web', css: '"Titillium Web", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Inter', css: 'Inter, ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Inter Tight', css: '"Inter Tight", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Libre Franklin', css: '"Libre Franklin", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'IBM Plex Sans', css: '"IBM Plex Sans", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Space Grotesk', css: '"Space Grotesk", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Source Sans Pro', css: '"Source Sans Pro", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Merriweather Sans', css: '"Merriweather Sans", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Oswald', css: 'Oswald, ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Rajdhani', css: 'Rajdhani, ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Roboto', css: 'Roboto, ' + DEFAULT_SWATCH_FONT },

            { group: 'Google Fonts', label: 'Fira Code', css: '"Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace' },
            { group: 'Google Fonts', label: 'Share Tech Mono', css: '"Share Tech Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace' },
            { group: 'Google Fonts', label: 'Press Start 2P', css: '"Press Start 2P", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace' },

            { group: 'Google Fonts', label: 'Arsenal', css: 'Arsenal, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Cinzel', css: 'Cinzel, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Cinzel Decorative', css: '"Cinzel Decorative", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Cormorant Garamond', css: '"Cormorant Garamond", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'EB Garamond', css: '"EB Garamond", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Crimson Pro', css: '"Crimson Pro", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Libre Baskerville', css: '"Libre Baskerville", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Cardo', css: 'Cardo, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Quattrocento', css: 'Quattrocento, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Playfair Display', css: '"Playfair Display", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Old Standard TT', css: '"Old Standard TT", "Palatino", "Book Antiqua", Georgia, serif' },

            { group: 'Google Fonts', label: 'Spectral SC', css: '"Spectral SC", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'IM Fell DW Pica', css: '"IM Fell DW Pica", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'IM Fell English', css: '"IM Fell English", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Alice', css: 'Alice, "Palatino", "Book Antiqua", Georgia, serif' },

            { group: 'Google Fonts', label: 'MedievalSharp', css: 'MedievalSharp, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Limelight', css: 'Limelight, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Orbitron', css: 'Orbitron, ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Audiowide', css: 'Audiowide, ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Special Elite', css: '"Special Elite", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace' },
            { group: 'Google Fonts', label: 'Bangers', css: 'Bangers, ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Noto Sans Runic', css: '"Noto Sans Runic", ' + DEFAULT_SWATCH_FONT },

            { group: 'Google Fonts', label: 'Sofia Sans', css: '"Sofia Sans", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Sofia Sans Condensed', css: '"Sofia Sans Condensed", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Sofia Sans Semi Condensed', css: '"Sofia Sans Semi Condensed", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Sofia Sans Extra Condensed', css: '"Sofia Sans Extra Condensed", ' + DEFAULT_SWATCH_FONT },

            { group: 'Google Fonts', label: 'Architects Daughter', css: '"Architects Daughter", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Cedarville Cursive', css: '"Cedarville Cursive", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Fondamento', css: 'Fondamento, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Fredericka the Great', css: '"Fredericka the Great", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Lovers Quarrel', css: '"Lovers Quarrel", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Marcellus', css: 'Marcellus, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'Patrick Hand', css: '"Patrick Hand", ' + DEFAULT_SWATCH_FONT },
            { group: 'Google Fonts', label: 'Kalam', css: 'Kalam, ' + DEFAULT_SWATCH_FONT },

            { group: 'Google Fonts', label: 'UnifrakturCook', css: 'UnifrakturCook, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'Google Fonts', label: 'UnifrakturMaguntia', css: 'UnifrakturMaguntia, "Palatino", "Book Antiqua", Georgia, serif' },

            // Local / hosted fonts (loaded via /css/consolidated-fonts.css)
            { group: 'TedT.org', label: 'Optima', css: 'Optima, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Optima Titling', css: '"Optima Titling", Optima, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Manuka', css: 'Manuka, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'Manuka Condensed', css: 'ManukaCondensed, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'Manuka Slab', css: 'ManukaSlab, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'PalmPilot', css: 'PalmPilot, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace' },
            { group: 'TedT.org', label: 'Bestiary', css: 'Bestiary, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Shadowrun', css: 'Shadowrun, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'Checkbook', css: 'Checkbook, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'Dana Library Hand', css: '"Dana Library Hand", ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'Duvall', css: 'Duvall, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'GameEmpire', css: 'GameEmpire, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'IrwinAllen', css: 'IrwinAllen, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'lp1_regular', css: 'lp1_regular, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'lowwe', css: 'lowwe, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'UngerFrakturZierbuchstaben', css: 'UngerFrakturZierbuchstaben, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'CedarvilleCursive', css: 'CedarvilleCursive, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'coelnische_current_fraktur', css: 'coelnische_current_fraktur, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'strassburgfraktur', css: 'strassburgfraktur, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'SkennertonFraktur', css: 'SkennertonFraktur, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Hillal', css: 'Hillal, ' + DEFAULT_SWATCH_FONT },
            { group: 'TedT.org', label: 'AntiquarianScribe', css: 'AntiquarianScribe, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'TerraIgnota', css: 'TerraIgnota, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Quentin', css: 'Quentin, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Souvenir Demi', css: '"Souvenir Demi", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Egyptienne MN Condensed Bold', css: '"Egyptienne MN Condensed Bold", "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'Ringbearer', css: 'Ringbearer, "Palatino", "Book Antiqua", Georgia, serif' },
            { group: 'TedT.org', label: 'tschopp-housemark-optimum (icons)', css: '"tschopp-housemark-optimum", ' + DEFAULT_SWATCH_FONT },
        ];

        let localFontsLoaded = false;

        function supportsLocalFontAccessApi() {
            return ('queryLocalFonts' in window) && (window.isSecureContext || location.hostname === 'localhost');
        }

        function setLocalFontHint(text, isError = false) {
            if (!fontHintEl) return;
            fontHintEl.style.color = isError ? 'rgba(120, 0, 0, 0.78)' : 'rgba(0, 0, 0, 0.72)';
            fontHintEl.innerHTML = text;
        }

        function quoteFontFamily(fontFamily) {
            const safe = String(fontFamily || '').replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            return `"${safe}"`;
        }

        function applySwatchFont(fontCss) {
            const value = (fontCss && String(fontCss).trim().length > 0) ? fontCss : DEFAULT_SWATCH_FONT;
            document.documentElement.style.setProperty('--swatch-font-family', value);
            fontSelectEl.style.fontFamily = value;
        }

        function getOrCreateOptgroup(label) {
            const existing = Array.from(fontSelectEl.children).find(el => el.tagName === 'OPTGROUP' && el.label === label);
            if (existing) return existing;
            const optGroupEl = document.createElement('optgroup');
            optGroupEl.label = label;
            fontSelectEl.appendChild(optGroupEl);
            return optGroupEl;
        }

        async function tryLoadInstalledLocalFonts() {
            if (localFontsLoaded) return;
            localFontsLoaded = true;

            // Local Font Access API (Chromium-based browsers). Requires secure context + permission.
            if (!supportsLocalFontAccessApi()) {
                setLocalFontHint('Installed fonts unavailable here. Requires secure context + browser support.');
                return;
            }

            try {
                // If Permissions API is available, hint at permission state.
                try {
                    if (navigator.permissions && navigator.permissions.query) {
                        const result = await navigator.permissions.query({ name: 'local-fonts' });
                        if (result && result.state === 'denied') {
                            setLocalFontHint('Local font access is denied in this browser profile.', true);
                            return;
                        }
                    }
                } catch {
                    // Ignore permission query failures (not consistently implemented).
                }

                const localFonts = await window.queryLocalFonts();
                const families = Array.from(new Set(localFonts.map(f => f.family).filter(Boolean))).sort((a, b) => a.localeCompare(b));
                if (families.length === 0) return;

                const localGroup = getOrCreateOptgroup('Installed');
                const fragment = document.createDocumentFragment();

                for (const family of families) {
                    const optionEl = document.createElement('option');
                    optionEl.value = `${quoteFontFamily(family)}, ${DEFAULT_SWATCH_FONT}`;
                    optionEl.textContent = family;
                    fragment.appendChild(optionEl);
                }

                localGroup.appendChild(fragment);
                setLocalFontHint(`Loaded ${families.length} installed font families via Local Font Access API.`);
            } catch {
                // User denied or API error; keep dropdown usable.
                setLocalFontHint('Unable to load installed fonts (permission denied or unsupported).', true);
            }
        }

        function setupFontDropdown() {
            const groups = new Map();
            for (const font of fontCatalog) {
                if (!groups.has(font.group)) groups.set(font.group, []);
                groups.get(font.group).push(font);
            }

            // Alphabetize within each group by label.
            for (const [groupName, fonts] of groups.entries()) {
                fonts.sort((a, b) => String(a.label).localeCompare(String(b.label), undefined, { sensitivity: 'base' }));
                groups.set(groupName, fonts);
            }

            fontSelectEl.innerHTML = '';

            const preferredOrder = ['Default', 'Installed', 'TedT.org', 'Google Fonts'];
            const orderedGroups = [
                ...preferredOrder.filter(name => groups.has(name)),
                ...Array.from(groups.keys()).filter(name => !preferredOrder.includes(name)),
            ];

            for (const groupName of orderedGroups) {
                const fonts = groups.get(groupName) || [];
                const optGroupEl = document.createElement('optgroup');
                optGroupEl.label = groupName;

                fonts.forEach((font) => {
                    const optionEl = document.createElement('option');
                    optionEl.value = font.css;
                    optionEl.textContent = font.label;
                    optionEl.style.fontFamily = font.css;
                    optGroupEl.appendChild(optionEl);
                });

                fontSelectEl.appendChild(optGroupEl);
            }

            const saved = localStorage.getItem(SWATCH_FONT_STORAGE_KEY);
            const initialValue = (saved && saved.trim().length > 0) ? saved : DEFAULT_SWATCH_FONT;

            // If the saved value isn't in the list, fall back cleanly.
            const optionToSelect = Array.from(fontSelectEl.options).find(o => o.value === initialValue);
            if (optionToSelect) {
                fontSelectEl.value = initialValue;
            } else {
                fontSelectEl.value = DEFAULT_SWATCH_FONT;
            }

            applySwatchFont(fontSelectEl.value);

            fontSelectEl.addEventListener('change', () => {
                applySwatchFont(fontSelectEl.value);
                try {
                    localStorage.setItem(SWATCH_FONT_STORAGE_KEY, fontSelectEl.value);
                } catch {
                    // Ignore storage errors (private browsing, quota, etc.)
                }
            });

            // Populate installed fonts when supported, on a user gesture.
            fontSelectEl.addEventListener('pointerdown', () => {
                void tryLoadInstalledLocalFonts();
            }, { passive: true });

            if (loadLocalFontsBtnEl) {
                loadLocalFontsBtnEl.disabled = !supportsLocalFontAccessApi();
                loadLocalFontsBtnEl.addEventListener('click', () => {
                    void tryLoadInstalledLocalFonts();
                });
            }

            if (!supportsLocalFontAccessApi()) {
                setLocalFontHint('Installed fonts unavailable here. Requires Chromium + HTTPS and permission.');
            }
        }

        setupFontDropdown();

        const viewState = {
            x: 0,
            y: 0,
            scale: 1,
            minScale: 0.25,
            maxScale: 4,
            panStep: 120,
            showStatus: true,
        };

        function clamp(value, min, max) {
            return Math.min(max, Math.max(min, value));
        }

        function applyTransform() {
            worldEl.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})`;
            if (viewState.showStatus) {
                statusEl.textContent = `Zoom: ${Math.round(viewState.scale * 100)}%   Offset: ${Math.round(viewState.x)}, ${Math.round(viewState.y)}`;
                statusEl.style.display = 'block';
            } else {
                statusEl.style.display = 'none';
            }
        }

        function zoomAboutPoint(newScale, clientX, clientY) {
            const oldScale = viewState.scale;
            newScale = clamp(newScale, viewState.minScale, viewState.maxScale);
            if (newScale === oldScale) return;

            const worldX = (clientX - viewState.x) / oldScale;
            const worldY = (clientY - viewState.y) / oldScale;
            viewState.scale = newScale;
            viewState.x = clientX - worldX * newScale;
            viewState.y = clientY - worldY * newScale;
            applyTransform();
        }

        function centerChart() {
            // Center based on the chart container's intrinsic size.
            const chart = worldEl.querySelector('[data-color-chart]');
            if (!chart) return;
            const vw = viewportEl.clientWidth;
            const vh = viewportEl.clientHeight;
            const contentW = chart.scrollWidth;
            const contentH = chart.scrollHeight;
            viewState.x = Math.round((vw - contentW * viewState.scale) / 2);
            viewState.y = Math.round((vh - contentH * viewState.scale) / 2);
            applyTransform();
        }

        function resetView() {
            viewState.scale = 1;
            viewState.x = 0;
            viewState.y = 0;
            applyTransform();
            // If chart exists, center it.
            centerChart();
        }

        function panBy(dx, dy) {
            viewState.x += dx;
            viewState.y += dy;
            applyTransform();
        }

        // Buttons
        document.getElementById('zoomIn').addEventListener('click', () => {
            zoomAboutPoint(viewState.scale * 1.15, viewportEl.clientWidth / 2, viewportEl.clientHeight / 2);
        });
        document.getElementById('zoomOut').addEventListener('click', () => {
            zoomAboutPoint(viewState.scale / 1.15, viewportEl.clientWidth / 2, viewportEl.clientHeight / 2);
        });
        document.getElementById('reset').addEventListener('click', resetView);

        document.getElementById('panLeft').addEventListener('click', () => panBy(-viewState.panStep, 0));
        document.getElementById('panRight').addEventListener('click', () => panBy(viewState.panStep, 0));
        document.getElementById('panUp').addEventListener('click', () => panBy(0, -viewState.panStep));
        document.getElementById('panDown').addEventListener('click', () => panBy(0, viewState.panStep));
        document.getElementById('panCenter').addEventListener('click', centerChart);
        document.getElementById('toggleStatus').addEventListener('click', () => {
            viewState.showStatus = !viewState.showStatus;
            applyTransform();
        });

        // Drag to pan
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;

        viewportEl.addEventListener('pointerdown', (e) => {
            // Avoid stealing clicks from buttons.
            if (e.target && (e.target.closest && e.target.closest('#controls'))) return;
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            viewportEl.setPointerCapture(e.pointerId);
        });

        viewportEl.addEventListener('pointermove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - lastX;
            const dy = e.clientY - lastY;
            lastX = e.clientX;
            lastY = e.clientY;
            panBy(dx, dy);
        });

        viewportEl.addEventListener('pointerup', () => {
            isDragging = false;
        });
        viewportEl.addEventListener('pointercancel', () => {
            isDragging = false;
        });

        // Wheel to zoom (trackpad friendly)
        viewportEl.addEventListener('wheel', (e) => {
            // Let users scroll page if we ever stop using fixed fullscreen.
            e.preventDefault();
            const direction = e.deltaY > 0 ? -1 : 1;
            const factor = direction > 0 ? 1.12 : 1 / 1.12;
            zoomAboutPoint(viewState.scale * factor, e.clientX, e.clientY);
        }, { passive: false });

        // Keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT')) return;
            const step = e.shiftKey ? viewState.panStep * 2 : viewState.panStep;
            switch (e.key) {
                case 'ArrowLeft':
                    panBy(-step, 0);
                    break;
                case 'ArrowRight':
                    panBy(step, 0);
                    break;
                case 'ArrowUp':
                    panBy(0, -step);
                    break;
                case 'ArrowDown':
                    panBy(0, step);
                    break;
                case '+':
                case '=':
                    zoomAboutPoint(viewState.scale * 1.15, viewportEl.clientWidth / 2, viewportEl.clientHeight / 2);
                    break;
                case '-':
                case '_':
                    zoomAboutPoint(viewState.scale / 1.15, viewportEl.clientWidth / 2, viewportEl.clientHeight / 2);
                    break;
                case '0':
                    resetView();
                    break;
            }
        });

        window.addEventListener('resize', () => {
            // Keep the chart roughly centered on resize.
            centerChart();
        });

        function getUrlParameters() {
            const urlSearchParams = new URLSearchParams(window.location.search);
            let colorParameter = null;

            // Check for any form of the letter 'C' in the URL (case-insensitive)
            for (const [key, value] of urlSearchParams.entries()) {
                if (key.toLowerCase() === 'c') {
                    colorParameter = value;
                    break;
                }
            }

            if (colorParameter) {
                const decodedColorParameter = decodeURIComponent(colorParameter.trim().toLowerCase());
                if (decodedColorParameter === 'ted' || decodedColorParameter === 'teds') {
                    return [
                        { hex: '#b1b3b3' },
                        { hex: '#101820' },
                        { hex: '#00446f' },
                        { hex: '#e86027' },
                        { hex: '#00a9e0' },
                        { hex: '#007bff' },
                        { hex: '#f2bc57' },
                        { hex: '#6f1a07' },
                        { hex: '#00b339' },
                        { hex: '#f2bc57' },
                        { hex: '#f90041' },
                    ];
                }
                // Accept # and non-# hex colors, 3, 6, or 8 digits
                const hexColorArray = decodedColorParameter.split(',').map(color => {
                    color = color.trim();
                    // Add # if missing
                    if (!color.startsWith('#') && /^[0-9a-f]{3,8}$/i.test(color)) {
                        color = `#${color}`;
                    }
                    // Expand 3-digit hex to 6-digit
                    if (/^#[0-9a-f]{3}$/i.test(color)) {
                        color = '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
                    }
                    // Convert 8-digit hex to rgba()
                    if (/^#[0-9a-f]{8}$/i.test(color)) {
                        const r = parseInt(color.slice(1, 3), 16);
                        const g = parseInt(color.slice(3, 5), 16);
                        const b = parseInt(color.slice(5, 7), 16);
                        const a = parseInt(color.slice(7, 9), 16) / 255;
                        return { hex: color, rgba: `rgba(${r},${g},${b},${a.toFixed(2)})` };
                    }
                    return { hex: color };
                });
                // Validate all colors are either 6 or 8 digit hex
                if (hexColorArray.every(c => /^#[0-9a-f]{6}$/i.test(c.hex) || /^#[0-9a-f]{8}$/i.test(c.hex))) {
                    return hexColorArray;
                }
            }
            return null;
        }

        const colorDefinitions = (getUrlParameters() || [
            { hex: '#00664F' },
            { hex: '#FED141' },
            { hex: '#707372' },
            { hex: '#101820' },
            { hex: '#53565A' },
            { hex: '#B1B3B3' },
            { hex: '#006269' },
            { hex: '#00A9E0' },
            { hex: '#3CDBC0' },
            { hex: '#D2D755' },
            { hex: '#658D1B' },
            { hex: '#E87722' },
            { hex: '#F0B323' },
            { hex: '#722257' },
        ]).map(color => ({
            ...color,
            rgb: tinycolor(color.hex).toRgb(),
            hls: tinycolor(color.hex).toHsl(),
            cmyk: convertRgbToCmyk(tinycolor(color.hex).toRgb().r, tinycolor(color.hex).toRgb().g, tinycolor(color.hex).toRgb().b),
        }));

        const colorUsageDescriptions = [
            "Backgrounds and subtle highlights", // 50
            "Backgrounds and light accents",    // 100
            "Light accents and borders",        // 200
            "Secondary backgrounds",            // 300
            "Primary backgrounds",              // 400
            "Primary elements and text",        // 500
            "Hover states and active elements", // 600
            "Headers and strong accents",       // 700
            "Strong accents and warnings",      // 800
            "Critical elements and alerts",     // 900
            "Dark accents and overlays"         // 950
        ];

        function calculateContrastRatio(rgbColor1, rgbColor2) {
            function calculateLuminance(r, g, b) {
                const linearRgb = [r, g, b].map(value => {
                    value /= 255;
                    return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
                });
                return linearRgb[0] * 0.2126 + linearRgb[1] * 0.7152 + linearRgb[2] * 0.0722;
            }

            const luminance1 = calculateLuminance(...rgbColor1);
            const luminance2 = calculateLuminance(...rgbColor2);
            const brighterLuminance = Math.max(luminance1, luminance2);
            const darkerLuminance = Math.min(luminance1, luminance2);
            return ((brighterLuminance + 0.05) / (darkerLuminance + 0.05)).toFixed(2);
        }

        function convertRgbToCmyk(red, green, blue) {
            const cyan = 1 - red / 255;
            const magenta = 1 - green / 255;
            const yellow = 1 - blue / 255;
            const black = Math.min(cyan, magenta, yellow);
            return [
                ((cyan - black) / (1 - black) * 100).toFixed(0),
                ((magenta - black) / (1 - black) * 100).toFixed(0),
                ((yellow - black) / (1 - black) * 100).toFixed(0),
                (black * 100).toFixed(0),
            ];
        }

        async function fetchColorNameFromApi(hexColor) {
            const response = await fetch(`https://api.color.pizza/v1/${hexColor.substring(1)}`);
            const data = await response.json();
            return data.colors[0].name;
        }

        const colorShades = ['50', '100', '200', '300', '400', '500', '600', '700', '800', '900', '950'];

        async function generateColorChart() {
            const chartContainer = document.createElement('div');
            chartContainer.setAttribute('data-color-chart', 'true');
            chartContainer.style.display = 'grid';
            chartContainer.style.gridTemplateColumns = `repeat(${colorShades.length + 1}, 200px)`;
            chartContainer.style.gap = '8px';
            chartContainer.style.padding = '0';
            chartContainer.style.margin = '0';
            chartContainer.style.justifyContent = 'center';
            chartContainer.style.gridTemplateColumns = `repeat(${colorShades.length}, 200px)`;

            worldEl.appendChild(chartContainer);

            const headerRow = document.createElement('div');
            headerRow.style.display = 'grid';
            headerRow.style.gridTemplateColumns = `repeat(${colorShades.length}, 200px)`;
            headerRow.style.gap = '8px';
            headerRow.style.fontWeight = 'bold';
            headerRow.style.textAlign = 'center';

            colorShades.forEach((shade, index) => {
                const headerCell = document.createElement('div');
                headerCell.style.display = 'flex';
                headerCell.style.flexDirection = 'column';
                headerCell.style.alignItems = 'center';

                const usageDescription = document.createElement('div');
                usageDescription.textContent = colorUsageDescriptions[index];
                usageDescription.style.fontSize = '16pt';
                usageDescription.style.fontWeight = 'bold';
                usageDescription.style.textAlign = 'center';

                headerCell.appendChild(usageDescription);
                headerRow.appendChild(headerCell);
            });

            chartContainer.insertBefore(headerRow, chartContainer.firstChild);

            for (const color of colorDefinitions) {
                const baseRgb = tinycolor(color.hex).toRgb();
                const baseRgbArray = [baseRgb.r, baseRgb.g, baseRgb.b];
                const baseCmyk = convertRgbToCmyk(...baseRgbArray);
                const baseHls = tinycolor(color.hex).toHsl();
                const contrastWithWhite = calculateContrastRatio(baseRgbArray, [255, 255, 255]);
                const contrastWithBlack = calculateContrastRatio(baseRgbArray, [0, 0, 0]);
                const baseColorName = await fetchColorNameFromApi(color.hex);

                const shadeBoxes = colorShades.map(async (shade, index) => {
                    const colorBox = document.createElement('div');
                    const shadeColors = {
                        50: tinycolor(color.hex).clone().lighten(45).toHexString(),
                        100: tinycolor(color.hex).clone().lighten(40).toHexString(),
                        200: tinycolor(color.hex).clone().lighten(30).toHexString(),
                        300: tinycolor(color.hex).clone().lighten(20).toHexString(),
                        400: tinycolor(color.hex).clone().lighten(10).toHexString(),
                        500: tinycolor(color.hex).toHexString(),
                        600: tinycolor(color.hex).clone().darken(10).toHexString(),
                        700: tinycolor(color.hex).clone().darken(20).toHexString(),
                        800: tinycolor(color.hex).clone().darken(30).toHexString(),
                        900: tinycolor(color.hex).clone().darken(40).toHexString(),
                        950: tinycolor(color.hex).clone().darken(45).toHexString(),
                    };
                    colorBox.style.backgroundColor = shadeColors[shade];
                    colorBox.style.height = '150px';
                    colorBox.style.borderRadius = '8px';
                    colorBox.style.display = 'flex';
                    colorBox.style.flexDirection = 'column';
                    colorBox.style.alignItems = 'flex-start';
                    colorBox.style.justifyContent = 'flex-start';
                    colorBox.style.padding = '10px';
                    colorBox.style.fontSize = '12px';
                    colorBox.style.textAlign = 'left';
                    colorBox.style.position = 'relative';

                    if (shade === '500') {
                        colorBox.style.border = '4px solid black';
                    } else {
                        colorBox.style.border = '4px solid rgba(0, 0, 0, 0)';
                    }

                    const recalculatedRgb = tinycolor(shadeColors[shade]).toRgb();
                    const recalculatedRgbArray = [recalculatedRgb.r, recalculatedRgb.g, recalculatedRgb.b];
                    const dynamicColorName = await fetchColorNameFromApi(shadeColors[shade]);
                    const dynamicNameElement = document.createElement('div');
                    dynamicNameElement.textContent = `${dynamicColorName}`;
                    dynamicNameElement.style.fontWeight = 'bold';
                    dynamicNameElement.style.textDecoration = 'underline';
                    dynamicNameElement.style.fontSize = '12pt';
                    colorBox.appendChild(dynamicNameElement);

                    const baseColorNameElement = document.createElement('div');
                    if (shade === '500') {
                        baseColorNameElement.textContent = `Base Color`;
                    } else {
                        baseColorNameElement.textContent = `${baseColorName} ${shade}`;
                    }
                    baseColorNameElement.style.fontWeight = 'bold';
                    baseColorNameElement.style.fontSize = '10pt';
                    colorBox.appendChild(baseColorNameElement);

                    const hexElement = document.createElement('div');
                    hexElement.innerHTML = `<strong>Hex:</strong> ${shadeColors[shade].toUpperCase()}`;

                    const rgbElement = document.createElement('div');
                    rgbElement.innerHTML = `<strong>RGB:</strong> ${recalculatedRgbArray.join(', ')}`;

                    const cmykElement = document.createElement('div');
                    const recalculatedCmyk = convertRgbToCmyk(...recalculatedRgbArray).map(value => isNaN(value) ? 0 : value);
                    cmykElement.innerHTML = `<strong>CMYK:</strong> ${recalculatedCmyk.join(', ')}`;

                    const hlsElement = document.createElement('div');
                    const recalculatedHls = tinycolor(shadeColors[shade]).toHsl();
                    const recalculatedHlsArray = [
                        Math.round(recalculatedHls.h),
                        `${Math.round(recalculatedHls.s * 100)}%`,
                        `${Math.round(recalculatedHls.l * 100)}%`
                    ];
                    hlsElement.innerHTML = `<strong>HLS:</strong> ${recalculatedHlsArray.join(', ')}`;

                    colorBox.appendChild(hexElement);
                    colorBox.appendChild(rgbElement);
                    colorBox.appendChild(cmykElement);
                    colorBox.appendChild(hlsElement);

                    const contrastWithWhiteRatio = parseFloat(calculateContrastRatio(recalculatedRgbArray, [255, 255, 255]));
                    const contrastWithBlackRatio = parseFloat(calculateContrastRatio(recalculatedRgbArray, [0, 0, 0]));

                    if (contrastWithWhiteRatio > contrastWithBlackRatio) {
                        colorBox.style.color = '#ffffff';
                    } else if (contrastWithBlackRatio > contrastWithWhiteRatio) {
                        colorBox.style.color = '#000000';
                    } else {
                        colorBox.style.color = contrastWithWhiteRatio >= 4.5 ? '#ffffff' : '#000000';
                    }

                    const contrastWithWhiteElement = document.createElement('div');
                    contrastWithWhiteElement.innerHTML = `<strong>WCAG:White:</strong> ${contrastWithWhiteRatio}:1`;
                    colorBox.appendChild(contrastWithWhiteElement);

                    const contrastWithBlackElement = document.createElement('div');
                    contrastWithBlackElement.innerHTML = `<strong>WCAG:Black</strong> ${contrastWithBlackRatio}:1`;
                    colorBox.appendChild(contrastWithBlackElement);

                    const sampleTextElement = document.createElement('div');
                    sampleTextElement.textContent = 'Gg Aa Rr Qq Ss';
                    sampleTextElement.style.fontSize = '16pt';
                    sampleTextElement.style.fontWeight = 'bold';

                    colorBox.appendChild(sampleTextElement);

                    if (shade === '900') {
                        const lineBreak = document.createElement('div');
                        lineBreak.style.gridColumn = `span ${colorShades.length + 1}`;
                        chartContainer.appendChild(lineBreak);
                    }

                    return colorBox;
                });

                const colorBoxes = await Promise.all(shadeBoxes);
                colorBoxes.forEach(box => chartContainer.appendChild(box));
            }

            // Chart container already attached to world.

            // Initial view: center the generated chart.
            centerChart();
        }

        applyTransform();
        generateColorChart().then(() => {
            // Center and ensure status is correct once layout is ready.
            requestAnimationFrame(() => {
                centerChart();
                applyTransform();
            });
        });
    </script>
</body>

</html>